<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>배움 원정대</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font -->
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom styles for an adventure-game feel */
        .card-container {
            background-image: linear-gradient(135deg, #2b3956 0%, #1a233b 100%);
        }

        .btn-primary {
            background-image: linear-gradient(to right, #4ade80, #16a34a);
        }

        .btn-secondary {
            background-color: #3b82f6;
        }

        /* Progress Bar */
        .progress-container {
            height: 1.5rem;
            background-color: #4a5568;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            transition: width 0.5s ease-in-out;
            background-image: linear-gradient(to right, #6ee7b7, #34d399);
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container -->
    <div id="app-container" class="card-container rounded-3xl shadow-2xl p-8 max-w-lg w-full">

        <!-- Logo/Title -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold tracking-tight text-white mb-2">배움 원정대</h1>
            <p class="text-lg text-gray-400">배움의 모험에 오신 것을 환영합니다!</p>
        </div>

        <!-- Dynamic Content Views -->
        <div id="views-container">

            <!-- 1. Landing View (Initial screen with 3 buttons) -->
            <div id="landing-view" class="view hidden">
                <div class="space-y-4">
                    <button id="show-student-login-btn"
                        class="w-full p-4 rounded-lg text-white font-semibold shadow-md btn-primary text-lg">학생 로그인</button>
                    <button id="show-register-btn"
                        class="w-full p-4 rounded-lg text-white font-semibold shadow-md btn-secondary text-lg">학생 회원가입</button>
                    <button id="show-teacher-login-btn"
                        class="w-full p-4 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors text-lg">교사 로그인</button>
                </div>
            </div>

            <!-- 2. Student Login View -->
            <div id="student-login-view" class="view hidden">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-semibold mb-4">학생 로그인</h2>
                </div>
                <form id="login-form" class="space-y-4">
                    <div>
                        <input type="text" id="student-id-input" placeholder="아이디"
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="password" id="student-password-input" placeholder="비밀번호"
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <button type="submit"
                        class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">로그인</button>
                    <button type="button" id="back-to-landing-from-login"
                        class="w-full mt-4 p-3 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors">뒤로가기</button>
                </form>
            </div>

            <!-- 3. Registration View -->
            <div id="register-view" class="view hidden">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-semibold mb-4">회원가입</h2>
                </div>
                <form id="register-form" class="space-y-4">
                    <div>
                        <input type="number" id="register-grade" placeholder="학년" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="number" id="register-class" placeholder="반" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="number" id="register-number" placeholder="번호" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="text" id="register-name" placeholder="이름" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="text" id="register-id" placeholder="아이디 (중복 불가)" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="password" id="register-password" placeholder="비밀번호 (4자 이상)" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="text" id="register-char-name" placeholder="캐릭터 이름" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <button type="submit"
                        class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">가입 신청</button>
                    <button type="button" id="back-to-landing-from-register"
                        class="w-full mt-4 p-3 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors">뒤로가기</button>
                </form>
            </div>

            <!-- 4. Teacher Login View -->
            <div id="teacher-login-view" class="view hidden">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-semibold mb-4">교사 로그인</h2>
                </div>
                <form id="teacher-login-form" class="space-y-4">
                    <div>
                        <input type="password" id="teacher-code-input" placeholder="교사 코드" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <button type="submit"
                        class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">로그인</button>
                    <button type="button" id="back-to-landing-from-teacher"
                        class="w-full mt-4 p-3 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors">뒤로가기</button>
                </form>
            </div>

            <!-- 5. Student Dashboard View -->
            <div id="student-dashboard-view" class="view hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">학생 대시보드</h2>
                    <button id="logout-btn"
                        class="px-4 py-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-red-500 hover:text-white transition-colors">로그아웃</button>
                </div>

                <!-- Tabs -->
                <div class="flex justify-around mb-6 text-sm md:text-base">
                    <button id="tab-info"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 font-semibold border-emerald-400 text-emerald-400">정보</button>
                    <button id="tab-quest"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 border-transparent text-gray-400 hover:text-white">퀘스트</button>
                    <button id="tab-log"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 border-transparent text-gray-400 hover:text-white">성장일지</button>
                    <button id="tab-shop"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 border-transparent text-gray-400 hover:text-white">상점</button>
                </div>

                <!-- Tab Sections -->
                <div id="dashboard-sections">
                    <!-- 5.1. User Info Section -->
                    <div id="user-info-section" class="space-y-6">
                        <!-- User Info Card -->
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <div class="flex items-center space-x-4 mb-4">
                                <i class="fa-solid fa-user-circle text-4xl text-emerald-400"></i>
                                <div class="flex-1">
                                    <h3 id="char-name-display" class="text-2xl font-bold"></h3>
                                    <p class="text-gray-400 text-sm">유저 ID: <span id="user-id-display"
                                            class="text-xs break-words"></span></p>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <!-- Level & EXP -->
                                <div class="space-y-1">
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="font-semibold">레벨: <span id="level-display"></span></span>
                                        <span id="exp-text-display" class="text-sm text-gray-400"></span>
                                    </div>
                                    <div class="progress-container">
                                        <div id="exp-bar" class="progress-bar"></div>
                                    </div>
                                </div>
                                <!-- Diamonds -->
                                <div class="flex items-center space-x-2">
                                    <i class="fa-solid fa-gem text-blue-400 text-xl"></i>
                                    <span class="font-semibold">다이아: <span id="diamond-display"></span></span>
                                </div>
                                <!-- Growth Points -->
                                <div class="flex items-center space-x-2">
                                    <i class="fa-solid fa-star text-yellow-400 text-xl"></i>
                                    <span class="font-semibold">성장 포인트: <span id="growth-point-display"></span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Card -->
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4">능력치</h3>
                            <div id="stats-container" class="space-y-3">
                                <!-- Stats will be rendered here dynamically -->
                            </div>
                            <button id="save-stats-btn"
                                class="w-full p-3 mt-6 rounded-lg text-white font-semibold shadow-md bg-green-500 hover:bg-green-600 transition-colors">변경사항
                                저장</button>
                        </div>
                    </div>

                    <!-- 5.2. Quest Section -->
                    <div id="quest-section" class="space-y-6 hidden">
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-scroll text-yellow-400"></i>
                                <span>오늘의 퀘스트</span>
                            </h3>
                            <div id="daily-quest-container">
                                <p class="text-gray-400 mb-4">새로운 퀘스트를 기다리는 중...</p>
                            </div>
                        </div>
                    </div>

                    <!-- 5.3. Growth Log Section -->
                    <div id="log-section" class="space-y-6 hidden">
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-clipboard-list text-purple-400"></i>
                                <span>성장일지 기록</span>
                            </h3>
                            <form id="growth-log-form" class="space-y-4">
                                <textarea id="growth-log-text" rows="5"
                                    class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-400 text-white"
                                    placeholder="오늘 배운 점이나 느낀 점을 기록해 보세요."></textarea>
                                <button type="submit"
                                    class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">기록 전송</button>
                            </form>
                            <div id="growth-log-status" class="mt-4 p-4 rounded-lg text-center font-semibold hidden"></div>
                        </div>

                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-history text-gray-400"></i>
                                <span>나의 성장 기록</span>
                            </h3>
                            <div id="growth-log-container" class="space-y-4">
                                <!-- Growth log entries will be rendered here dynamically -->
                                <p class="text-gray-400">성장 기록이 없습니다. 모험을 시작해 보세요!</p>
                            </div>
                        </div>
                    </div>

                    <!-- 5.4. Shop Section -->
                    <div id="shop-section" class="space-y-6 hidden">
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-shop text-red-400"></i>
                                <span>상점</span>
                            </h3>
                            <p class="text-gray-400">이곳에 상점 아이템 목록이 표시됩니다.</p>
                        </div>
                    </div>

                </div>
            </div>

            <!-- 6. Teacher Dashboard View -->
            <div id="teacher-dashboard-view" class="view hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">교사 대시보드</h2>
                    <button id="teacher-logout-btn"
                        class="px-4 py-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-red-500 hover:text-white transition-colors">로그아웃</button>
                </div>
                <!-- Tabs -->
                <div class="flex justify-around mb-6 text-sm md:text-base">
                    <button id="teacher-tab-pending-students"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 font-semibold border-emerald-400 text-emerald-400">학생
                        승인</button>
                    <button id="teacher-tab-pending-logs"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 border-transparent text-gray-400 hover:text-white">성장일지
                        승인</button>
                </div>

                <!-- Teacher Tab Sections -->
                <div id="teacher-dashboard-sections">
                    <div id="teacher-pending-students-section">
                        <h3 class="text-xl font-semibold mb-4">미승인 학생 목록</h3>
                        <div id="pending-students-list" class="space-y-4">
                            <!-- Pending student list will be rendered here dynamically -->
                            <p class="text-gray-400 text-center" id="no-pending-students">미승인 학생이 없습니다.</p>
                        </div>
                    </div>
                    <div id="teacher-pending-logs-section" class="hidden">
                        <h3 class="text-xl font-semibold mb-4">미승인 성장일지</h3>
                        <div id="pending-growth-logs-list" class="space-y-4">
                            <!-- Pending growth logs will be rendered here dynamically -->
                            <p class="text-gray-400 text-center">미승인 성장일지가 없습니다.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loading-spinner" class="hidden flex flex-col items-center justify-center p-8">
                <i class="fas fa-spinner fa-spin text-5xl text-emerald-400 mb-4"></i>
                <p class="text-xl text-gray-400 font-semibold">데이터를 불러오는 중...</p>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="message-modal-overlay"
        class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay transition-opacity duration-300">
        <div
            class="bg-gray-800 p-8 rounded-3xl shadow-2xl max-w-sm w-full transform scale-95 transition-transform duration-300">
            <h3 id="modal-title" class="text-xl font-semibold mb-4 text-white"></h3>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <button id="modal-close-btn"
                class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">확인</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, setLogLevel, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Constants from the execution environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'Learning_Explorer';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBx1gV8tiS2e83pWkDx0Y8p3Uou5z2ZwgU",
            authDomain: "learning-explorers.firebaseapp.com",
            projectId: "learning-explorers",
            storageBucket: "learning-explorers.firebasestorage.app",
            messagingSenderId: "836826026401",
            appId: "1:836826026401:web:9d4e237cb888e478227be0",
            measurementId: "G-BNMVYB2XNJ"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase instances
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let studentDataCache = null;

        // UI element references
        const views = {
            landing: document.getElementById('landing-view'),
            studentLogin: document.getElementById('student-login-view'),
            register: document.getElementById('register-view'),
            teacherLogin: document.getElementById('teacher-login-view'),
            dashboard: document.getElementById('student-dashboard-view'),
            teacherDashboard: document.getElementById('teacher-dashboard-view'),
        };
        const showStudentLoginBtn = document.getElementById('show-student-login-btn');
        const showRegisterBtn = document.getElementById('show-register-btn');
        const showTeacherLoginBtn = document.getElementById('show-teacher-login-btn');
        const backToLandingFromLoginBtn = document.getElementById('back-to-landing-from-login');
        const backToLandingFromRegisterBtn = document.getElementById('back-to-landing-from-register');
        const backToLandingFromTeacherBtn = document.getElementById('back-to-landing-from-teacher');

        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const teacherLoginForm = document.getElementById('teacher-login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const teacherLogoutBtn = document.getElementById('teacher-logout-btn');
        const saveStatsBtn = document.getElementById('save-stats-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const messageModalOverlay = document.getElementById('message-modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // Tab buttons (Student)
        const tabInfoBtn = document.getElementById('tab-info');
        const tabQuestBtn = document.getElementById('tab-quest');
        const tabLogBtn = document.getElementById('tab-log');
        const tabShopBtn = document.getElementById('tab-shop');

        // Tab buttons (Teacher)
        const teacherTabPendingStudentsBtn = document.getElementById('teacher-tab-pending-students');
        const teacherTabPendingLogsBtn = document.getElementById('teacher-tab-pending-logs');

        // Sections
        const userInfoSection = document.getElementById('user-info-section');
        const questSection = document.getElementById('quest-section');
        const logSection = document.getElementById('log-section');
        const shopSection = document.getElementById('shop-section');
        const teacherPendingStudentsSection = document.getElementById('teacher-pending-students-section');
        const teacherPendingLogsSection = document.getElementById('teacher-pending-logs-section');

        // Initial stat values for new students
        const initialStats = {
            level: 1,
            exp: 0,
            diamonds: 0,
            growth_points: 0,
            stamina: 5,
            attack: 5,
            defense: 5,
            luck: 5,
            equipped: {
                title: "없음",
                weapon: "없음",
                armor: "없음",
                hat: "없음",
                accessory: "없음",
                relic: "없음",
                skill: "없음"
            }
        };

        // --- Core Functions ---

        /**
         * 특정 뷰를 표시하고 다른 모든 뷰는 숨깁니다.
         * @param {string} viewName - 표시할 뷰의 이름.
         */
        function showView(viewName) {
            loadingSpinner.classList.add('hidden');
            for (const key in views) {
                if (key === viewName) {
                    views[key].classList.remove('hidden');
                } else {
                    views[key].classList.add('hidden');
                }
            }
        }

        /**
         * 커스텀 모달 메시지를 표시합니다.
         * @param {string} title - 모달 제목.
         * @param {string} message - 표시할 메시지.
         */
        function showMessageModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModalOverlay.classList.remove('hidden');
        }

        /**
         * Firebase를 초기화하고 사용자를 인증합니다.
         */
        async function initFirebase() {
            try {
                setLogLevel('debug'); // Firestore 디버그 로깅 활성화
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 제공된 커스텀 토큰 또는 익명으로 인증
                await signInWithCustomToken(auth, initialAuthToken || 'anonymous-token').catch(() => signInAnonymously(auth));

                userId = auth.currentUser.uid;
                isAuthReady = true;

                console.log('Firebase initialized. User ID:', userId);

                // 첫 화면으로 시작
                showView('landing');
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessageModal('오류', '데이터베이스 연결에 실패했습니다. 나중에 다시 시도해주세요.');
            }
        }

        // --- Data Handling ---

        /**
         * Firestore의 실시간 데이터로 학생 대시보드를 렌더링합니다.
         */
        function renderStudentDashboard() {
            if (!userId) return;

            showView('loading'); // 데이터를 가져오는 동안 스피너 표시
            const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);

            // onSnapshot을 사용하여 실시간 업데이트
            onSnapshot(studentDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    showView('dashboard'); // 데이터 로드 후 대시보드 표시
                    studentDataCache = docSnap.data();

                    // 협업/공유를 위해 사용자 ID 표시
                    document.getElementById('user-id-display').textContent = userId;

                    // 학생 데이터로 UI 업데이트
                    document.getElementById('char-name-display').textContent = studentDataCache.character_name;
                    document.getElementById('level-display').textContent = studentDataCache.level;
                    document.getElementById('diamond-display').textContent = studentDataCache.diamonds;
                    document.getElementById('growth-point-display').textContent = studentDataCache.growth_points;

                    // EXP 바 업데이트
                    const expToNextLevel = 200; // Example: 200 exp per level
                    const expPercentage = (studentDataCache.exp / expToNextLevel) * 100;
                    document.getElementById('exp-bar').style.width = `${Math.min(expPercentage, 100)}%`;
                    document.getElementById('exp-text-display').textContent = `${studentDataCache.exp}/${expToNextLevel}`;

                    // 레벨업 로직 (경험치가 충분하면 레벨업)
                    if (studentDataCache.exp >= expToNextLevel) {
                        const newLevel = studentDataCache.level + 1;
                        const newExp = studentDataCache.exp - expToNextLevel;
                        const newGrowthPoints = studentDataCache.growth_points + 5; // 레벨업 보상

                        updateDoc(studentDocRef, {
                            level: newLevel,
                            exp: newExp,
                            growth_points: newGrowthPoints
                        }).then(() => {
                            showMessageModal('레벨업!', `축하합니다! 레벨 ${newLevel}이 되었습니다! 성장 포인트 5점을 얻었습니다.`);
                            logEvent('level_up', {
                                newLevel: newLevel
                            });
                        }).catch(error => {
                            console.error("Level up failed:", error);
                        });
                    }

                    // 동적 능력치 렌더링
                    const statsContainer = document.getElementById('stats-container');
                    statsContainer.innerHTML = ''; // 이전 능력치 지우기
                    const stats = ['stamina', 'attack', 'defense', 'luck'];
                    stats.forEach(stat => {
                        const statElement = document.createElement('div');
                        statElement.className = 'flex items-center justify-between';
                        statElement.innerHTML = `
                            <span class="text-gray-300 font-semibold capitalize">${stat}</span>
                            <div class="flex items-center space-x-2">
                                <span id="${stat}-display" class="text-emerald-400 font-bold text-lg">${studentDataCache[stat]}</span>
                                <button data-stat="${stat}" class="stat-plus-btn bg-gray-600 w-8 h-8 rounded-full text-white font-bold text-sm hover:bg-emerald-400 transition-colors">+</button>
                            </div>
                        `;
                        statsContainer.appendChild(statElement);
                    });

                    // 새 능력치 + 버튼에 이벤트 리스너 추가
                    document.querySelectorAll('.stat-plus-btn').forEach(button => {
                        button.addEventListener('click', handleStatIncrease);
                    });

                    // 퀘스트 상태 렌더링
                    renderQuest(studentDataCache);
                    // 성장일지 제출 양식 및 상태 렌더링
                    renderGrowthLogSubmissionForm(studentDataCache);
                    // 성장일지 기록 렌더링
                    renderGrowthLog();

                } else {
                    // 사용자 문서가 없으면 로그아웃
                    console.error("Student data not found for user ID:", userId);
                    showMessageModal('오류', '학생 데이터를 찾을 수 없습니다. 다시 로그인해주세요.');
                    auth.signOut();
                    showView('landing');
                }
            }, (error) => {
                console.error("Failed to fetch student data:", error);
                showMessageModal('오류', '데이터를 불러오는 중 오류가 발생했습니다.');
                auth.signOut();
                showView('landing');
            });
        }

        /**
         * Firestore의 실시간 데이터로 교사 대시보드를 렌더링합니다.
         */
        async function renderTeacherDashboard() {
            showView('loading');

            // 학생 승인 탭 내용 렌더링
            const pendingListContainer = document.getElementById('pending-students-list');
            const registerRef = collection(db, `artifacts/${appId}/public/data/register`);
            const qStudents = query(registerRef, where("status", "==", "대기중"));
            onSnapshot(qStudents, (snapshot) => {
                pendingListContainer.innerHTML = '';
                if (snapshot.empty) {
                    pendingListContainer.innerHTML = '<p class="text-gray-400 text-center">미승인 학생이 없습니다.</p>';
                } else {
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const docId = doc.id;
                        const card = document.createElement('div');
                        card.className = 'bg-gray-800 rounded-2xl p-4 shadow-md flex items-center justify-between';
                        card.innerHTML = `
                            <div>
                                <h4 class="text-lg font-semibold">${data.name} (${data.id})</h4>
                                <p class="text-gray-400 text-sm">학년: ${data.grade}반: ${data.class} 번호: ${data.number}</p>
                            </div>
                            <button data-id="${docId}" class="approve-btn px-4 py-2 rounded-lg text-white font-semibold bg-green-500 hover:bg-green-600 transition-colors">승인</button>
                        `;
                        pendingListContainer.appendChild(card);
                    });
                    document.querySelectorAll('.approve-btn').forEach(btn => {
                        btn.addEventListener('click', handleApproveRequest);
                    });
                }
            });

            // 성장일지 승인 탭 내용 렌더링
            const pendingLogsContainer = document.getElementById('pending-growth-logs-list');
            const logsRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);
            const qLogs = query(logsRef, where("status", "==", "pending"));
            onSnapshot(qLogs, (snapshot) => {
                pendingLogsContainer.innerHTML = '';
                if (snapshot.empty) {
                    pendingLogsContainer.innerHTML = '<p class="text-gray-400 text-center">미승인 성장일지가 없습니다.</p>';
                } else {
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const docId = doc.id;
                        const card = document.createElement('div');
                        card.className = 'bg-gray-800 rounded-2xl p-4 shadow-md space-y-3';
                        card.innerHTML = `
                            <div class="flex items-center justify-between">
                                <h4 class="text-lg font-semibold">${data.student_name}님의 일지</h4>
                                <p class="text-sm text-gray-400">${new Date(data.timestamp.toDate()).toLocaleDateString()}</p>
                            </div>
                            <p class="text-gray-300 text-sm overflow-hidden whitespace-nowrap overflow-ellipsis">${data.content}</p>
                            <div class="flex justify-end space-x-2">
                                <button data-id="${docId}" data-student-id="${data.student_id}" class="approve-log-btn px-4 py-2 rounded-lg text-white font-semibold bg-green-500 hover:bg-green-600 transition-colors">승인</button>
                                <button data-id="${docId}" data-student-id="${data.student_id}" class="reject-log-btn px-4 py-2 rounded-lg text-white font-semibold bg-red-500 hover:bg-red-600 transition-colors">거절</button>
                            </div>
                        `;
                        pendingLogsContainer.appendChild(card);
                    });
                    document.querySelectorAll('.approve-log-btn').forEach(btn => {
                        btn.addEventListener('click', handleGrowthLogApproval);
                    });
                    document.querySelectorAll('.reject-log-btn').forEach(btn => {
                        btn.addEventListener('click', handleGrowthLogRejection);
                    });
                }
            });

            showView('teacherDashboard');
        }

        /**
         * 학생의 일일 퀘스트 상태를 렌더링하고 관리합니다.
         * @param {Object} studentData - Firestore에서 가져온 학생 데이터.
         */
        function renderQuest(studentData) {
            const questContainer = document.getElementById('daily-quest-container');
            const dailyQuestId = 'daily_diary_quest';
            const questCompletedDate = studentData.quests?.[dailyQuestId]?.completed_at;
            const today = new Date().toISOString().split('T')[0];

            questContainer.innerHTML = ''; // 기존 콘텐츠 삭제

            const isCompletedToday = questCompletedDate && questCompletedDate.startsWith(today);

            if (isCompletedToday) {
                const card = document.createElement('div');
                card.className = 'bg-gray-700 rounded-lg p-4 flex items-center justify-between';
                card.innerHTML = `
                    <div>
                        <h4 class="text-lg font-semibold text-gray-300">오늘의 일기 쓰기</h4>
                        <p class="text-sm text-emerald-400">퀘스트 완료!</p>
                    </div>
                    <i class="fa-solid fa-check-circle text-2xl text-emerald-400"></i>
                `;
                questContainer.appendChild(card);
            } else {
                const card = document.createElement('div');
                card.className = 'bg-gray-700 rounded-lg p-4 space-y-4';
                card.innerHTML = `
                    <h4 class="text-lg font-semibold text-white">오늘의 일기 쓰기</h4>
                    <p class="text-gray-300">오늘 있었던 일을 간단히 기록해 보세요. 경험치 +50, 성장 포인트 +1</p>
                    <button id="complete-quest-btn" class="w-full p-2 rounded-lg text-white font-semibold btn-primary">퀘스트 완료</button>
                `;
                questContainer.appendChild(card);
                document.getElementById('complete-quest-btn').addEventListener('click', handleQuestCompletion);
            }
        }

        /**
         * 학생의 성장일지 제출 양식과 현재 상태를 렌더링합니다.
         * @param {Object} studentData - 학생 데이터.
         */
        function renderGrowthLogSubmissionForm(studentData) {
            const statusContainer = document.getElementById('growth-log-status');
            const submissionForm = document.getElementById('growth-log-form');
            const latestLogId = studentData.latest_log;

            if (latestLogId) {
                const logDocRef = doc(db, `artifacts/${appId}/public/data/growth_logs`, latestLogId);
                onSnapshot(logDocRef, (logSnap) => {
                    if (logSnap.exists()) {
                        const logData = logSnap.data();
                        submissionForm.classList.add('hidden');
                        statusContainer.classList.remove('hidden');

                        if (logData.status === 'pending') {
                            statusContainer.innerHTML = `<i class="fa-solid fa-hourglass-half text-yellow-400 mr-2"></i>승인 대기 중...`;
                            statusContainer.className = 'mt-4 p-4 rounded-lg text-center font-semibold bg-yellow-900 text-yellow-300';
                        } else if (logData.status === 'approved') {
                            statusContainer.innerHTML = `<i class="fa-solid fa-check-circle text-emerald-400 mr-2"></i>성장일지 승인 완료!`;
                            statusContainer.className = 'mt-4 p-4 rounded-lg text-center font-semibold bg-emerald-900 text-emerald-300';
                        } else if (logData.status === 'rejected') {
                            statusContainer.innerHTML = `<i class="fa-solid fa-times-circle text-red-400 mr-2"></i>성장일지 거절됨. 다시 작성해 보세요.`;
                            statusContainer.className = 'mt-4 p-4 rounded-lg text-center font-semibold bg-red-900 text-red-300';
                            submissionForm.classList.remove('hidden');
                        }
                    } else {
                        // 로그 문서가 삭제된 경우, 폼을 다시 표시
                        submissionForm.classList.remove('hidden');
                        statusContainer.classList.add('hidden');
                    }
                });
            } else {
                submissionForm.classList.remove('hidden');
                statusContainer.classList.add('hidden');
            }
        }

        /**
         * 학생의 성장일지 기록을 렌더링합니다.
         */
        function renderGrowthLog() {
            const logContainer = document.getElementById('growth-log-container');
            const logCollectionRef = collection(db, `artifacts/${appId}/public/data/students/${userId}/log`);
            const q = query(logCollectionRef, orderBy('timestamp', 'desc'), limit(50));

            onSnapshot(q, (snapshot) => {
                logContainer.innerHTML = '';
                if (snapshot.empty) {
                    logContainer.innerHTML = '<p class="text-gray-400">성장 기록이 없습니다. 모험을 시작해 보세요!</p>';
                } else {
                    snapshot.forEach(doc => {
                        const logData = doc.data();
                        const logEntry = document.createElement('div');
                        logEntry.className = 'bg-gray-700 rounded-lg p-3 shadow-sm';

                        // Check if timestamp is a valid number before creating a Date object
                        const timestamp = logData.timestamp?.toMillis ? logData.timestamp.toMillis() : logData.timestamp;
                        if (!timestamp) return;

                        const date = new Date(timestamp);
                        const formattedTime = date.toLocaleTimeString('ko-KR', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const formattedDate = date.toLocaleDateString('ko-KR');

                        let iconClass = '';
                        let message = '';
                        let colorClass = 'text-gray-300';

                        switch (logData.event_type) {
                            case 'quest_complete':
                                iconClass = 'fa-solid fa-scroll';
                                message = `퀘스트 "${logData.details.quest_name}"을 완료하고 경험치 ${logData.details.exp_gain}과 성장 포인트 ${logData.details.growth_point_gain}을(를) 얻었습니다.`;
                                colorClass = 'text-emerald-400';
                                break;
                            case 'stat_increase':
                                iconClass = 'fa-solid fa-arrow-up';
                                message = `${logData.details.stat_name} 능력치가 ${logData.details.new_value} (으)로 상승했습니다.`;
                                colorClass = 'text-blue-400';
                                break;
                            case 'level_up':
                                iconClass = 'fa-solid fa-star';
                                message = `축하합니다! 레벨 ${logData.details.newLevel}이(가) 되었습니다!`;
                                colorClass = 'text-yellow-400';
                                break;
                            case 'growth_log_approved':
                                iconClass = 'fa-solid fa-clipboard-check';
                                message = `성장일지가 승인되어 경험치 50, 성장 포인트 1을(를) 얻었습니다.`;
                                colorClass = 'text-purple-400';
                                break;
                            case 'growth_log_rejected':
                                iconClass = 'fa-solid fa-clipboard-xmark';
                                message = `성장일지가 거절되어 경험치 20을(를) 얻었습니다.`;
                                colorClass = 'text-red-400';
                                break;
                            default:
                                iconClass = 'fa-solid fa-info-circle';
                                message = logData.message;
                        }

                        logEntry.innerHTML = `
                            <div class="flex items-center space-x-2">
                                <i class="${iconClass} text-lg ${colorClass}"></i>
                                <p class="text-sm ${colorClass}">${message}</p>
                            </div>
                            <p class="text-right text-xs text-gray-400">${formattedDate} ${formattedTime}</p>
                        `;
                        logContainer.appendChild(logEntry);
                    });
                }
            }, (error) => {
                console.error("Failed to fetch growth log:", error);
                logContainer.innerHTML = '<p class="text-red-400">성장 기록을 불러오는 중 오류가 발생했습니다.</p>';
            });
        }

        /**
         * 학생의 성장일지에 이벤트를 기록합니다.
         * @param {string} eventType - 이벤트 유형. 예: 'quest_complete', 'level_up'
         * @param {object} details - 이벤트 상세 정보.
         */
        async function logEvent(eventType, details) {
            if (!userId) return;
            try {
                const logCollectionRef = collection(db, `artifacts/${appId}/public/data/students/${userId}/log`);
                await addDoc(logCollectionRef, {
                    event_type: eventType,
                    details: details,
                    timestamp: serverTimestamp() // Use serverTimestamp for accuracy
                });
            } catch (error) {
                console.error("Failed to log event:", error);
            }
        }

        /**
         * 퀘스트 완료 버튼 클릭 이벤트를 처리하고 보상을 지급합니다.
         */
        async function handleQuestCompletion() {
            const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);
            const docSnap = await getDoc(studentDocRef);

            if (!docSnap.exists()) {
                showMessageModal('오류', '사용자 데이터를 찾을 수 없습니다.');
                return;
            }

            const studentData = docSnap.data();
            const dailyQuestId = 'daily_diary_quest';
            const questCompletedAt = studentData.quests?.[dailyQuestId]?.completed_at?.toDate();
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            if (questCompletedAt && questCompletedAt >= today) {
                showMessageModal('퀘스트 완료', '오늘의 퀘스트는 이미 완료했습니다.');
                return;
            }

            const expGain = 50;
            const growthPointGain = 1;
            const newExp = (studentData.exp || 0) + expGain;
            const newGrowthPoints = (studentData.growth_points || 0) + growthPointGain;

            try {
                await updateDoc(studentDocRef, {
                    exp: newExp,
                    growth_points: newGrowthPoints,
                    [`quests.${dailyQuestId}.completed_at`]: serverTimestamp()
                });
                showMessageModal('퀘스트 성공', '오늘의 퀘스트를 완료하고 보상을 받았습니다!');
                logEvent('quest_complete', {
                    quest_name: "오늘의 일기 쓰기",
                    exp_gain: expGain,
                    growth_point_gain: growthPointGain
                });
            } catch (error) {
                console.error("Quest completion failed:", error);
                showMessageModal('오류', '퀘스트 완료 중 오류가 발생했습니다.');
            }
        }

        /**
         * 성장일지 제출 버튼 클릭 이벤트를 처리합니다.
         */
        async function handleGrowthLogSubmission(e) {
            e.preventDefault();
            const logText = document.getElementById('growth-log-text').value.trim();

            if (!logText) {
                showMessageModal('오류', '내용을 입력해 주세요.');
                return;
            }

            const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);
            const studentDoc = await getDoc(studentDocRef);
            if (!studentDoc.exists()) {
                showMessageModal('오류', '사용자 정보를 찾을 수 없습니다.');
                return;
            }
            const studentData = studentDoc.data();

            // 이전 성장일지 제출 상태 확인
            const latestLogId = studentData.latest_log;
            if (latestLogId) {
                const latestLogDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/growth_logs`, latestLogId));
                if (latestLogDoc.exists() && latestLogDoc.data().status === 'pending') {
                    showMessageModal('대기 중', '이미 제출된 성장일지가 있습니다. 승인을 기다려 주세요.');
                    return;
                }
            }

            try {
                const newLogRef = await addDoc(collection(db, `artifacts/${appId}/public/data/growth_logs`), {
                    student_id: userId,
                    student_name: studentData.name,
                    content: logText,
                    status: 'pending',
                    timestamp: serverTimestamp()
                });

                await updateDoc(studentDocRef, {
                    latest_log: newLogRef.id
                });
                
                document.getElementById('growth-log-text').value = '';
                showMessageModal('전송 완료', '성장일지가 교사에게 전송되었습니다. 승인을 기다려 주세요!');
            } catch (error) {
                console.error("Growth log submission failed:", error);
                showMessageModal('오류', '성장일지 전송 중 오류가 발생했습니다.');
            }
        }

        /**
         * 교사가 성장일지 승인 버튼을 눌렀을 때 처리합니다.
         * @param {Event} e - 클릭 이벤트.
         */
        async function handleGrowthLogApproval(e) {
            const logId = e.target.dataset.id;
            const studentId = e.target.dataset.studentId;

            try {
                const logDocRef = doc(db, `artifacts/${appId}/public/data/growth_logs`, logId);
                const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, studentId);

                await updateDoc(logDocRef, { status: 'approved' });

                const studentDoc = await getDoc(studentDocRef);
                const studentData = studentDoc.data();

                const newExp = (studentData.exp || 0) + 50;
                const newGrowthPoints = (studentData.growth_points || 0) + 1;

                await updateDoc(studentDocRef, {
                    exp: newExp,
                    growth_points: newGrowthPoints
                });

                logEvent('growth_log_approved', {
                    logId: logId,
                    exp_gain: 50,
                    growth_point_gain: 1
                });

                showMessageModal('승인', '성장일지가 승인되었습니다. 학생에게 보상이 지급됩니다.');

            } catch (error) {
                console.error("Growth log approval failed:", error);
                showMessageModal('오류', '승인 처리 중 오류가 발생했습니다.');
            }
        }

        /**
         * 교사가 성장일지 거절 버튼을 눌렀을 때 처리합니다.
         * @param {Event} e - 클릭 이벤트.
         */
        async function handleGrowthLogRejection(e) {
            const logId = e.target.dataset.id;
            const studentId = e.target.dataset.studentId;

            try {
                const logDocRef = doc(db, `artifacts/${appId}/public/data/growth_logs`, logId);
                const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, studentId);

                await updateDoc(logDocRef, { status: 'rejected' });

                const studentDoc = await getDoc(studentDocRef);
                const studentData = studentDoc.data();

                const newExp = (studentData.exp || 0) + 20;

                await updateDoc(studentDocRef, {
                    exp: newExp
                });

                logEvent('growth_log_rejected', {
                    logId: logId,
                    exp_gain: 20
                });
                
                showMessageModal('거절', '성장일지가 거절되었습니다. 학생에게 20 경험치가 지급됩니다.');

            } catch (error) {
                console.error("Growth log rejection failed:", error);
                showMessageModal('오류', '거절 처리 중 오류가 발생했습니다.');
            }
        }

        /**
         * 능력치 증가 버튼 클릭 이벤트를 처리합니다.
         * @param {Event} event - 클릭 이벤트 객체.
         */
        async function handleStatIncrease(event) {
            const stat = event.target.dataset.stat;
            const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);
            const docSnap = await getDoc(studentDocRef);

            if (docSnap.exists()) {
                const studentData = docSnap.data();
                if (studentData.growth_points > 0) {
                    const newValue = (studentData[stat] || 0) + 1;
                    const newGrowthPoints = studentData.growth_points - 1;

                    await updateDoc(studentDocRef, {
                        [stat]: newValue,
                        growth_points: newGrowthPoints
                    });

                    // UI는 onSnapshot에서 자동 업데이트
                    showMessageModal('능력치 상승', `${stat} 능력치가 ${newValue} (으)로 상승했습니다.`);
                    logEvent('stat_increase', {
                        stat_name: stat,
                        new_value: newValue
                    });
                } else {
                    showMessageModal('포인트 부족', '성장 포인트가 부족합니다.');
                }
            }
        }

        /**
         * 가입 신청을 승인하고 학생 문서로 이동시킵니다.
         * @param {Event} event - 클릭 이벤트 객체.
         */
        async function handleApproveRequest(event) {
            const docId = event.target.dataset.id;
            try {
                // 1. register 문서 가져오기
                const registerDocRef = doc(db, `artifacts/${appId}/public/data/register`, docId);
                const registerDocSnap = await getDoc(registerDocRef);

                if (!registerDocSnap.exists()) {
                    showMessageModal('오류', '신청 정보를 찾을 수 없습니다.');
                    return;
                }
                const studentData = registerDocSnap.data();

                // 2. students 컬렉션에 새 문서 생성
                const studentsDocRef = doc(db, `artifacts/${appId}/public/data/students`, docId);
                await setDoc(studentsDocRef, {
                    ...studentData,
                    ...initialStats,
                    approvedBy: userId,
                    createdAt: serverTimestamp() // Use serverTimestamp for accuracy
                });

                // 3. register 문서의 상태 업데이트
                await updateDoc(registerDocRef, {
                    status: '승인됨'
                });

                showMessageModal('승인 완료', `${studentData.name} 학생이 성공적으로 승인되었습니다!`);
            } catch (error) {
                console.error("Approval failed:", error);
                showMessageModal('승인 오류', '학생 승인 중 오류가 발생했습니다.');
            }
        }

        /**
         * 업데이트된 능력치를 Firestore에 저장합니다.
         */
        async function saveStats() {
            try {
                const statElements = document.getElementById('stats-container').querySelectorAll('span');
                const updatedStats = {};
                statElements.forEach(el => {
                    const id = el.id;
                    if (id.includes('-display')) {
                        const statName = id.replace('-display', '');
                        updatedStats[statName] = parseInt(el.textContent, 10);
                    }
                });

                const growthPoints = parseInt(document.getElementById('growth-point-display').textContent, 10);
                const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);
                await updateDoc(studentDocRef, {
                    ...updatedStats,
                    growth_points: growthPoints
                });
                showMessageModal('저장 완료', '능력치가 성공적으로 저장되었습니다.');
                logEvent('stat_save', {
                    message: '능력치 변경사항을 저장했습니다.'
                });
            } catch (error) {
                console.error("Failed to save stats:", error);
                showMessageModal('저장 오류', '능력치 저장에 실패했습니다. 다시 시도해주세요.');
            }
        }

        // --- Event Listeners ---

        window.addEventListener('load', initFirebase);
        modalCloseBtn.addEventListener('click', () => {
            messageModalOverlay.classList.add('hidden');
        });

        // Landing view buttons
        showStudentLoginBtn.addEventListener('click', () => showView('studentLogin'));
        showRegisterBtn.addEventListener('click', () => showView('register'));
        showTeacherLoginBtn.addEventListener('click', () => showView('teacherLogin'));

        // Navigation buttons
        backToLandingFromLoginBtn.addEventListener('click', () => showView('landing'));
        backToLandingFromRegisterBtn.addEventListener('click', () => showView('landing'));
        backToLandingFromTeacherBtn.addEventListener('click', () => showView('landing'));

        // Student Tab buttons
        tabInfoBtn.addEventListener('click', () => {
            userInfoSection.classList.remove('hidden');
            questSection.classList.add('hidden');
            logSection.classList.add('hidden');
            shopSection.classList.add('hidden');
            document.querySelectorAll('#student-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            tabInfoBtn.classList.remove('border-transparent', 'text-gray-400');
            tabInfoBtn.classList.add('border-emerald-400', 'text-emerald-400');
        });
        tabQuestBtn.addEventListener('click', () => {
            userInfoSection.classList.add('hidden');
            questSection.classList.remove('hidden');
            logSection.classList.add('hidden');
            shopSection.classList.add('hidden');
            document.querySelectorAll('#student-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            tabQuestBtn.classList.remove('border-transparent', 'text-gray-400');
            tabQuestBtn.classList.add('border-emerald-400', 'text-emerald-400');
        });
        tabLogBtn.addEventListener('click', () => {
            userInfoSection.classList.add('hidden');
            questSection.classList.add('hidden');
            logSection.classList.remove('hidden');
            shopSection.classList.add('hidden');
            document.querySelectorAll('#student-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            tabLogBtn.classList.remove('border-transparent', 'text-gray-400');
            tabLogBtn.classList.add('border-emerald-400', 'text-emerald-400');
        });
        tabShopBtn.addEventListener('click', () => {
            userInfoSection.classList.add('hidden');
            questSection.classList.add('hidden');
            logSection.classList.add('hidden');
            shopSection.classList.remove('hidden');
            document.querySelectorAll('#student-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            tabShopBtn.classList.remove('border-transparent', 'text-gray-400');
            tabShopBtn.classList.add('border-emerald-400', 'text-emerald-400');
        });
        
        // Teacher Tab buttons
        teacherTabPendingStudentsBtn.addEventListener('click', () => {
            teacherPendingStudentsSection.classList.remove('hidden');
            teacherPendingLogsSection.classList.add('hidden');
            teacherTabPendingStudentsBtn.classList.remove('border-transparent', 'text-gray-400');
            teacherTabPendingStudentsBtn.classList.add('border-emerald-400', 'text-emerald-400');
            teacherTabPendingLogsBtn.classList.remove('border-emerald-400', 'text-emerald-400');
            teacherTabPendingLogsBtn.classList.add('border-transparent', 'text-gray-400');
        });
        teacherTabPendingLogsBtn.addEventListener('click', () => {
            teacherPendingStudentsSection.classList.add('hidden');
            teacherPendingLogsSection.classList.remove('hidden');
            teacherTabPendingStudentsBtn.classList.remove('border-emerald-400', 'text-emerald-400');
            teacherTabPendingStudentsBtn.classList.add('border-transparent', 'text-gray-400');
            teacherTabPendingLogsBtn.classList.remove('border-transparent', 'text-gray-400');
            teacherTabPendingLogsBtn.classList.add('border-emerald-400', 'text-emerald-400');
        });

        // Student Login Form Submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = document.getElementById('student-id-input').value;
            const password = document.getElementById('student-password-input').value;

            showView('loading');

            try {
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                const q = query(studentsRef, where("id", "==", studentId));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showMessageModal('로그인 실패', '아이디 또는 비밀번호가 올바르지 않습니다.');
                    showView('studentLogin');
                    return;
                }

                const studentDoc = querySnapshot.docs[0];
                const studentData = studentDoc.data();

                // Note: In a real app, this should be a hashed password comparison.
                if (studentData.password !== password) {
                    showMessageModal('로그인 실패', '아이디 또는 비밀번호가 올바르지 않습니다.');
                    showView('studentLogin');
                    return;
                }

                // 로그인 성공
                userId = studentDoc.id; // 사용자 ID로 문서 ID 사용
                renderStudentDashboard();
            } catch (error) {
                console.error("Student login failed:", error);
                showMessageModal('오류', '로그인 중 오류가 발생했습니다.');
                showView('studentLogin');
            }
        });

        // Teacher Login Form Submission
        teacherLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const teacherCode = document.getElementById('teacher-code-input').value;

            showView('loading');

            // Hardcoded teacher code for demonstration
            if (teacherCode === "superteacher") {
                userId = "teacher-123"; // Use a consistent ID for the teacher user
                renderTeacherDashboard();
            } else {
                showMessageModal('로그인 실패', '교사 코드가 올바르지 않습니다.');
                showView('teacherLogin');
            }
        });

        // Registration Form Submission
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const grade = document.getElementById('register-grade').value;
            const className = document.getElementById('register-class').value;
            const number = document.getElementById('register-number').value;
            const name = document.getElementById('register-name').value;
            const id = document.getElementById('register-id').value;
            const password = document.getElementById('register-password').value;
            const characterName = document.getElementById('register-char-name').value;

            if (!grade || !className || !number || !name || !id || !password || !characterName) {
                showMessageModal('오류', '모든 필드를 채워주세요.');
                return;
            }
            if (password.length < 4) {
                showMessageModal('오류', '비밀번호는 최소 4자 이상이어야 합니다.');
                return;
            }

            showView('loading');

            try {
                // Check for duplicate IDs in both collections
                const registerRef = collection(db, `artifacts/${appId}/public/data/register`);
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                const idQuery = query(studentsRef, where("id", "==", id));
                const idQuery2 = query(registerRef, where("id", "==", id));

                const [studentsSnapshot, registerSnapshot] = await Promise.all([getDocs(idQuery), getDocs(idQuery2)]);

                if (!studentsSnapshot.empty || !registerSnapshot.empty) {
                    showMessageModal('가입 실패', '이미 사용 중인 아이디입니다.');
                    showView('register');
                    return;
                }

                // Add new document to register collection
                await addDoc(registerRef, {
                    grade: parseInt(grade, 10),
                    class: parseInt(className, 10),
                    number: parseInt(number, 10),
                    name: name,
                    id: id,
                    password: password,
                    character_name: characterName,
                    status: '대기중'
                });

                showMessageModal('가입 신청 완료', '가입 신청이 접수되었습니다. 교사의 승인 후 로그인할 수 있습니다.');
                showView('studentLogin');

            } catch (error) {
                console.error("Registration failed:", error);
                showMessageModal('오류', '가입 신청 중 오류가 발생했습니다.');
                showView('register');
            }
        });

        // Logout buttons
        logoutBtn.addEventListener('click', () => {
            auth.signOut();
            userId = null;
            showMessageModal('로그아웃', '성공적으로 로그아웃 되었습니다.');
            showView('landing');
        });
        teacherLogoutBtn.addEventListener('click', () => {
            auth.signOut();
            userId = null;
            showMessageModal('로그아웃', '성공적으로 로그아웃 되었습니다.');
            showView('landing');
        });
        saveStatsBtn.addEventListener('click', saveStats);

        // Growth log submission listener
        document.getElementById('growth-log-form').addEventListener('submit', handleGrowthLogSubmission);
    </script>
</body>

</html>
