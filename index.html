<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>배움 원정대</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    <!-- Font -->
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom styles for an adventure-game feel */
        .card-container {
            background-image: linear-gradient(135deg, #2b3956 0%, #1a233b 100%);
        }

        .btn-primary {
            background-image: linear-gradient(to right, #4ade80, #16a34a);
        }

        .btn-secondary {
            background-color: #3b82f6;
        }

        /* Progress Bar */
        .progress-container {
            height: 1.5rem;
            background-color: #4a5568;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            transition: width 0.5s ease-in-out;
            background-image: linear-gradient(to right, #6ee7b7, #34d399);
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container -->
    <div id="app-container" class="card-container rounded-3xl shadow-2xl p-8 max-w-lg w-full">

        <!-- Logo/Title -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold tracking-tight text-white mb-2">배움 원정대</h1>
            <p class="text-lg text-gray-400">배움의 모험에 오신 것을 환영합니다!</p>
        </div>

        <!-- Dynamic Content Views -->
        <div id="views-container">

            <!-- 1. Landing View (Initial screen with 3 buttons) -->
            <div id="landing-view" class="view hidden">
                <div class="space-y-4">
                    <button id="show-student-login-btn"
                        class="w-full p-4 rounded-lg text-white font-semibold shadow-md btn-primary text-lg">학생 로그인</button>
                    <button id="show-register-btn"
                        class="w-full p-4 rounded-lg text-white font-semibold shadow-md btn-secondary text-lg">학생 회원가입</button>
                    <button id="show-teacher-login-btn"
                        class="w-full p-4 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors text-lg">교사 로그인</button>
                </div>
            </div>

            <!-- 2. Student Login View -->
            <div id="student-login-view" class="view hidden">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-semibold mb-4">학생 로그인</h2>
                </div>
                <form id="login-form" class="space-y-4">
                    <div>
                        <input type="text" id="student-id-input" placeholder="아이디"
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="password" id="student-password-input" placeholder="비밀번호"
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <button type="submit"
                        class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">로그인</button>
                    <button type="button" id="back-to-landing-from-login"
                        class="w-full mt-4 p-3 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors">뒤로가기</button>
                </form>
            </div>

            <!-- 3. Registration View -->
            <div id="register-view" class="view hidden">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-semibold mb-4">회원가입</h2>
                </div>
                <form id="register-form" class="space-y-4">
                    <div>
                        <input type="number" id="register-grade" placeholder="학년" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="number" id="register-class" placeholder="반" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="number" id="register-number" placeholder="번호" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="text" id="register-name" placeholder="이름" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="text" id="register-id" placeholder="아이디 (중복 불가)" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="password" id="register-password" placeholder="비밀번호 (4자 이상)" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="text" id="register-char-name" placeholder="캐릭터 이름" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <button type="submit"
                        class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">가입 신청</button>
                    <button type="button" id="back-to-landing-from-register"
                        class="w-full mt-4 p-3 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors">뒤로가기</button>
                </form>
            </div>

            <!-- 4. Teacher Login View -->
            <div id="teacher-login-view" class="view hidden">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-semibold mb-4">교사 로그인</h2>
                </div>
                <form id="teacher-login-form" class="space-y-4">
                    <div>
                        <input type="password" id="teacher-code-input" placeholder="교사 코드" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <button type="submit"
                        class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">로그인</button>
                    <button type="button" id="back-to-landing-from-teacher"
                        class="w-full mt-4 p-3 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors">뒤로가기</button>
                </form>
            </div>

            <!-- 5. Student Dashboard View -->
            <div id="student-dashboard-view" class="view hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">학생 대시보드</h2>
                    <button id="logout-btn"
                        class="px-4 py-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-red-500 hover:text-white transition-colors">로그아웃</button>
                </div>

                <!-- Tabs -->
                <div class="flex justify-around mb-6 text-sm md:text-base">
                    <button id="tab-info"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 font-semibold border-emerald-400 text-emerald-400">정보</button>
                    <button id="tab-quest"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 border-transparent text-gray-400 hover:text-white">퀘스트</button>
                    <button id="tab-log"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 border-transparent text-gray-400 hover:text-white">성장일지</button>
                    <button id="tab-shop"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 border-transparent text-gray-400 hover:text-white">상점</button>
                </div>

                <!-- Tab Sections -->
                <div id="dashboard-sections">
                    <!-- 5.1. User Info Section -->
                    <div id="user-info-section" class="space-y-6">
                        <!-- User Info Card -->
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <div class="flex items-center space-x-4 mb-4">
                                <i class="fa-solid fa-user-circle text-4xl text-emerald-400"></i>
                                <div class="flex-1">
                                    <h3 id="char-name-display" class="text-2xl font-bold"></h3>
                                    <p class="text-gray-400 text-sm">유저 ID: <span id="user-id-display"
                                            class="text-xs break-words"></span></p>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <!-- Level & EXP -->
                                <div class="space-y-1">
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="font-semibold">레벨: <span id="level-display"></span></span>
                                        <span id="exp-text-display" class="text-sm text-gray-400"></span>
                                    </div>
                                    <div class="progress-container">
                                        <div id="exp-bar" class="progress-bar"></div>
                                    </div>
                                </div>
                                <!-- Diamonds -->
                                <div class="flex items-center space-x-2">
                                    <i class="fa-solid fa-gem text-blue-400 text-xl"></i>
                                    <span class="font-semibold">다이아: <span id="diamond-display"></span></span>
                                </div>
                                <!-- Growth Points -->
                                <div class="flex items-center space-x-2">
                                    <i class="fa-solid fa-star text-yellow-400 text-xl"></i>
                                    <span class="font-semibold">성장 포인트: <span id="growth-point-display"></span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Card -->
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4">능력치</h3>
                            <div id="stats-container" class="space-y-3">
                                <!-- Stats will be rendered here dynamically -->
                            </div>
                            <button id="save-stats-btn"
                                class="w-full p-3 mt-6 rounded-lg text-white font-semibold shadow-md bg-green-500 hover:bg-green-600 transition-colors">변경사항
                                저장</button>
                        </div>
                    </div>

                    <!-- 5.2. Quest Section -->
                    <div id="quest-section" class="space-y-6 hidden">
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-scroll text-yellow-400"></i>
                                <span>오늘의 퀘스트</span>
                            </h3>
                            <div id="daily-quest-container">
                                <p class="text-gray-400 mb-4">새로운 퀘스트를 기다리는 중...</p>
                            </div>
                        </div>
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-clipboard-check text-emerald-400"></i>
                                <span>완료한 퀘스트 목록</span>
                            </h3>
                            <div id="completed-quests-container">
                                <p class="text-gray-400">아직 완료한 퀘스트가 없습니다.</p>
                            </div>
                        </div>
                    </div>

                    <!-- 5.3. Growth Log Section -->
                    <div id="log-section" class="space-y-6 hidden">
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-clipboard-list text-purple-400"></i>
                                <span>성장일지 기록</span>
                            </h3>
                            <form id="growth-log-form" class="space-y-4">
                                <textarea id="growth-log-text" rows="5"
                                    class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-400 text-white"
                                    placeholder="오늘 배운 점이나 느낀 점을 기록해 보세요."></textarea>
                                <button type="submit"
                                    class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">기록 전송</button>
                            </form>
                            <div id="growth-log-status" class="mt-4 p-4 rounded-lg text-center font-semibold hidden"></div>
                        </div>

                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-history text-gray-400"></i>
                                <span>나의 성장 기록</span>
                            </h3>
                            <div id="growth-log-container" class="space-y-4">
                                <!-- Growth log entries will be rendered here dynamically -->
                                <p class="text-gray-400">성장 기록이 없습니다. 모험을 시작해 보세요!</p>
                            </div>
                        </div>
                    </div>

                    <!-- 5.4. Shop Section -->
                    <div id="shop-section" class="space-y-6 hidden">
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-shop text-red-400"></i>
                                <span>상점</span>
                            </h3>
                            <p class="text-gray-400">이곳에 상점 아이템 목록이 표시됩니다.</p>
                        </div>
                    </div>

                </div>
            </div>

            <!-- 6. Teacher Dashboard View -->
            <div id="teacher-dashboard-view" class="view hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">교사 대시보드</h2>
                    <div class="flex space-x-2">
                        <button id="change-teacher-code-btn"
                            class="px-4 py-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-yellow-500 hover:text-white transition-colors text-sm">로그인 코드 변경</button>
                        <button id="teacher-logout-btn"
                            class="px-4 py-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-red-500 hover:text-white transition-colors text-sm">로그아웃</button>
                    </div>
                </div>
                <!-- Tabs -->
                <div class="flex justify-around mb-6 text-sm md:text-base">
                    <button id="teacher-tab-pending-students"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 font-semibold border-emerald-400 text-emerald-400">학생 승인</button>
                    <button id="teacher-tab-pending-logs"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 border-transparent text-gray-400 hover:text-white">성장일지 승인</button>
                </div>

                <!-- Teacher Tab Sections -->
                <div id="teacher-dashboard-sections">
                    <div id="teacher-pending-students-section">
                        <h3 class="text-xl font-semibold mb-4">미승인 학생 목록</h3>
                        <div id="pending-students-list" class="space-y-4">
                            <!-- Pending student list will be rendered here dynamically -->
                            <p class="text-gray-400 text-center" id="no-pending-students">미승인 학생이 없습니다.</p>
                        </div>
                    </div>
                    <div id="teacher-pending-logs-section" class="hidden">
                        <h3 class="text-xl font-semibold mb-4">미승인 성장일지</h3>
                        <div id="pending-growth-logs-list" class="space-y-4">
                            <!-- Pending growth logs will be rendered here dynamically -->
                            <p class="text-gray-400 text-center">미승인 성장일지가 없습니다.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loading-spinner" class="hidden flex flex-col items-center justify-center p-8">
                <i class="fas fa-spinner fa-spin text-5xl text-emerald-400 mb-4"></i>
                <p class="text-xl text-gray-400 font-semibold">데이터를 불러오는 중...</p>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="message-modal-overlay"
        class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay transition-opacity duration-300">
        <div
            class="bg-gray-800 p-8 rounded-3xl shadow-2xl max-w-sm w-full transform scale-95 transition-transform duration-300">
            <h3 id="modal-title" class="text-xl font-semibold mb-4 text-white"></h3>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <button id="modal-close-btn"
                class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">확인</button>
        </div>
    </div>

    <!-- Custom Modal for changing teacher code -->
    <div id="teacher-code-modal-overlay"
        class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay transition-opacity duration-300">
        <div
            class="bg-gray-800 p-8 rounded-3xl shadow-2xl max-w-sm w-full transform scale-95 transition-transform duration-300">
            <h3 class="text-xl font-semibold mb-4 text-white">로그인 코드 변경</h3>
            <form id="teacher-code-change-form" class="space-y-4">
                <div>
                    <input type="password" id="new-teacher-code-input" placeholder="새로운 교사 코드" required
                        class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                </div>
                <div class="flex space-x-2">
                    <button type="submit"
                        class="flex-1 p-3 rounded-lg text-white font-semibold shadow-md btn-primary">변경</button>
                    <button type="button" id="cancel-teacher-code-change-btn"
                        class="flex-1 p-3 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors">취소</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, setLogLevel, orderBy, limit, serverTimestamp, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Constants from the execution environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'Learning_Explorer';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBx1gV8tiS2e83pWkDx0Y8p3Uou5z2ZwgU",
            authDomain: "learning-explorers.firebaseapp.com",
            projectId: "learning-explorers",
            storageBucket: "learning-explorers.firebasestorage.app",
            messagingSenderId: "836826026401",
            appId: "1:836826026401:web:9d4e237cb888e478227be0",
            measurementId: "G-BNMVYB2XNJ"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase instances
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let studentDataCache = null;

        // UI element references
        const views = {
            landing: document.getElementById('landing-view'),
            studentLogin: document.getElementById('student-login-view'),
            register: document.getElementById('register-view'),
            teacherLogin: document.getElementById('teacher-login-view'),
            dashboard: document.getElementById('student-dashboard-view'),
            teacherDashboard: document.getElementById('teacher-dashboard-view'),
        };
        const showStudentLoginBtn = document.getElementById('show-student-login-btn');
        const showRegisterBtn = document.getElementById('show-register-btn');
        const showTeacherLoginBtn = document.getElementById('show-teacher-login-btn');
        const backToLandingFromLoginBtn = document.getElementById('back-to-landing-from-login');
        const backToLandingFromRegisterBtn = document.getElementById('back-to-landing-from-register');
        const backToLandingFromTeacherBtn = document.getElementById('back-to-landing-from-teacher');

        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const teacherLoginForm = document.getElementById('teacher-login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const teacherLogoutBtn = document.getElementById('teacher-logout-btn');
        const saveStatsBtn = document.getElementById('save-stats-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const messageModalOverlay = document.getElementById('message-modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        const teacherCodeModalOverlay = document.getElementById('teacher-code-modal-overlay');
        const teacherCodeChangeForm = document.getElementById('teacher-code-change-form');
        const newTeacherCodeInput = document.getElementById('new-teacher-code-input');
        const changeTeacherCodeBtn = document.getElementById('change-teacher-code-btn');
        const cancelTeacherCodeChangeBtn = document.getElementById('cancel-teacher-code-change-btn');

        // Tab buttons (Student)
        const tabInfoBtn = document.getElementById('tab-info');
        const tabQuestBtn = document.getElementById('tab-quest');
        const tabLogBtn = document.getElementById('tab-log');
        const tabShopBtn = document.getElementById('tab-shop');

        // Tab buttons (Teacher)
        const teacherTabPendingStudentsBtn = document.getElementById('teacher-tab-pending-students');
        const teacherTabPendingLogsBtn = document.getElementById('teacher-tab-pending-logs');

        // Sections
        const userInfoSection = document.getElementById('user-info-section');
        const questSection = document.getElementById('quest-section');
        const logSection = document.getElementById('log-section');
        const shopSection = document.getElementById('shop-section');
        const teacherPendingStudentsSection = document.getElementById('teacher-pending-students-section');
        const teacherPendingLogsSection = document.getElementById('teacher-pending-logs-section');

        // Initial stat values for new students
        const initialStats = {
            level: 1,
            exp: 0,
            diamonds: 0,
            growth_points: 0,
            stamina: 5,
            attack: 5,
            defense: 5,
            luck: 5,
            equipped: {
                title: "없음",
                weapon: "없음",
                armor: "없음",
                hat: "없음",
                accessory: "없음",
                relic: "없음",
                skill: "없음"
            }
        };

        // --- Core Functions ---

        /**
         * Renders a specific view and hides all others.
         * @param {string} viewName - The name of the view to show.
         */
        function showView(viewName) {
            loadingSpinner.classList.add('hidden');
            for (const key in views) {
                if (key === viewName) {
                    views[key].classList.remove('hidden');
                } else {
                    views[key].classList.add('hidden');
                }
            }
        }

        /**
         * Shows a custom modal message.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message to display.
         */
        function showMessageModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModalOverlay.classList.remove('hidden');
        }

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initFirebase() {
            try {
                setLogLevel('debug');
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                await signInWithCustomToken(auth, initialAuthToken || 'anonymous-token').catch(() => signInAnonymously(auth));

                userId = auth.currentUser.uid;
                isAuthReady = true;

                console.log('Firebase initialized. User ID:', userId);

                // Initialize teacher password if it doesn't exist
                const teacherDocRef = doc(db, `artifacts/${appId}/public/data/teachers`, 'teacher_password');
                const teacherDocSnap = await getDoc(teacherDocRef);
                if (!teacherDocSnap.exists()) {
                    await setDoc(teacherDocRef, {
                        password: 'superteacher'
                    });
                }
                
                // Initialize a base quest in the database if it doesn't exist
                const questDocRef = doc(db, `artifacts/${appId}/public/data/quests`, 'daily_diary_quest');
                const questDocSnap = await getDoc(questDocRef);
                if (!questDocSnap.exists()) {
                    await setDoc(questDocRef, {
                        title: "오늘의 일기 쓰기",
                        description: "오늘 있었던 일을 간단히 기록해 보세요.",
                        exp_reward: 50,
                        gp_reward: 1,
                        type: "daily"
                    });
                }

                showView('landing');
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessageModal('오류', '데이터베이스 연결에 실패했습니다. 나중에 다시 시도해주세요.');
            }
        }

        // --- Data Handling ---

        /**
         * Renders the student dashboard with real-time data from Firestore.
         */
        function renderStudentDashboard() {
            if (!userId) {
                showMessageModal('오류', '로그인 정보가 유효하지 않습니다.');
                showView('landing');
                return;
            }

            showView('loading');
            const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);

            onSnapshot(studentDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    showView('dashboard');
                    studentDataCache = docSnap.data();

                    document.getElementById('user-id-display').textContent = userId;

                    document.getElementById('char-name-display').textContent = studentDataCache.character_name;
                    document.getElementById('level-display').textContent = studentDataCache.level;
                    document.getElementById('diamond-display').textContent = studentDataCache.diamonds;
                    document.getElementById('growth-point-display').textContent = studentDataCache.growth_points;

                    const expToNextLevel = 200;
                    const expPercentage = (studentDataCache.exp / expToNextLevel) * 100;
                    document.getElementById('exp-bar').style.width = `${Math.min(expPercentage, 100)}%`;
                    document.getElementById('exp-text-display').textContent = `${studentDataCache.exp}/${expToNextLevel}`;

                    if (studentDataCache.exp >= expToNextLevel) {
                        const newLevel = studentDataCache.level + 1;
                        const newExp = studentDataCache.exp - expToNextLevel;
                        const newGrowthPoints = studentDataCache.growth_points + 5;

                        updateDoc(studentDocRef, {
                            level: newLevel,
                            exp: newExp,
                            growth_points: newGrowthPoints
                        }).then(() => {
                            showMessageModal('레벨업!', `축하합니다! 레벨 ${newLevel}이 되었습니다! 성장 포인트 5점을 얻었습니다.`);
                            logEvent(userId, 'level_up', {
                                newLevel: newLevel
                            });
                        }).catch(error => {
                            console.error("Level up failed:", error);
                        });
                    }

                    const statsContainer = document.getElementById('stats-container');
                    statsContainer.innerHTML = '';
                    const stats = ['stamina', 'attack', 'defense', 'luck'];
                    stats.forEach(stat => {
                        const statElement = document.createElement('div');
                        statElement.className = 'flex items-center justify-between';
                        statElement.innerHTML = `
                            <span class="text-gray-300 font-semibold capitalize">${stat}</span>
                            <div class="flex items-center space-x-2">
                                <span id="${stat}-display" class="text-emerald-400 font-bold text-lg">${studentDataCache[stat]}</span>
                                <button data-stat="${stat}" class="stat-plus-btn bg-gray-600 w-8 h-8 rounded-full text-white font-bold text-sm hover:bg-emerald-400 transition-colors">+</button>
                            </div>
                        `;
                        statsContainer.appendChild(statElement);
                    });

                    document.querySelectorAll('.stat-plus-btn').forEach(button => {
                        button.addEventListener('click', handleStatIncrease);
                    });

                    renderQuest(studentDataCache);
                    setupGrowthLogUIListener();
                    renderGrowthLog();
                    listenForRewards();

                } else {
                    console.error("Student data not found for user ID:", userId);
                    showMessageModal('오류', '학생 데이터를 찾을 수 없습니다. 다시 로그인해주세요.');
                    auth.signOut();
                    showView('landing');
                }
            }, (error) => {
                console.error("Failed to fetch student data:", error);
                showMessageModal('오류', '데이터를 불러오는 중 오류가 발생했습니다.');
                auth.signOut();
                showView('landing');
            });
        }
        
        /**
         * Listens for growth log approvals and applies rewards.
         */
        function listenForRewards() {
            if (!userId) return;

            const logsCollectionRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);
            const q = query(logsCollectionRef,
                where("student_id", "==", userId),
                where("status", "in", ['approved', 'rejected']),
                where("rewarded", "==", false)
            );

            onSnapshot(q, async (querySnapshot) => {
                if (!isAuthReady) return;

                if (!querySnapshot.empty) {
                    for (const docSnap of querySnapshot.docs) {
                        const logData = docSnap.data();
                        const logDocRef = docSnap.ref;
                        const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);

                        try {
                            const studentDocSnap = await getDoc(studentDocRef);
                            const studentData = studentDocSnap.data();

                            let expGain = 0;
                            let growthPointGain = 0;

                            if (logData.status === 'approved') {
                                expGain = 50;
                                growthPointGain = 1;
                                showMessageModal('축하합니다!', `교사에게 성장일지 '최고' 점수를 받았습니다! 경험치 ${expGain}을 얻었습니다.`);
                            } else if (logData.status === 'rejected') {
                                expGain = 20;
                                showMessageModal('확인됨', `교사가 성장일지를 확인했습니다. 경험치 ${expGain}을 얻었습니다.`);
                            }

                            const newExp = (studentData.exp || 0) + expGain;
                            const newGrowthPoints = (studentData.growth_points || 0) + growthPointGain;
                            
                            await updateDoc(studentDocRef, {
                                exp: newExp,
                                growth_points: newGrowthPoints
                            });

                            await updateDoc(logDocRef, { rewarded: true });

                            logEvent(userId, `growth_log_reward_${logData.status}`, {
                                logId: docSnap.id,
                                exp_gain: expGain,
                                growth_point_gain: growthPointGain
                            });

                        } catch (error) {
                            console.error("Failed to apply reward:", error);
                        }
                    }
                }
            });
        }


        /**
         * Renders the teacher dashboard with real-time data from Firestore.
         */
        async function renderTeacherDashboard() {
            showView('loading');

            const pendingListContainer = document.getElementById('pending-students-list');
            const registerRef = collection(db, `artifacts/${appId}/public/data/register`);
            const qStudents = query(registerRef, where("status", "==", "대기중"));
            onSnapshot(qStudents, (snapshot) => {
                pendingListContainer.innerHTML = '';
                if (snapshot.empty) {
                    pendingListContainer.innerHTML = '<p class="text-gray-400 text-center">미승인 학생이 없습니다.</p>';
                } else {
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const docId = doc.id;
                        const card = document.createElement('div');
                        card.className = 'bg-gray-800 rounded-2xl p-4 shadow-md flex items-center justify-between';
                        card.innerHTML = `
                            <div>
                                <h4 class="text-lg font-semibold">${data.name} (${data.id})</h4>
                                <p class="text-gray-400 text-sm">학년: ${data.grade}반: ${data.class} 번호: ${data.number}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button data-action="approve" data-id="${docId}" class="approve-btn px-4 py-2 rounded-lg text-white font-semibold bg-green-500 hover:bg-green-600 transition-colors">승인</button>
                                <button data-action="reject" data-id="${docId}" class="reject-btn px-4 py-2 rounded-lg text-white font-semibold bg-red-500 hover:bg-red-600 transition-colors">거절</button>
                            </div>
                        `;
                        pendingListContainer.appendChild(card);
                    });
                    document.querySelectorAll('.approve-btn').forEach(btn => {
                        btn.addEventListener('click', handleApproveRequest);
                    });
                    document.querySelectorAll('.reject-btn').forEach(btn => {
                        btn.addEventListener('click', handleApproveRequest);
                    });
                }
            });

            const pendingLogsContainer = document.getElementById('pending-growth-logs-list');
            const logsRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);
            const qLogs = query(logsRef, where("status", "==", "pending"));
            onSnapshot(qLogs, (snapshot) => {
                pendingLogsContainer.innerHTML = '';
                if (snapshot.empty) {
                    pendingLogsContainer.innerHTML = '<p class="text-gray-400 text-center">미승인 성장일지가 없습니다.</p>';
                } else {
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const docId = doc.id;
                        const card = document.createElement('div');
                        card.className = 'bg-gray-800 rounded-2xl p-4 shadow-md space-y-3';
                        card.innerHTML = `
                            <div class="flex items-center justify-between">
                                <h4 class="text-lg font-semibold">${data.student_name}님의 일지</h4>
                                <p class="text-sm text-gray-400">${data.timestamp.toDate().toLocaleDateString()}</p>
                            </div>
                            <p class="text-gray-300 text-sm overflow-hidden whitespace-nowrap overflow-ellipsis">${data.content}</p>
                            <div class="flex justify-end space-x-2">
                                <button data-id="${docId}" data-student-id="${data.student_id}" class="approve-log-btn px-4 py-2 rounded-lg text-white font-semibold bg-green-500 hover:bg-green-600 transition-colors">최고</button>
                                <button data-id="${docId}" data-student-id="${data.student_id}" class="reject-log-btn px-4 py-2 rounded-lg text-white font-semibold bg-red-500 hover:bg-red-600 transition-colors">확인</button>
                            </div>
                        `;
                        pendingLogsContainer.appendChild(card);
                    });
                    document.querySelectorAll('.approve-log-btn').forEach(btn => {
                        btn.addEventListener('click', handleGrowthLogApproval);
                    });
                    document.querySelectorAll('.reject-log-btn').forEach(btn => {
                        btn.addEventListener('click', handleGrowthLogRejection);
                    });
                }
            });

            showView('teacherDashboard');
        }

        /**
         * Renders the student's daily quest status and completed quests.
         * @param {Object} studentData - The student's data from Firestore.
         */
        async function renderQuest(studentData) {
            const dailyQuestContainer = document.getElementById('daily-quest-container');
            const completedQuestsContainer = document.getElementById('completed-quests-container');
            
            dailyQuestContainer.innerHTML = '';
            completedQuestsContainer.innerHTML = '';

            // Get a single daily quest from Firestore
            const questsRef = collection(db, `artifacts/${appId}/public/data/quests`);
            const q = query(questsRef, where("type", "==", "daily"), limit(1));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                dailyQuestContainer.innerHTML = '<p class="text-gray-400">오늘의 퀘스트가 없습니다.</p>';
            } else {
                const questDoc = querySnapshot.docs[0];
                const questData = questDoc.data();
                const questId = questDoc.id;

                const questCompletedAt = studentData.quests?.[questId]?.completed_at;
                const today = new Date().toISOString().split('T')[0];

                const isCompletedToday = questCompletedAt && questCompletedAt.toDate().toISOString().split('T')[0] === today;
                
                if (isCompletedToday) {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-700 rounded-lg p-4 flex items-center justify-between';
                    card.innerHTML = `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-300">${questData.title}</h4>
                            <p class="text-sm text-emerald-400">퀘스트 완료!</p>
                        </div>
                        <i class="fa-solid fa-check-circle text-2xl text-emerald-400"></i>
                    `;
                    dailyQuestContainer.appendChild(card);
                } else {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-700 rounded-lg p-4 space-y-4';
                    card.innerHTML = `
                        <h4 class="text-lg font-semibold text-white">${questData.title}</h4>
                        <p class="text-gray-300">${questData.description} (경험치 +${questData.exp_reward}, 성장 포인트 +${questData.gp_reward})</p>
                        <button id="complete-quest-btn" data-quest-id="${questId}" class="w-full p-2 rounded-lg text-white font-semibold btn-primary">퀘스트 완료</button>
                    `;
                    dailyQuestContainer.appendChild(card);
                    document.getElementById('complete-quest-btn').addEventListener('click', handleQuestCompletion);
                }
            }
            
            // Render Completed Quests
            if (studentData.quests) {
                const completedQuests = Object.entries(studentData.quests).filter(([key, value]) => value.completed_at);
                if (completedQuests.length > 0) {
                    completedQuests.sort((a, b) => b[1].completed_at.toDate() - a[1].completed_at.toDate());
                    completedQuests.forEach(([key, value]) => {
                        const questCard = document.createElement('div');
                        questCard.className = 'bg-gray-700 rounded-lg p-3 shadow-sm';
                        const questName = key === "daily_diary_quest" ? "오늘의 일기 쓰기" : key;
                        const date = value.completed_at.toDate().toLocaleDateString();
                        questCard.innerHTML = `
                            <div class="flex items-center justify-between">
                                <p class="text-gray-300 font-semibold">${questName}</p>
                                <p class="text-sm text-emerald-400">완료</p>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">${date}에 완료됨</p>
                        `;
                        completedQuestsContainer.appendChild(questCard);
                    });
                } else {
                    completedQuestsContainer.innerHTML = '<p class="text-gray-400">아직 완료한 퀘스트가 없습니다.</p>';
                }
            } else {
                completedQuestsContainer.innerHTML = '<p class="text-gray-400">아직 완료한 퀘스트가 없습니다.</p>';
            }
        }

        /**
         * Sets up a real-time listener for the growth log UI state.
         */
        function setupGrowthLogUIListener() {
            if (!userId) return;

            const submissionForm = document.getElementById('growth-log-form');
            const statusContainer = document.getElementById('growth-log-status');
            const logTextarea = document.getElementById('growth-log-text');

            const logsCollectionRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);
            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);

            // NOTE: Firestore requires a composite index for this query.
            // If you get a "The query requires an index" error, follow the link in the console
            // to create the index. It is a one-time setup for your database.
            const q = query(logsCollectionRef,
                where("student_id", "==", userId),
                where("timestamp", ">=", todayStart)
            );

            onSnapshot(q, (querySnapshot) => {
                if (!querySnapshot.empty) {
                    submissionForm.classList.add('hidden');
                    statusContainer.classList.remove('hidden');
                    const logData = querySnapshot.docs[0].data();
                    let statusText = '';
                    let statusColor = '';
                    
                    switch (logData.status) {
                        case 'pending':
                            statusText = `<i class="fa-solid fa-hourglass-half text-yellow-400 mr-2"></i>승인 대기 중...`;
                            statusColor = 'bg-yellow-900 text-yellow-300';
                            break;
                        case 'approved':
                            statusText = `<i class="fa-solid fa-check-circle text-emerald-400 mr-2"></i>오늘의 성장일지 최고!`;
                            statusColor = 'bg-emerald-900 text-emerald-300';
                            break;
                        case 'rejected':
                            statusText = `<i class="fa-solid fa-times-circle text-red-400 mr-2"></i>오늘의 성장일지가 확인되었습니다. 다시 작성해 보세요.`;
                            statusColor = 'bg-red-900 text-red-300';
                            break;
                    }
                    statusContainer.innerHTML = statusText;
                    statusContainer.className = `mt-4 p-4 rounded-lg text-center font-semibold ${statusColor}`;
                } else {
                    submissionForm.classList.remove('hidden');
                    statusContainer.classList.add('hidden');
                    logTextarea.value = '';
                }
            });
        }
        
        /**
         * Renders the student's growth log history.
         */
        function renderGrowthLog() {
            const logContainer = document.getElementById('growth-log-container');
            const logCollectionRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);

            // NOTE: Firestore requires a composite index for this query.
            // If you get a "The query requires an index" error, follow the link in the console
            // to create the index. It is a one-time setup for your database.
            const q = query(logCollectionRef,
                where("student_id", "==", userId),
                orderBy('timestamp', 'desc'), limit(50));

            onSnapshot(q, (snapshot) => {
                logContainer.innerHTML = '';
                if (snapshot.empty) {
                    logContainer.innerHTML = '<p class="text-gray-400">성장 기록이 없습니다. 모험을 시작해 보세요!</p>';
                } else {
                    snapshot.forEach(doc => {
                        const logData = doc.data();
                        const logEntry = document.createElement('div');
                        logEntry.className = 'bg-gray-700 rounded-lg p-3 shadow-sm';

                        const timestamp = logData.timestamp?.toMillis ? logData.timestamp.toMillis() : logData.timestamp;
                        if (!timestamp) return;

                        const date = new Date(timestamp);
                        const formattedTime = date.toLocaleTimeString('ko-KR', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const formattedDate = date.toLocaleDateString('ko-KR');

                        let statusBadge = '';
                        let contentColorClass = 'text-gray-300';

                        if (logData.status === 'approved') {
                            statusBadge = `<span class="bg-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-full">최고</span>`;
                        } else if (logData.status === 'rejected') {
                            statusBadge = `<span class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">확인</span>`;
                        } else {
                            statusBadge = `<span class="bg-yellow-500 text-white text-xs font-bold px-2 py-1 rounded-full">대기 중</span>`;
                        }

                        logEntry.innerHTML = `
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm text-gray-400">${formattedDate}</p>
                                ${statusBadge}
                            </div>
                            <p class="${contentColorClass}">${logData.content}</p>
                        `;
                        logContainer.appendChild(logEntry);
                    });
                }
            }, (error) => {
                console.error("Failed to fetch growth log:", error);
                logContainer.innerHTML = '<p class="text-red-400">성장 기록을 불러오는 중 오류가 발생했습니다.</p>';
            });
        }
        
        /**
         * Logs an event to the student's growth log.
         * @param {string} studentId - The ID of the student.
         * @param {string} eventType - The type of event.
         * @param {object} details - Details of the event.
         */
        async function logEvent(studentId, eventType, details) {
            if (!studentId) return;
            try {
                const logCollectionRef = collection(db, `artifacts/${appId}/public/data/students/${studentId}/log`);
                await addDoc(logCollectionRef, {
                    event_type: eventType,
                    details: details,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Failed to log event:", error);
            }
        }

        /**
         * Handles quest completion and awards the user.
         */
        async function handleQuestCompletion(e) {
            if (!userId) {
                showMessageModal('오류', '로그인 정보가 유효하지 않습니다.');
                return;
            }
            const questId = e.target.dataset.questId;

            const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);
            const questDocRef = doc(db, `artifacts/${appId}/public/data/quests`, questId);
            
            const [studentDocSnap, questDocSnap] = await Promise.all([
                getDoc(studentDocRef),
                getDoc(questDocRef)
            ]);

            if (!studentDocSnap.exists() || !questDocSnap.exists()) {
                showMessageModal('오류', '사용자 또는 퀘스트 데이터를 찾을 수 없습니다.');
                return;
            }

            const studentData = studentDocSnap.data();
            const questData = questDocSnap.data();
            
            const questCompletedAt = studentData.quests?.[questId]?.completed_at;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            if (questCompletedAt && questCompletedAt.toDate() >= today) {
                showMessageModal('퀘스트 완료', '오늘의 퀘스트는 이미 완료했습니다.');
                return;
            }

            const expGain = questData.exp_reward;
            const growthPointGain = questData.gp_reward;
            const newExp = (studentData.exp || 0) + expGain;
            const newGrowthPoints = (studentData.growth_points || 0) + growthPointGain;

            try {
                await updateDoc(studentDocRef, {
                    exp: newExp,
                    growth_points: newGrowthPoints,
                    [`quests.${questId}.completed_at`]: serverTimestamp()
                });
                showMessageModal('퀘스트 성공', '오늘의 퀘스트를 완료하고 보상을 받았습니다!');
                logEvent(userId, 'quest_complete', {
                    quest_name: questData.title,
                    exp_gain: expGain,
                    growth_point_gain: growthPointGain
                });
            } catch (error) {
                console.error("Quest completion failed:", error);
                showMessageModal('오류', '퀘스트 완료 중 오류가 발생했습니다.');
            }
        }

        /**
         * Handles the growth log submission button click.
         */
        async function handleGrowthLogSubmission(e) {
            e.preventDefault();
            const logText = document.getElementById('growth-log-text').value.trim();
            const submitButton = e.target.querySelector('button[type="submit"]');

            if (!logText) {
                showMessageModal('오류', '내용을 입력해 주세요.');
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> 전송 중...`;

            try {
                if (!userId) {
                    showMessageModal('오류', '로그인 정보가 유효하지 않습니다.');
                    return;
                }

                const logsCollectionRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);
                const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);
                const studentDoc = await getDoc(studentDocRef);

                if (!studentDoc.exists()) {
                    showMessageModal('오류', '사용자 정보를 찾을 수 없습니다.');
                    return;
                }
                const studentData = studentDoc.data();

                // Check if a log has already been submitted today
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                const q = query(logsCollectionRef,
                    where("student_id", "==", userId),
                    where("timestamp", ">=", todayStart)
                );
                const existingLogs = await getDocs(q);

                if (!existingLogs.empty) {
                    showMessageModal('제출 실패', '오늘은 이미 성장일지를 제출했습니다.');
                    return;
                }
                
                await addDoc(logsCollectionRef, {
                    student_id: userId,
                    student_name: studentData.name,
                    content: logText,
                    status: 'pending',
                    rewarded: false, // Add a flag to track if the reward has been given
                    timestamp: serverTimestamp()
                });

                document.getElementById('growth-log-text').value = '';
                showMessageModal('전송 완료', '성장일지가 교사에게 전송되었습니다. 승인을 기다려 주세요!');
            } catch (error) {
                console.error("Growth log submission failed:", error);
                showMessageModal('오류', `성장일지 전송 중 오류가 발생했습니다: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = `기록 전송`;
            }
        }

        /**
         * Handles teacher approval of a growth log.
         * @param {Event} e - Click event.
         */
        async function handleGrowthLogApproval(e) {
            const logId = e.target.dataset.id;
            try {
                const logDocRef = doc(db, `artifacts/${appId}/public/data/growth_logs`, logId);
                const logDocSnap = await getDoc(logDocRef);

                if (!logDocSnap.exists()) {
                    showMessageModal('오류', '성장일지 정보를 찾을 수 없습니다.');
                    return;
                }

                await updateDoc(logDocRef, { status: 'approved' });
                showMessageModal('승인 완료', '성장일지가 최고 점수를 받았습니다. 학생에게 보상이 지급될 예정입니다!');
            } catch (error) {
                console.error("Growth log approval failed:", error);
                showMessageModal('오류', '승인 처리 중 오류가 발생했습니다.');
            }
        }

        /**
         * Handles teacher rejection of a growth log.
         * @param {Event} e - Click event.
         */
        async function handleGrowthLogRejection(e) {
            const logId = e.target.dataset.id;
            try {
                const logDocRef = doc(db, `artifacts/${appId}/public/data/growth_logs`, logId);
                const logDocSnap = await getDoc(logDocRef);

                if (!logDocSnap.exists()) {
                    showMessageModal('오류', '성장일지 정보를 찾을 수 없습니다.');
                    return;
                }

                await updateDoc(logDocRef, { status: 'rejected' });
                showMessageModal('확인 완료', '성장일지가 확인되었습니다. 학생에게 보상이 지급될 예정입니다!');
            } catch (error) {
                console.error("Growth log rejection failed:", error);
                showMessageModal('오류', '확인 처리 중 오류가 발생했습니다.');
            }
        }

        /**
         * Handles the stat increase button click.
         * @param {Event} event - The click event object.
         */
        async function handleStatIncrease(event) {
            const stat = event.target.dataset.stat;
            const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);
            const docSnap = await getDoc(studentDocRef);

            if (docSnap.exists()) {
                const studentData = docSnap.data();
                if (studentData.growth_points > 0) {
                    const newValue = (studentData[stat] || 0) + 1;
                    const newGrowthPoints = studentData.growth_points - 1;

                    await updateDoc(studentDocRef, {
                        [stat]: newValue,
                        growth_points: newGrowthPoints
                    });

                    showMessageModal('능력치 상승', `${stat} 능력치가 ${newValue} (으)로 상승했습니다.`);
                    logEvent(userId, 'stat_increase', {
                        stat_name: stat,
                        new_value: newValue
                    });
                } else {
                    showMessageModal('포인트 부족', '성장 포인트가 부족합니다.');
                }
            }
        }

        /**
         * Approves or rejects a registration request.
         * @param {Event} event - The click event object.
         */
        async function handleApproveRequest(event) {
            const docId = event.target.dataset.id;
            const action = event.target.dataset.action;
            try {
                const registerDocRef = doc(db, `artifacts/${appId}/public/data/register`, docId);
                const registerDocSnap = await getDoc(registerDocRef);

                if (!registerDocSnap.exists()) {
                    showMessageModal('오류', '신청 정보를 찾을 수 없습니다.');
                    return;
                }
                const studentData = registerDocSnap.data();

                if (action === 'approve') {
                    const studentsDocRef = doc(db, `artifacts/${appId}/public/data/students`, docId);
                    await setDoc(studentsDocRef, {
                        ...studentData,
                        ...initialStats,
                        approvedBy: userId,
                        createdAt: serverTimestamp()
                    });

                    await updateDoc(registerDocRef, {
                        status: '승인됨'
                    });

                    showMessageModal('승인 완료', `${studentData.name} 학생이 성공적으로 승인되었습니다!`);
                } else if (action === 'reject') {
                    await deleteDoc(registerDocRef);
                    showMessageModal('거절 완료', `${studentData.name} 학생의 가입이 거절되었습니다.`);
                }
            } catch (error) {
                console.error("Approval/Rejection failed:", error);
                showMessageModal('오류', '학생 승인/거절 중 오류가 발생했습니다.');
            }
        }

        /**
         * Saves the updated stats to Firestore.
         */
        async function saveStats() {
            if (!userId) {
                showMessageModal('오류', '로그인 정보가 유효하지 않습니다.');
                return;
            }
            try {
                const statElements = document.getElementById('stats-container').querySelectorAll('span');
                const updatedStats = {};
                statElements.forEach(el => {
                    const id = el.id;
                    if (id.includes('-display')) {
                        const statName = id.replace('-display', '');
                        updatedStats[statName] = parseInt(el.textContent, 10);
                    }
                });

                const growthPoints = parseInt(document.getElementById('growth-point-display').textContent, 10);
                const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);
                await updateDoc(studentDocRef, {
                    ...updatedStats,
                    growth_points: growthPoints
                });
                showMessageModal('저장 완료', '능력치가 성공적으로 저장되었습니다.');
                logEvent(userId, 'stat_save', {
                    message: '능력치 변경사항을 저장했습니다.'
                });
            } catch (error) {
                console.error("Failed to save stats:", error);
                showMessageModal('저장 오류', '능력치 저장에 실패했습니다. 다시 시도해주세요.');
            }
        }

        /**
         * Handles teacher code change.
         */
        async function handleTeacherCodeChange(e) {
            e.preventDefault();
            const newCode = newTeacherCodeInput.value.trim();

            if (!newCode || newCode.length < 4) {
                showMessageModal('오류', '새로운 교사 코드는 4자 이상이어야 합니다.');
                return;
            }

            try {
                const teacherDocRef = doc(db, `artifacts/${appId}/public/data/teachers`, 'teacher_password');
                await updateDoc(teacherDocRef, {
                    password: newCode
                });
                teacherCodeModalOverlay.classList.add('hidden');
                showMessageModal('변경 완료', '교사 로그인 코드가 성공적으로 변경되었습니다!');
            } catch (error) {
                console.error("Teacher code change failed:", error);
                showMessageModal('오류', '교사 코드 변경 중 오류가 발생했습니다.');
            }
        }

        // --- Event Listeners ---

        window.addEventListener('load', initFirebase);
        modalCloseBtn.addEventListener('click', () => {
            messageModalOverlay.classList.add('hidden');
        });

        // Landing view buttons
        showStudentLoginBtn.addEventListener('click', () => showView('studentLogin'));
        showRegisterBtn.addEventListener('click', () => showView('register'));
        showTeacherLoginBtn.addEventListener('click', () => showView('teacherLogin'));

        // Navigation buttons
        backToLandingFromLoginBtn.addEventListener('click', () => showView('landing'));
        backToLandingFromRegisterBtn.addEventListener('click', () => showView('landing'));
        backToLandingFromTeacherBtn.addEventListener('click', () => showView('landing'));

        // Student Tab buttons
        tabInfoBtn.addEventListener('click', () => {
            document.querySelectorAll('#dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            userInfoSection.classList.remove('hidden');
            document.querySelectorAll('#student-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            tabInfoBtn.classList.remove('border-transparent', 'text-gray-400');
            tabInfoBtn.classList.add('border-emerald-400', 'text-emerald-400');
        });
        tabQuestBtn.addEventListener('click', () => {
            document.querySelectorAll('#dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            questSection.classList.remove('hidden');
            document.querySelectorAll('#student-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            tabQuestBtn.classList.remove('border-transparent', 'text-gray-400');
            tabQuestBtn.classList.add('border-emerald-400', 'text-emerald-400');
            renderQuest(studentDataCache);
        });
        tabLogBtn.addEventListener('click', () => {
            document.querySelectorAll('#dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            logSection.classList.remove('hidden');
            document.querySelectorAll('#student-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            tabLogBtn.classList.remove('border-transparent', 'text-gray-400');
            tabLogBtn.classList.add('border-emerald-400', 'text-emerald-400');
            setupGrowthLogUIListener();
            renderGrowthLog();
        });
        tabShopBtn.addEventListener('click', () => {
            document.querySelectorAll('#dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            shopSection.classList.remove('hidden');
            document.querySelectorAll('#student-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            tabShopBtn.classList.remove('border-transparent', 'text-gray-400');
            tabShopBtn.classList.add('border-emerald-400', 'text-emerald-400');
        });

        // Teacher Tab buttons
        teacherTabPendingStudentsBtn.addEventListener('click', () => {
            document.querySelectorAll('#teacher-dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            teacherPendingStudentsSection.classList.remove('hidden');
            document.querySelectorAll('#teacher-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            teacherTabPendingStudentsBtn.classList.remove('border-transparent', 'text-gray-400');
            teacherTabPendingStudentsBtn.classList.add('border-emerald-400', 'text-emerald-400');
        });
        teacherTabPendingLogsBtn.addEventListener('click', () => {
            document.querySelectorAll('#teacher-dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            teacherPendingLogsSection.classList.remove('hidden');
            document.querySelectorAll('#teacher-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            teacherTabPendingLogsBtn.classList.remove('border-transparent', 'text-gray-400');
            teacherTabPendingLogsBtn.classList.add('border-emerald-400', 'text-emerald-400');
        });

        // Forms
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentIdInput = document.getElementById('student-id-input').value;
            const studentPasswordInput = document.getElementById('student-password-input').value;
            showView('loading');

            try {
                const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, studentIdInput);
                const docSnap = await getDoc(studentDocRef);

                const hashedPassword = sha256(studentPasswordInput);

                if (docSnap.exists() && docSnap.data().password === hashedPassword) {
                    const userCredential = await signInAnonymously(auth);
                    const user = userCredential.user;

                    await setDoc(doc(db, `artifacts/${appId}/public/data/users`, user.uid), {
                        studentId: studentIdInput,
                        role: 'student'
                    });

                    userId = studentIdInput;
                    renderStudentDashboard();
                    logEvent(userId, 'student_login');
                } else {
                    showMessageModal('로그인 실패', '아이디 또는 비밀번호가 올바르지 않습니다.');
                    showView('studentLogin');
                }
            } catch (error) {
                console.error("Student login failed:", error);
                showMessageModal('로그인 실패', '오류가 발생했습니다. 다시 시도해주세요.');
                showView('studentLogin');
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('register-id').value;
            const password = document.getElementById('register-password').value;
            const name = document.getElementById('register-name').value;
            const grade = parseInt(document.getElementById('register-grade').value);
            const studentClass = parseInt(document.getElementById('register-class').value);
            const number = parseInt(document.getElementById('register-number').value);
            const charName = document.getElementById('register-char-name').value;
            
            if (password.length < 4) {
                showMessageModal('회원가입 오류', '비밀번호는 4자 이상이어야 합니다.');
                return;
            }

            try {
                showView('loading');
                const registerRef = collection(db, `artifacts/${appId}/public/data/register`);
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                const qRegister = query(registerRef, where("id", "==", id));
                const qStudents = query(studentsRef, where("id", "==", id));
                
                const registerSnapshot = await getDocs(qRegister);
                const studentsSnapshot = await getDocs(qStudents);
                
                if (!registerSnapshot.empty || !studentsSnapshot.empty) {
                    showMessageModal('회원가입 오류', '이미 존재하는 아이디입니다. 다른 아이디를 사용해주세요.');
                    showView('register');
                    return;
                }

                // 비밀번호를 해시하여 저장
                const hashedPassword = sha256(password);
                
                await setDoc(doc(db, `artifacts/${appId}/public/data/register`, id), {
                    id: id,
                    password: hashedPassword,
                    name: name,
                    grade: grade,
                    class: studentClass,
                    number: number,
                    character_name: charName,
                    status: '대기중',
                    quests: {},
                    createdAt: serverTimestamp()
                });
                
                showMessageModal('가입 신청 완료', '가입 신청이 완료되었습니다. 교사의 승인을 기다려 주세요!');
                showView('landing');
            } catch (error) {
                console.error("Registration failed:", error);
                showMessageModal('회원가입 오류', '회원가입 중 오류가 발생했습니다. 다시 시도해주세요.');
                showView('register');
            }
        });

        teacherLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const teacherCode = document.getElementById('teacher-code-input').value;
            const teacherDocRef = doc(db, `artifacts/${appId}/public/data/teachers`, 'teacher_password');
            const docSnap = await getDoc(teacherDocRef);

            if (docSnap.exists() && docSnap.data().password === teacherCode) {
                renderTeacherDashboard();
            } else {
                showMessageModal('로그인 실패', '교사 코드가 올바르지 않습니다.');
                showView('teacherLogin');
            }
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut();
            showView('landing');
            userId = null;
            studentDataCache = null;
        });

        teacherLogoutBtn.addEventListener('click', () => {
            auth.signOut();
            showView('landing');
        });
        
        // Teacher code change modal buttons
        changeTeacherCodeBtn.addEventListener('click', () => {
            teacherCodeModalOverlay.classList.remove('hidden');
        });
        cancelTeacherCodeChangeBtn.addEventListener('click', () => {
            teacherCodeModalOverlay.classList.add('hidden');
        });
        teacherCodeChangeForm.addEventListener('submit', handleTeacherCodeChange);

        // Student Dashboard Actions
        saveStatsBtn.addEventListener('click', saveStats);
        document.getElementById('growth-log-form').addEventListener('submit', handleGrowthLogSubmission);
    </script>
</body>

</html>






