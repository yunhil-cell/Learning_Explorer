<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>배움 원정대</title>
    <meta name="description" content="배움 원정대 — Firebase + GitHub Pages SPA 뼈대" />

    <style>
      @font-face {
        font-family: 'DnfTemperedBlade';
        src: url('//cdn.df.nexon.com/img/common/font/DNFForgedBlade-Light.otf') format('opentype');
        font-weight: 300;
        font-display: swap;
      }
      @font-face {
        font-family: 'DnfTemperedBlade';
        src: url('//cdn.df.nexon.com/img/common/font/DNFForgedBlade-Medium.otf') format('opentype');
        font-weight: 500;
        font-display: swap;
      }
      @font-face {
        font-family: 'DnfTemperedBlade';
        src: url('//cdn.df.nexon.com/img/common/font/DNFForgedBlade-Bold.otf') format('opentype');
        font-weight: 700;
        font-display: swap;
      }

      *, *::before, *::after { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: 'DnfTemperedBlade';
        line-height: 1.4;
        background: #0b1020;
        color: #e6e9f5;
      }

      /* 폼/버튼/링크(버튼 스타일)에도 동일 폰트를 강제 */
      button, input, select, textarea, a.btn {
        font-family: 'DnfTemperedBlade';
      }
      :root {
        --maxw: 1080px;
        --surface: #11162b;
        --surface-2: #0f1430;
        --text: #e6e9f5;
        --muted: #a8b0d3;
        --primary: #7aa2ff;
        --primary-2: #99c1ff;
        --ring: rgba(122,162,255,0.45);
        --border: #223058;
        --success: #51d39f;
        --warning: #f6c350;
        --danger: #ff6b6b;
        --shadow: 0 8px 28px rgba(0,0,0,0.35);
        --radius: 20px;
      }

      .container { width: min(100%, var(--maxw)); margin: 0 auto; padding: 24px 20px 48px; }
      .card { background: linear-gradient(180deg, var(--surface), var(--surface-2)); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 24px; }
      h1, h2, h3 { margin: 0 0 12px; line-height: 1.2; }
      h1 { font-weight: 700; font-size: clamp(28px, 4vw, 40px); }
      h2 { font-weight: 500; font-size: clamp(22px, 3vw, 28px); color: var(--primary-2); }
      p  { margin: 0 0 12px; color: var(--muted); }

      .btn {
        appearance: none;
        border: 1px solid var(--border);
        background: #18224a;
        color: #e6e9f5;
        padding: 12px 16px;
        border-radius: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: transform .05s ease, box-shadow .2s ease, border-color .2s ease, filter .2s ease;
        text-decoration: none;
        display: block;
        text-align: center;
        width: 100%;
      }
      .btn:focus { outline: none; box-shadow: 0 0 0 3px var(--ring); }
      .btn:hover { border-color: var(--primary); }
      .btn:active { transform: translateY(1px); }

      .landing-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 16px; }

      .btn-student { background: var(--primary); color: #0b1020; border-color: transparent; }
      .btn-register { background: var(--warning); color: #0b1020; border-color: transparent; }
      .btn-teacher { background: var(--success); color: #0b1020; border-color: transparent; }
      .btn-student:hover, .btn-register:hover, .btn-teacher:hover { filter: brightness(1.05); }
      
      .center-all {
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      
      .landing-center {
        min-height: calc(100vh - 120px);
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
      }
      .page-card { width: 100%; max-width: 560px; margin-inline: auto; }

      .hidden { display: none !important; }

      #toast-root { position: fixed; inset: auto 0 20px 0; display: grid; place-items: center; pointer-events: none; z-index: 1000; }
      .toast { background: #1b244b; border: 1px solid var(--border); color: #e6e9f5; border-radius: 12px; padding: 10px 14px; margin: 6px; box-shadow: var(--shadow); }

      .skip-link { position: absolute; left: -9999px; top: auto; }
      .skip-link:focus { position: static; display: inline-block; margin: 8px; background: #000; color: #fff; padding: 8px 12px; border-radius: 8px; }

      form label { display: block; margin-bottom: 6px; font-weight: 500; color: var(--primary-2); }
      form input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 14px; background: #0f1430; color: #e6e9f5; }
      .triple-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 14px; }
      .triple-grid label { margin-bottom: 0; }
      .triple-grid input { margin-bottom: 0; }

      .inline-field { display: flex; gap: 10px; align-items: center; }
      .inline-field input { flex: 1; margin-bottom: 0; }
      .btn-small { width: auto; padding: 10px 12px; }
      .note { font-size: 12px; color: var(--muted); margin-top: 6px; }
    </style>
  </head>
  <body>
    <main id="app" class="container" aria-live="polite" aria-busy="false"></main>
    <div id="toast-root" aria-live="polite" aria-atomic="true"></div>

    <template id="view-landing">
      <section class="grid landing-center center-all">
        <div class="col-12">
          <div class="card page-card">
            <h1>배움 원정대</h1>
            <p>배움 원정대에 오신 것을 환영합니다.</p>
            <div class="landing-actions">
              <a class="btn btn-student" href="#student-login">학생 로그인</a>
              <a class="btn btn-register" href="#register">회원가입</a>
              <a class="btn btn-teacher" href="#teacher-login">교사 로그인</a>
            </div>
          </div>
        </div>
      </section>
    </template>

    <template id="view-register">
      <section class="grid center-all">
        <div class="col-12 col-6">
          <div class="card page-card">
            <h2>회원가입</h2>
            <form id="register-form">
              <div class="triple-grid">
                <label>학년 <input type="number" name="grade" required></label>
                <label>반 <input type="number" name="class" required></label>
                <label>번호 <input type="number" name="number" required></label>
              </div>

              <label>이름 <input type="text" name="name" required></label>

              <label>
                아이디
                <div class="inline-field">
                  <input type="text" name="id" required>
                  <button class="btn btn-register btn-small" type="button" id="btn-check-id">중복 확인</button>
                </div>
              </label>

              <label>비밀번호 <input type="password" name="password" required></label>

              <label>
                캐릭터명
                <div class="inline-field">
                  <input type="text" name="character_name" required>
                  <button class="btn btn-register btn-small" type="button" id="btn-check-character">중복 확인</button>
                </div>
              </label>

              <button class="btn btn-register" type="submit">제출</button>
              <a class="btn" href="#landing">돌아가기</a>
            </form>
          </div>
        </div>
      </section>
    </template>

    <template id="view-student-login">
      <section class="grid center-all">
        <div class="col-12 col-6">
          <div class="card page-card">
            <h2>학생 로그인</h2>
            <p>아이디/비밀번호 입력 폼 영역</p>
            <a class="btn" href="#landing">돌아가기</a>
          </div>
        </div>
      </section>
    </template>

    <template id="view-teacher-login">
      <section class="grid center-all">
        <div class="col-12 col-6">
          <div class="card page-card">
            <h2>교사 로그인</h2>
            <p>superteacher 코드 입력 폼 영역</p>
            <a class="btn" href="#landing">돌아가기</a>
          </div>
        </div>
      </section>
    </template>

    <template id="view-student">
      <section class="grid">
        <div class="col-12">
          <div class="card">
            <h2>학생 대시보드</h2>
            <p>정보/퀘스트/성장일지/상점 탭 영역</p>
          </div>
        </div>
      </section>
    </template>

    <template id="view-teacher">
      <section class="grid">
        <div class="col-12">
          <div class="card">
            <h2>교사 대시보드</h2>
            <p>가입/성장일지/학생/상점/보스 탭 영역</p>
          </div>
        </div>
      </section>
    </template>

    <template id="view-adventure">
      <section class="grid">
        <div class="col-12">
          <div class="card">
            <h2>전투 화면</h2>
            <p>전투 시작/로그/결과 영역</p>
          </div>
        </div>
      </section>
    </template>

    <template id="view-not-found">
      <section class="grid">
        <div class="col-12">
          <div class="card">
            <h2>페이지를 찾을 수 없습니다</h2>
            <p>잘못된 경로입니다. <a class="btn" href="#landing">처음으로</a></p>
          </div>
        </div>
      </section>
    </template>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getFirestore, doc, setDoc, serverTimestamp, collection, getDocs, query, where, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBx1gV8tiS2e83pWkDx0Y8p3Uou5z2ZwgU",
        authDomain: "learning-explorers.firebaseapp.com",
        projectId: "learning-explorers",
        storageBucket: "learning-explorers.firebasestorage.app",
        messagingSenderId: "836826026401",
        appId: "1:836826026401:web:9d4e237cb888e478227be0",
        measurementId: "G-BNMVYB2XNJ"
      };

      const fbApp = initializeApp(firebaseConfig);
      const db = getFirestore(fbApp);
      const auth = getAuth(fbApp);

      (async () => {
        try {
          await setPersistence(auth, browserLocalPersistence);
        } catch (e) {
          console.warn('Auth persistence 설정 실패(무시 가능):', e);
        }

        onAuthStateChanged(auth, (user) => {
          if (user) {
            console.log('현재 사용자 UID:', user.uid);
            try { localStorage.setItem('lx_uid', user.uid); } catch (_) {}
          } else {
            signInAnonymously(auth)
              .then(() => { console.log('익명 로그인 성공'); })
              .catch((error) => { console.error('익명 로그인 실패', error); });
          }
        });
      })();

      window.__FB__ = { fbApp, db, auth };

      // 중복 확인 유틸
      async function isDuplicate(field, value) {
        if (!value) return false;
        const q1 = query(collection(db, 'register'), where(field, '==', value), limit(1));
        const q2 = query(collection(db, 'students'), where(field, '==', value), limit(1));
        const [r1, r2] = await Promise.all([getDocs(q1), getDocs(q2)]);
        return !r1.empty || !r2.empty;
      }

      // 회원가입 폼 처리 및 중복 버튼
      document.addEventListener('click', async (e) => {
        const form = document.querySelector('#register-form');
        if (!form) return;
        if (e.target && e.target.id === 'btn-check-id') {
          const value = form.elements['id'].value.trim();
          if (!value) { toast('아이디를 입력하세요'); return; }
          toast('아이디 중복 검사 중...');
          const dup = await isDuplicate('id', value);
          toast(dup ? '이미 사용 중인 아이디입니다.' : '사용 가능한 아이디입니다.');
        }
        if (e.target && e.target.id === 'btn-check-character') {
          const value = form.elements['character_name'].value.trim();
          if (!value) { toast('캐릭터명을 입력하세요'); return; }
          toast('캐릭터명 중복 검사 중...');
          const dup = await isDuplicate('character_name', value);
          toast(dup ? '이미 사용 중인 캐릭터명입니다.' : '사용 가능한 캐릭터명입니다.');
        }
      });

      // 회원가입 제출 처리
      document.addEventListener('submit', async (e) => {
        if (e.target && e.target.id === 'register-form') {
          e.preventDefault();
          const form = e.target;
          const raw = Object.fromEntries(new FormData(form).entries());
          // 타입/공백 정규화
          const data = {
            grade: Number(raw.grade),
            class: Number(raw.class),
            number: Number(raw.number),
            name: raw.name?.trim(),
            id: raw.id?.trim(),
            password: raw.password,               // 개인용: 해시 생략
            character_name: raw.character_name?.trim(),
          };

          // 제출 전 간단한 중복 방지(선택사항): 둘 다 중복이면 막기
          const [dupId, dupChar] = await Promise.all([
            isDuplicate('id', data.id),
            isDuplicate('character_name', data.character_name),
          ]);
          if (dupId) { toast('이미 사용 중인 아이디입니다.'); return; }
          if (dupChar) { toast('이미 사용 중인 캐릭터명입니다.'); return; }

          // 문서 ID = name + createdAt(동일 문자열) 규칙 + 안전한 이름 정규화
          const createdAt = new Date().toISOString(); // 예: 2025-09-24T10:12:34.567Z
          const safeName = (data.name || '')
            .replace(/[\/\s]+/g, '_')   // 공백/슬래시 -> _
            .replace(/^_+|_+$/g, '');   // 앞뒤 _ 제거
          const docId = `${safeName}_${createdAt}`;

          try {
            await setDoc(doc(db, 'register', docId), {
              // 스키마 타입 일치 + 동일 createdAt 저장
              grade: data.grade,
              class: data.class,
              number: data.number,
              name: data.name,
              id: data.id,
              password: data.password,
              character_name: data.character_name,
              createdAt,                   // 문서 ID에 사용한 값과 동일(문자열)
              createdAtServer: serverTimestamp(), // 참고용 서버 타임스탬프
            });
            toast('회원가입 성공');
            form.reset();
            location.hash = '#landing';
          } catch (err) {
            console.error(err);
            toast('회원가입 실패');
          }
        }
      });
    </script>

    <script>
      const $ = (sel) => document.querySelector(sel);
      const app = $('#app');
      const toastRoot = $('#toast-root');

      const TEMPLATES = {
        '#landing':   '#view-landing',
        '#student-login': '#view-student-login',
        '#teacher-login': '#view-teacher-login',
        '#register':  '#view-register',
        '#student':   '#view-student',
        '#teacher':   '#view-teacher',
        '#adventure': '#view-adventure',
      };

      function render(hash) {
        const id = TEMPLATES[hash] || '#view-not-found';
        const tpl = document.querySelector(id);
        if (!tpl) return;
        app.setAttribute('aria-busy', 'true');
        app.innerHTML = '';
        app.appendChild(tpl.content.cloneNode(true));
        const titleMap = {
          '#landing': '배움 원정대 · 시작',
          '#student-login': '배움 원정대 · 학생 로그인',
          '#teacher-login': '배움 원정대 · 교사 로그인',
          '#register': '배움 원정대 · 회원가입',
          '#student': '배움 원정대 · 학생 대시보드',
          '#teacher': '배움 원정대 · 교사 대시보드',
          '#adventure': '배움 원정대 · 전투',
        };
        document.title = titleMap[hash] || '배움 원정대 · SPA';
        app.setAttribute('aria-busy', 'false');
      }

      function ensureDefaultHash() {
        if (!location.hash) {
          location.replace('#landing');
        }
      }

      window.addEventListener('hashchange', () => render(location.hash));
      window.addEventListener('DOMContentLoaded', () => { ensureDefaultHash(); render(location.hash); });

      window.toast = (msg) => {
        const el = document.createElement('div');
        el.className = 'toast';
        el.textContent = msg;
        toastRoot.appendChild(el);
        setTimeout(() => { el.remove(); }, 2500);
      };
    </script>
  </body>
</html>
