<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>배움 원정대</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    <!-- Font -->
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom styles for an adventure-game feel */
        .card-container {
            background-image: linear-gradient(135deg, #2b3956 0%, #1a233b 100%);
        }

        .btn-primary {
            background-image: linear-gradient(to right, #4ade80, #16a34a);
        }

        .btn-secondary {
            background-color: #3b82f6;
        }

        /* Progress Bar */
        .progress-container {
            height: 1.5rem;
            background-color: #4a5568;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            transition: width 0.5s ease-in-out;
            background-image: linear-gradient(to right, #6ee7b7, #34d399);
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container -->
    <div id="app-container" class="card-container rounded-3xl shadow-2xl p-8 max-w-lg w-full">

        <!-- Logo/Title -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold tracking-tight text-white mb-2">배움 원정대</h1>
            <p class="text-lg text-gray-400">배움의 모험에 오신 것을 환영합니다!</p>
        </div>

        <!-- Dynamic Content Views -->
        <div id="views-container">

            <!-- 1. Landing View (Initial screen with 3 buttons) -->
            <div id="landing-view" class="view hidden">
                <div class="space-y-4">
                    <button id="show-student-login-btn"
                        class="w-full p-4 rounded-lg text-white font-semibold shadow-md btn-primary text-lg">학생 로그인</button>
                    <button id="show-register-btn"
                        class="w-full p-4 rounded-lg text-white font-semibold shadow-md btn-secondary text-lg">학생 회원가입</button>
                    <button id="show-teacher-login-btn"
                        class="w-full p-4 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors text-lg">교사 로그인</button>
                </div>
            </div>

            <!-- 2. Student Login View -->
            <div id="student-login-view" class="view hidden">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-semibold mb-4">학생 로그인</h2>
                </div>
                <form id="login-form" class="space-y-4">
                    <div>
                        <input type="text" id="student-id-input" placeholder="아이디"
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="password" id="student-password-input" placeholder="비밀번호"
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <button type="submit"
                        class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">로그인</button>
                    <button type="button" id="back-to-landing-from-login"
                        class="w-full mt-4 p-3 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors">뒤로가기</button>
                </form>
            </div>

            <!-- 3. Registration View -->
            <div id="register-view" class="view hidden">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-semibold mb-4">회원가입</h2>
                </div>
                <form id="register-form" class="space-y-4">
                    <div>
                        <input type="number" id="register-grade" placeholder="학년" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="number" id="register-class" placeholder="반" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="number" id="register-number" placeholder="번호" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="text" id="register-name" placeholder="이름" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="text" id="register-id" placeholder="아이디 (중복 불가)" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="password" id="register-password" placeholder="비밀번호 (4자 이상)" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="text" id="register-char-name" placeholder="캐릭터 이름" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <button type="submit"
                        class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">가입 신청</button>
                    <button type="button" id="back-to-landing-from-register"
                        class="w-full mt-4 p-3 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors">뒤로가기</button>
                </form>
            </div>

            <!-- 4. Teacher Login View -->
            <div id="teacher-login-view" class="view hidden">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-semibold mb-4">교사 로그인</h2>
                </div>
                <form id="teacher-login-form" class="space-y-4">
                    <div>
                        <input type="password" id="teacher-code-input" placeholder="교사 코드" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <button type="submit"
                        class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">로그인</button>
                    <button type="button" id="back-to-landing-from-teacher"
                        class="w-full mt-4 p-3 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors">뒤로가기</button>
                </form>
            </div>

            <!-- 5. Student Dashboard View -->
            <div id="student-dashboard-view" class="view hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">학생 대시보드</h2>
                    <button id="logout-btn"
                        class="px-4 py-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-red-500 hover:text-white transition-colors">로그아웃</button>
                </div>

                <!-- Tabs -->
                <div class="flex justify-around mb-6 text-sm md:text-base">
                    <button id="tab-info"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 font-semibold border-emerald-400 text-emerald-400">정보</button>
                    <button id="tab-quest"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 border-transparent text-gray-400 hover:text-white">퀘스트</button>
                    <button id="tab-log"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 border-transparent text-gray-400 hover:text-white">성장일지</button>
                    <button id="tab-shop"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 border-transparent text-gray-400 hover:text-white">상점</button>
                </div>

                <!-- Tab Sections -->
                <div id="dashboard-sections">
                    <!-- 5.1. User Info Section -->
                    <div id="user-info-section" class="space-y-6">
                        <!-- User Info Card -->
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <div class="flex items-center space-x-4 mb-4">
                                <i class="fa-solid fa-user-circle text-4xl text-emerald-400"></i>
                                <div class="flex-1">
                                    <h3 id="char-name-display" class="text-2xl font-bold"></h3>
                                    <p class="text-gray-400 text-sm">유저 ID: <span id="user-id-display"
                                            class="text-xs break-words"></span></p>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <!-- Level & EXP -->
                                <div class="space-y-1">
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="font-semibold">레벨: <span id="level-display"></span></span>
                                        <span id="exp-text-display" class="text-sm text-gray-400"></span>
                                    </div>
                                    <div class="progress-container">
                                        <div id="exp-bar" class="progress-bar"></div>
                                    </div>
                                </div>
                                <!-- Diamonds -->
                                <div class="flex items-center space-x-2">
                                    <i class="fa-solid fa-gem text-blue-400 text-xl"></i>
                                    <span class="font-semibold">다이아: <span id="diamond-display"></span></span>
                                </div>
                                <!-- Growth Points -->
                                <div class="flex items-center space-x-2">
                                    <i class="fa-solid fa-star text-yellow-400 text-xl"></i>
                                    <span class="font-semibold">성장 포인트: <span id="growth-point-display"></span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Card -->
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4">능력치</h3>
                            <div id="stats-container" class="space-y-3">
                                <!-- Stats will be rendered here dynamically -->
                            </div>
                            <button id="save-stats-btn"
                                class="w-full p-3 mt-6 rounded-lg text-white font-semibold shadow-md bg-green-500 hover:bg-green-600 transition-colors">변경사항
                                저장</button>
                        </div>
                    </div>

                    <!-- 5.2. Quest Section -->
                    <div id="quest-section" class="space-y-6 hidden">
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-scroll text-yellow-400"></i>
                                <span>오늘의 퀘스트</span>
                            </h3>
                            <div id="daily-quest-container">
                                <p class="text-gray-400 mb-4">새로운 퀘스트를 기다리는 중...</p>
                            </div>
                        </div>
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-clipboard-check text-emerald-400"></i>
                                <span>완료한 퀘스트 목록</span>
                            </h3>
                            <div id="completed-quests-container">
                                <p class="text-gray-400">아직 완료한 퀘스트가 없습니다.</p>
                            </div>
                        </div>
                    </div>

                    <!-- 5.3. Growth Log Section -->
                    <div id="log-section" class="space-y-6 hidden">
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-clipboard-list text-purple-400"></i>
                                <span>성장일지 기록</span>
                            </h3>
                            <form id="growth-log-form" class="space-y-4">
                                <textarea id="growth-log-text" rows="5"
                                    class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-400 text-white"
                                    placeholder="오늘 배운 점이나 느낀 점을 기록해 보세요."></textarea>
                                <button type="submit"
                                    class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">기록 전송</button>
                            </form>
                            <div id="growth-log-status" class="mt-4 p-4 rounded-lg text-center font-semibold hidden"></div>
                        </div>

                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-history text-gray-400"></i>
                                <span>나의 성장 기록</span>
                            </h3>
                            <div id="growth-log-container" class="space-y-4">
                                <!-- Growth log entries will be rendered here dynamically -->
                                <p class="text-gray-400">성장 기록이 없습니다. 모험을 시작해 보세요!</p>
                            </div>
                        </div>
                    </div>

                    <!-- 5.4. Shop Section -->
                    <div id="shop-section" class="space-y-6 hidden">
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-shop text-red-400"></i>
                                <span>상점</span>
                            </h3>
                            <p class="text-gray-400">이곳에 상점 아이템 목록이 표시됩니다.</p>
                        </div>
                    </div>

                </div>
            </div>

            <!-- 6. Teacher Dashboard View -->
            <div id="teacher-dashboard-view" class="view hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">교사 대시보드</h2>
                    <div class="flex space-x-2">
                        <button id="change-teacher-code-btn"
                            class="px-4 py-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-yellow-500 hover:text-white transition-colors text-sm">로그인 코드 변경</button>
                        <button id="teacher-logout-btn"
                            class="px-4 py-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-red-500 hover:text-white transition-colors text-sm">로그아웃</button>
                    </div>
                </div>
                <!-- Tabs -->
                <div class="flex justify-start gap-2 mb-6 text-sm md:text-base">
                    <button id="teacher-tab-pending-students"
                        class="px-4 py-2 text-center border-b-2 font-semibold border-emerald-400 text-emerald-400">회원가입 관리</button>
                    <button id="teacherTabGrowthLogBtn" 
                        class="px-4 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-white hover:border-white transition-colors">성장일지 관리</button>
                    <button id="teacher-tab-students"
                        class="px-4 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-white hover:border-white transition-colors">학생 정보 확인</button>
                    <button id="teacher-tab-quest"
                        class="px-4 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-white hover:border-white transition-colors">퀘스트 관리</button>

                </div>

                <!-- Teacher Tab Sections -->
                <div id="teacher-dashboard-sections">
                    <div id="teacher-pending-students-section">
                        <h3 class="text-xl font-semibold mb-4">미승인 학생 목록</h3>
                        <div id="pending-students-list" class="space-y-4">
                            <!-- Pending student list will be rendered here dynamically -->
                            <p class="text-gray-400 text-center" id="no-pending-students">미승인 학생이 없습니다.</p>
                        </div>
                    </div>                    
                    <div id="growth-log-management-tab" class="hidden p-4">
                        <h3 class="text-xl font-bold mb-4 text-green-300">성장일지 관리</h3>                        
                        <div class="flex mb-4 border-b border-gray-700">
                            <button id="unverified-logs-tab-btn" class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white transition-colors">
                                미확인 성장일지
                            </button>
                            <button id="all-logs-tab-btn" class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white transition-colors">
                                전체 성장일지
                            </button>
                        </div>                        
                        <div id="unverified-logs-section" class="p-4 bg-gray-800 rounded-lg shadow-inner">
                            <div id="unverified-log-list">
                            </div>
                        </div>                        
                        <div id="all-logs-section" class="hidden">
                            <div id="student-list-container" class="mb-6">
                                <h4 class="text-lg font-semibold mb-2">학생 목록</h4>
                                <div id="student-list" class="flex flex-wrap gap-2">
                                </div>
                            </div>
                            <div id="teacher-growth-log-container" class="bg-gray-800 p-4 rounded-lg shadow-inner hidden">
                                <h4 class="text-lg font-semibold mb-2" id="selected-student-name"></h4>
                                <div id="growth-log-list">                                    
                                </div>
                            </div>                            
                        </div>
                    </div>
                    <div id="teacher-students-section" class="hidden">
                        <h3 class="text-xl font-semibold mb-4">학생 정보 확인</h3>
                        <div id="students-overview-list" class="space-y-2">
                        </div>
                    </div>
                    <div id="student-detail-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-60 flex items-center justify-center">
                        <div class="bg-gray-800 p-6 rounded-2xl w-full max-w-md">
                            <h3 id="student-detail-name" class="text-xl font-bold text-white mb-4"></h3>
                            
                            <!-- 기본 정보 -->
                            <div class="space-y-2 text-gray-200">
                                <div class="flex justify-between"><span>레벨</span><span id="detail-level"></span></div>
                                <div class="flex justify-between"><span>경험치</span><span id="detail-exp"></span></div>
                                <div class="flex justify-between"><span>다이아</span><span id="detail-diamonds"></span></div>
                            </div>
                            
                            <!-- 능력치 -->
                            <div class="mt-4">
                                <h4 class="text-lg font-semibold mb-2 text-white">능력치</h4>
                                <div id="student-detail-stats" class="space-y-2"></div>
                            </div>
                            
                            <!-- 액션 버튼 -->
                            <div class="mt-6 flex flex-col gap-2">
                                <button id="give-exp-btn" class="w-full px-4 py-2 rounded bg-blue-500 text-white font-semibold hover:bg-blue-600">경험치 지급</button>
                                <div id="exp-give-section" class="hidden p-3 bg-gray-700 rounded">
                                    <div class="flex items-center space-x-2 mb-3">
                                        <button id="exp-minus" class="px-2 py-1 bg-gray-600 rounded">-</button>
                                        <input id="exp-amount" type="number" value="10" min="1" class="w-20 text-center bg-gray-800 text-white rounded border border-gray-600">
                                        <button id="exp-plus" class="px-2 py-1 bg-gray-600 rounded">+</button>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button id="exp-confirm" class="flex-1 bg-blue-500 text-white px-3 py-1 rounded">지급</button>
                                        <button id="exp-cancel" class="flex-1 bg-red-500 text-white px-3 py-1 rounded">취소</button>
                                    </div>
                                </div>
                                
                                <button id="give-dia-btn" class="w-full px-4 py-2 rounded bg-purple-500 text-white font-semibold hover:bg-purple-600">다이아 지급</button>
                                <div id="dia-give-section" class="hidden p-3 bg-gray-700 rounded">
                                    <div class="flex items-center space-x-2 mb-3">
                                        <button id="dia-minus" class="px-2 py-1 bg-gray-600 rounded">-</button>
                                        <input id="dia-amount" type="number" value="5" min="1" class="w-20 text-center bg-gray-800 text-white rounded border border-gray-600">
                                        <button id="dia-plus" class="px-2 py-1 bg-gray-600 rounded">+</button>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button id="dia-confirm" class="flex-1 bg-purple-500 text-white px-3 py-1 rounded">지급</button>
                                        <button id="dia-cancel" class="flex-1 bg-red-500 text-white px-3 py-1 rounded">취소</button>
                                    </div>
                                </div>
                                
                                <button id="give-growth-btn" class="w-full px-4 py-2 rounded bg-green-500 text-white font-semibold hover:bg-green-600">성장 포인트 지급</button>
                                <div id="growth-give-section" class="hidden p-3 bg-gray-700 rounded">
                                    <div class="flex items-center space-x-2 mb-3">
                                        <button id="growth-minus" class="px-2 py-1 bg-gray-600 rounded">-</button>
                                        <input id="growth-amount" type="number" value="3" min="1" class="w-20 text-center bg-gray-800 text-white rounded border border-gray-600">
                                        <button id="growth-plus" class="px-2 py-1 bg-gray-600 rounded">+</button>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button id="growth-confirm" class="flex-1 bg-green-500 text-white px-3 py-1 rounded">지급</button>
                                        <button id="growth-cancel" class="flex-1 bg-red-500 text-white px-3 py-1 rounded">취소</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 닫기 -->
                            <button id="close-student-detail" class="mt-6 w-full px-4 py-2 rounded bg-red-500 text-white font-semibold hover:bg-red-600">닫기</button>
                        </div>
                    </div>
                    <!-- 퀘스트 관리 탭 전체 -->
                    <div id="teacher-quest-section" class="hidden">
                        <h3 class="text-xl font-bold mb-4 text-yellow-300">퀘스트 관리</h3>
                        
                        <!-- 서브탭 버튼 -->
                        <div class="flex mb-4 space-x-2">
                            <button id="quest-tab-list" class="px-4 py-2 text-sm font-medium border-b-2 border-yellow-400 text-yellow-400">퀘스트 목록</button>
                            <button id="quest-tab-manage" class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white hover:border-white">퀘스트 등록</button>
                            <button id="quest-tab-history" class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white hover:border-white">퀘스트 기록</button>
                        </div>
                        
                        <!-- 서브탭 콘텐츠 -->
                        <div id="quest-list-section">
                            <p class="text-gray-400">진행 중인 퀘스트 목록이 여기에 표시됩니다.</p>
                        </div>
                        
                        <div id="quest-manage-section" class="hidden">
                            <h4 class="text-lg font-semibold mb-4">신규 퀘스트 등록</h4>
                            <form id="quest-form" class="space-y-4 bg-gray-800 p-4 rounded-lg">
                                <!-- 퀘스트 이름 -->
                                <div>
                                    <label class="block text-gray-300 mb-1">퀘스트 이름</label>
                                    <input id="quest-name" type="text" required
                                        class="w-full px-3 py-2 rounded bg-gray-700 text-white border border-gray-600">
                                </div>
                                
                                <!-- 퀘스트 설명 -->
                                <div>
                                    <label class="block text-gray-300 mb-1">퀘스트 설명</label>
                                    <textarea id="quest-desc" rows="3" required
                                        class="w-full px-3 py-2 rounded bg-gray-700 text-white border border-gray-600"></textarea>
                                </div>
                                
                                <!-- 보상 -->
                                <div>
                                    <label class="block text-gray-300 mb-1">보상</label>
                                    <div class="space-y-2">
                                        <div class="flex items-center space-x-2">
                                            <span class="w-24 text-gray-300">경험치:</span>
                                            <input id="reward-exp" type="number" min="0" value="0"
                                                class="w-1/2 px-3 py-2 rounded bg-gray-700 text-white border border-gray-600">
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="w-24 text-gray-300">다이아:</span>
                                            <input id="reward-dia" type="number" min="0" value="0"
                                                class="w-1/2 px-3 py-2 rounded bg-gray-700 text-white border border-gray-600">
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="w-24 text-gray-300">성장포인트:</span>
                                            <input id="reward-growth" type="number" min="0" value="0"
                                                class="w-1/2 px-3 py-2 rounded bg-gray-700 text-white border border-gray-600">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 학생 선택 -->
                                <div>
                                    <label class="block text-gray-300 mb-1">부여할 학생</label>
                                    <div id="quest-student-list" class="space-y-1 max-h-40 overflow-y-auto bg-gray-700 p-2 rounded">
                                        <!-- 체크박스로 학생 목록 표시 -->
                                    </div>
                                    <button type="button" id="select-all-students"
                                        class="mt-2 px-3 py-1 bg-gray-600 text-white rounded hover:bg-emerald-500">전체 선택</button>
                                </div>
                                
                                <!-- 기간 -->
                                <div>
                                    <label class="block text-gray-300 mb-1">퀘스트 기간</label>
                                    <div class="flex items-center space-x-2 mb-2">
                                        <input type="checkbox" id="enable-period">
                                        <label for="enable-period" class="text-gray-300">기간 설정</label>
                                    </div>
                                    <div id="quest-period-inputs" class="hidden space-x-2">
                                        <input id="quest-start" type="date" class="px-2 py-1 rounded bg-gray-700 text-white border border-gray-600">
                                        <input id="quest-end" type="date" class="px-2 py-1 rounded bg-gray-700 text-white border border-gray-600">
                                    </div>
                                </div>
                                
                                <!-- 반복 여부 -->
                                <div>
                                    <label class="block text-gray-300 mb-1">반복 여부</label>
                                    <select id="quest-repeat"
                                        class="w-full px-3 py-2 rounded bg-gray-700 text-white border border-gray-600">
                                        <option value="none">없음</option>
                                        <option value="daily">일간</option>
                                        <option value="weekly">주간</option>
                                        <option value="monthly">월간</option>
                                    </select>
                                </div>
                                
                                <!-- 제출 -->
                                <div class="flex justify-end space-x-2">
                                    <button type="submit" class="px-4 py-2 bg-emerald-500 text-white rounded hover:bg-emerald-600">등록</button>
                                    <button type="reset" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-500">초기화</button>
                                </div>
                            </form>
                        </div>
                        
                        <div id="quest-history-section" class="hidden">
                            <p class="text-gray-400">종료된 퀘스트 기록이 여기에 표시됩니다.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

            <!-- Loading Spinner -->
            <div id="loading-spinner" class="hidden flex flex-col items-center justify-center p-8">
                <i class="fas fa-spinner fa-spin text-5xl text-emerald-400 mb-4"></i>
                <p class="text-xl text-gray-400 font-semibold">데이터를 불러오는 중...</p>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="message-modal-overlay"
        class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay transition-opacity duration-300">
        <div
            class="bg-gray-800 p-8 rounded-3xl shadow-2xl max-w-sm w-full transform scale-95 transition-transform duration-300">
            <h3 id="modal-title" class="text-xl font-semibold mb-4 text-white"></h3>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <button id="modal-close-btn"
                class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">확인</button>
        </div>
    </div>

    <!-- Custom Modal for changing teacher code -->
    <div id="teacher-code-modal-overlay"
        class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay transition-opacity duration-300">
        <div
            class="bg-gray-800 p-8 rounded-3xl shadow-2xl max-w-sm w-full transform scale-95 transition-transform duration-300">
            <h3 class="text-xl font-semibold mb-4 text-white">로그인 코드 변경</h3>
            <form id="teacher-code-change-form" class="space-y-4">
                <div>
                    <input type="password" id="new-teacher-code-input" placeholder="새로운 교사 코드" required
                        class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                </div>
                <div class="flex space-x-2">
                    <button type="submit"
                        class="flex-1 p-3 rounded-lg text-white font-semibold shadow-md btn-primary">변경</button>
                    <button type="button" id="cancel-teacher-code-change-btn"
                        class="flex-1 p-3 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors">취소</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, getDoc, addDoc, doc, setDoc, updateDoc, deleteDoc, orderBy, onSnapshot, serverTimestamp, setLogLevel, limit, increment, runTransaction } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-functions.js";
        
        // Constants from the execution environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'Learning_Explorer';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBx1gV8tiS2e83pWkDx0Y8p3Uou5z2ZwgU",
            authDomain: "learning-explorers.firebaseapp.com",
            projectId: "learning-explorers",
            storageBucket: "learning-explorers.firebasestorage.app",
            messagingSenderId: "836826026401",
            appId: "1:836826026401:web:9d4e237cb888e478227be0",
            measurementId: "G-BNMVYB2XNJ"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // 이 변수들은 단 한 번만 선언되어야 합니다.
        let app = initializeApp(firebaseConfig);
        let db = getFirestore(app);
        let auth = getAuth(app);
        let functions = getFunctions(app);
        let isAuthReady = false;
        
        // 전역 변수 설정
        let userId = null;
        let studentDataCache = null;

        // ✅ 능력치 라벨 매핑
        const statLabels = {
            stamina: "건강", 
            attack: "공격력", 
            defense: "방어력", 
            luck: "행운"
        };

        // UI element references
        const views = {
            landing: document.getElementById('landing-view'),
            studentLogin: document.getElementById('student-login-view'),
            register: document.getElementById('register-view'),
            teacherLogin: document.getElementById('teacher-login-view'),
            dashboard: document.getElementById('student-dashboard-view'),
            teacherDashboard: document.getElementById('teacher-dashboard-view'),
        };
        const showStudentLoginBtn = document.getElementById('show-student-login-btn');
        const showRegisterBtn = document.getElementById('show-register-btn');
        const showTeacherLoginBtn = document.getElementById('show-teacher-login-btn');
        const backToLandingFromLoginBtn = document.getElementById('back-to-landing-from-login');
        const backToLandingFromRegisterBtn = document.getElementById('back-to-landing-from-register');
        const backToLandingFromTeacherBtn = document.getElementById('back-to-landing-from-teacher');

        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const teacherLoginForm = document.getElementById('teacher-login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const teacherLogoutBtn = document.getElementById('teacher-logout-btn');
        const saveStatsBtn = document.getElementById('save-stats-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const messageModalOverlay = document.getElementById('message-modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        const teacherCodeModalOverlay = document.getElementById('teacher-code-modal-overlay');
        const teacherCodeChangeForm = document.getElementById('teacher-code-change-form');
        const newTeacherCodeInput = document.getElementById('new-teacher-code-input');
        const changeTeacherCodeBtn = document.getElementById('change-teacher-code-btn');
        const cancelTeacherCodeChangeBtn = document.getElementById('cancel-teacher-code-change-btn');

        // Tab buttons (Student)
        const tabInfoBtn = document.getElementById('tab-info');
        const tabQuestBtn = document.getElementById('tab-quest');
        const tabLogBtn = document.getElementById('tab-log');
        const tabShopBtn = document.getElementById('tab-shop');

        // Tab buttons (Teacher)
        const teacherTabPendingStudentsBtn = document.getElementById('teacher-tab-pending-students');
        const teacherTabPendingLogsBtn = document.getElementById('teacher-tab-pending-logs');

        // Sections
        const userInfoSection = document.getElementById('user-info-section');
        const questSection = document.getElementById('quest-section');
        const logSection = document.getElementById('log-section');
        const shopSection = document.getElementById('shop-section');
        const teacherPendingStudentsSection = document.getElementById('teacher-pending-students-section');
        const teacherPendingLogsSection = document.getElementById('teacher-pending-logs-section');

        // Initial stat values for new students
        const initialStats = {
            level: 1,
            exp: 0,
            diamonds: 0,
            growth_points: 0,
            stamina: 5,
            attack: 5,
            defense: 5,
            luck: 5,
            equipped: {
                title: "없음",
                weapon: "없음",
                armor: "없음",
                hat: "없음",
                accessory: "없음",
                relic: "없음",
                skill: "없음"
            }
        };

        // --- Core Functions ---

        /**
         * Renders a specific view and hides all others.
         * @param {string} viewName - The name of the view to show.
         */
        function showView(viewName) {
            loadingSpinner.classList.add('hidden');
            for (const key in views) {
                if (key === viewName) {
                    views[key].classList.remove('hidden');
                } else {
                    views[key].classList.add('hidden');
                }
            }
        }

        /**
         * Shows a custom modal message.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message to display.
         */
        function showMessageModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModalOverlay.classList.remove('hidden');
        }

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initFirebase() {
            try {
                setLogLevel('debug');
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                await signInAnonymously(auth);

                userId = auth.currentUser.uid;
                isAuthReady = true;

                console.log('Firebase initialized. User ID:', userId);

                // Initialize teacher password if it doesn't exist
                const teacherDocRef = doc(db, `artifacts/${appId}/public/data/teachers`, 'teacher_password');
                const teacherDocSnap = await getDoc(teacherDocRef);
                if (!teacherDocSnap.exists()) {
                    await setDoc(teacherDocRef, {
                        password: 'superteacher'
                    });
                }
                
                // Initialize a base quest in the database if it doesn't exist
                const questDocRef = doc(db, `artifacts/${appId}/public/data/quests`, 'daily_diary_quest');
                const questDocSnap = await getDoc(questDocRef);
                if (!questDocSnap.exists()) {
                    await setDoc(questDocRef, {
                        title: "오늘의 성장일지 쓰기",
                        description: "오늘 있었던 나의 성장을 간단히 기록해 보세요.",
                        exp_reward: 20,
                        gp_reward: 0,
                        type: "daily"
                    });
                }

                showView('landing');
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessageModal('오류', '데이터베이스 연결에 실패했습니다. 나중에 다시 시도해주세요.');
            }
        }

        // --- Data Handling ---

        /**
         * Renders the student dashboard with real-time data from Firestore.
         */
        function renderStudentDashboard() {
            if (!userId) {
                showMessageModal('오류', '로그인 정보가 유효하지 않습니다.');
                showView('landing');
                return;
            }

            showView('loading');
            const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);

            onSnapshot(studentDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    showView('dashboard');
                    studentDataCache = docSnap.data();

                    document.getElementById('user-id-display').textContent = userId;

                    document.getElementById('char-name-display').textContent = studentDataCache.character_name;
                    document.getElementById('level-display').textContent = studentDataCache.level;
                    document.getElementById('diamond-display').textContent = studentDataCache.diamonds;
                    document.getElementById('growth-point-display').textContent = studentDataCache.growth_points;

                    const expToNextLevel = 200;
                    const expPercentage = (studentDataCache.exp / expToNextLevel) * 100;
                    document.getElementById('exp-bar').style.width = `${Math.min(expPercentage, 100)}%`;
                    document.getElementById('exp-text-display').textContent = `${studentDataCache.exp}/${expToNextLevel}`;

                    if (studentDataCache.exp >= expToNextLevel) {
                        const newLevel = studentDataCache.level + 1;
                        const newExp = studentDataCache.exp - expToNextLevel;
                        const newGrowthPoints = studentDataCache.growth_points + 5;

                        updateDoc(studentDocRef, {
                            level: newLevel,
                            exp: newExp,
                            growth_points: newGrowthPoints
                        }).then(() => {
                            showMessageModal('레벨업!', `축하합니다! 레벨 ${newLevel}이 되었습니다! 성장 포인트 5점을 얻었습니다.`);
                            logEvent(userId, 'level_up', {
                                newLevel: newLevel
                            });
                        }).catch(error => {
                            console.error("Level up failed:", error);
                        });
                    }

                    const statsContainer = document.getElementById('stats-container');
                    statsContainer.innerHTML = '';
                    const stats = ['stamina', 'attack', 'defense', 'luck'];
                    stats.forEach(stat => {
                        const label = statLabels[stat] || stat; // 매핑 없으면 원래 키 사용
                        const statElement = document.createElement('div');
                        statElement.className = 'flex items-center justify-between';
                        statElement.innerHTML = `
                        <span class="text-gray-300 font-semibold">${label}</span>
                        <div class="flex items-center space-x-2">
                        <span id="${stat}-display" class="text-emerald-400 font-bold text-lg">${studentDataCache[stat]}</span>
                        <button data-stat="${stat}" class="stat-plus-btn bg-gray-600 w-8 h-8 rounded-full text-white font-bold text-sm hover:bg-emerald-400 transition-colors">+</button>
                        </div>
                        `;
                        statsContainer.appendChild(statElement);
                    });


                    document.querySelectorAll('.stat-plus-btn').forEach(button => {
                        button.addEventListener('click', handleStatIncrease);
                    });

                    //학생 대시보드 render
                    renderQuest(studentDataCache);
                    renderGrowthLog();
                    renderMyGrowthLogs();
                    listenForRewards();

                } else {
                    console.error("Student data not found for user ID:", userId);
                    showMessageModal('오류', '학생 데이터를 찾을 수 없습니다. 다시 로그인해주세요.');
                    auth.signOut();
                    showView('landing');
                }
            }, (error) => {
                console.error("Failed to fetch student data:", error);
                showMessageModal('오류', '데이터를 불러오는 중 오류가 발생했습니다.');
                auth.signOut();
                showView('landing');
            });
        }
        async function renderMyGrowthLogs() {
            try {
                const growthLogsRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);
                const q = query(
                    growthLogsRef,
                    where("student_id", "==", userId),   // 로그인한 학생 ID
                    orderBy("timestamp", "desc")
                );
                const querySnapshot = await getDocs(q);
                
                const container = document.getElementById("growth-log-container");
                container.innerHTML = ""; // 기존 안내 문구 제거

                if (querySnapshot.empty) {
                    container.innerHTML = '<p class="text-gray-400">아직 작성한 성장일지가 없습니다.</p>';
                } else {
                    querySnapshot.forEach(doc => {
                        const logData = doc.data();
                        const logDate = logData.timestamp?.toDate().toLocaleString("ko-KR") || "날짜 없음";
                        
                        const logElement = document.createElement("div");
                        logElement.classList.add("bg-gray-700", "p-4", "rounded-lg");
                        
                        logElement.innerHTML = `
                        <p class="text-sm text-gray-400 mb-1">날짜: ${logDate}</p>
                        <p class="text-white mb-2">${logData.content}</p>
                        <p class="text-sm text-gray-500">평가: ${logData.evaluation || "아직 없음"}</p>
                        `;
                        
                        container.appendChild(logElement);
                    });
                }
            } catch (error) {
                console.error("내 성장일지 불러오기 실패:", error);
                showMessageModal("오류", "성장일지를 불러오는 데 실패했습니다.");
            }
        }
        
        // 전역
        let unsubscribeGrowthReward = null;
        
        /** 보상 리스너 (best/confirmed만 보며, rewarded=true로 마킹) */
        function listenForRewards() {
            // 이미 구독 중이면 중복 방지
            if (typeof unsubscribeGrowthReward === 'function') return;
            
            const logsRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);
            const q = query(
                logsRef,
                where("student_id", "==", String(userId || "")),   // userId 없으면 빈 결과
                where("status", "in", ["best", "confirmed"])
                // 필요하면 where("rewarded","==",false)도 추가 가능
                );
            
            unsubscribeGrowthReward = onSnapshot(
                q,
                (snap) => {
                    // 인증/아이디 준비 안 됐으면 아무 것도 하지 않음
                    if (!auth.currentUser || !userId) return;
                    
                    snap.docChanges().forEach((chg) => {
                        if (chg.type !== "added" && chg.type !== "modified") return;
                        
                        const sid = String(userId || "");
                        if (!sid) return;
                        
                        const logRef = chg.doc.ref;
                        const studentRef = doc(db, `artifacts/${appId}/public/data/students`, sid);
                        
                        runTransaction(db, async (tx) => {
                            const freshLog = await tx.get(logRef);
                            if (!freshLog.exists()) return;
                            
                            const d = freshLog.data();
                            if (d.rewarded === true) return; // 이미 지급됨
                            
                            const expGain = d.status === "best" ? 30 : 20;
                            const diaGain = 10;
                            
                            const stuSnap = await tx.get(studentRef);
                            if (!stuSnap.exists()) return;
                            
                            tx.update(studentRef, { exp: increment(expGain), diamonds: increment(diaGain) });
                            tx.update(logRef, { rewarded: true, rewardedAt: serverTimestamp() });
                        })
                            .then(() => {
                                const s = chg.doc.data().status;
                                if (s === "best") {
                                    showMessageModal("축하합니다!", "성장일지 '최고' 보상으로 경험치 30, 다이아 10을 받았습니다.");
                                } else if (s === "confirmed") {
                                    showMessageModal("확인됨", "성장일지 '확인' 보상으로 경험치 20, 다이아 10을 받았습니다.");
                                }
                            })
                            .catch((err) => {
                                console.error("Failed to apply reward (tx):", err);
                            });
                    });
                },
                (err) => {
                    console.error("growth reward listener error:", err);
                }
            );
        }
        
        /**
         * Renders the teacher dashboard with real-time data from Firestore.
         */
        async function renderTeacherDashboard() {
            showView('loading');

            const pendingListContainer = document.getElementById('pending-students-list');
            const registerRef = collection(db, `artifacts/${appId}/public/data/register`);
            const qStudents = query(registerRef, where("status", "==", "대기중"));
            onSnapshot(qStudents, (snapshot) => {
                pendingListContainer.innerHTML = '';
                if (snapshot.empty) {
                    pendingListContainer.innerHTML = '<p class="text-gray-400 text-center">미승인 학생이 없습니다.</p>';
                } else {
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const docId = doc.id;
                        const card = document.createElement('div');
                        card.className = 'bg-gray-800 rounded-2xl p-4 shadow-md flex items-center justify-between';
                        card.innerHTML = `
                            <div>
                                <h4 class="text-lg font-semibold">${data.name} (${data.id})</h4>
                                <p class="text-gray-400 text-sm">학년: ${data.grade}반: ${data.class} 번호: ${data.number}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button data-action="approve" data-id="${docId}" class="approve-btn px-4 py-2 rounded-lg text-white font-semibold bg-green-500 hover:bg-green-600 transition-colors">승인</button>
                                <button data-action="reject" data-id="${docId}" class="reject-btn px-4 py-2 rounded-lg text-white font-semibold bg-red-500 hover:bg-red-600 transition-colors">거절</button>
                            </div>
                        `;
                        pendingListContainer.appendChild(card);
                    });
                    document.querySelectorAll('.approve-btn').forEach(btn => {
                        btn.addEventListener('click', handleApproveRequest);
                    });
                    document.querySelectorAll('.reject-btn').forEach(btn => {
                        btn.addEventListener('click', handleApproveRequest);
                    });
                }
            });

            const pendingLogsContainer = document.getElementById('pending-growth-logs-list');
            const logsRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);
            const qLogs = query(logsRef, where("status", "==", "pending"));
            
            showView('teacherDashboard');
        }

        /**
        * Renders assigned quests (with complete button) and completed quests (accordion + 3 at a time "더보기").
        * @param {Object} studentData - The student's data from Firestore.
        */
        // ✅ 동시 렌더 방지용 전역 시퀀스
        window.__questRenderSeq = (window.__questRenderSeq || 0);
        async function renderQuest(studentData) {
            const mySeq = ++window.__questRenderSeq;
            const dailyQuestContainer = document.getElementById('daily-quest-container');
            const completedQuestsContainer = document.getElementById('completed-quests-container');
            
            dailyQuestContainer.innerHTML = '';
            completedQuestsContainer.innerHTML = '';
            
            const questsRef = collection(db, `artifacts/${appId}/public/data/quests`);
            
            // 1) 현재 부여된 퀘스트
            try {
                const qAssigned = query(questsRef, where("assigned_students", "array-contains", userId));
                const assignedSnap = await getDocs(qAssigned);
                // ✅ 더 새로운 렌더가 시작되었으면 즉시 중단
                if (mySeq !== window.__questRenderSeq) return;
                
                if (assignedSnap.empty) {
                    const noAssigned = document.createElement('p');
                    noAssigned.className = 'text-gray-400 mb-4';
                    noAssigned.textContent = '현재 부여된 퀘스트가 없습니다.';
                    dailyQuestContainer.appendChild(noAssigned);
                } else {                 
                    assignedSnap.forEach(docSnap => {
                        const qd = docSnap.data();
                        const questId = docSnap.id;
                        const rewards = qd.rewards || {};
                        const expReward = rewards.exp || 0;
                        const diaReward = rewards.dia || 0;
                        const growthReward = rewards.growth || 0;
                        
                        const isCompleted = !!studentData.quests?.[questId]?.completed_at;
                        
                        if (!isCompleted) {
                            const card = document.createElement('div');
                            card.className = 'bg-gray-700 rounded-lg p-4 space-y-2 mb-3';
                            card.innerHTML = `
                            <h5 class="text-white font-semibold">${qd.name || '(제목 없음)'}</h5>
                            <p class="text-gray-300 text-sm">${qd.description || ''}</p>
                            <p class="text-gray-400 text-xs">보상: 경험치 ${expReward} · 다이아 ${diaReward} · 성장포인트 ${growthReward}</p>
                            <button class="complete-quest-btn w-full mt-2 px-3 py-1 bg-emerald-500 text-white rounded"
                            data-quest-id="${questId}">
                            퀘스트 완료
                            </button>
                            `;
                            dailyQuestContainer.appendChild(card);
                            
                            // 완료 버튼 이벤트
                            card.querySelector('.complete-quest-btn').addEventListener('click', async () => {
                                const btnEl = card.querySelector('.complete-quest-btn');
                                btnEl.disabled = true; btnEl.textContent = '처리 중...';
                                if (mySeq !== window.__questRenderSeq) return;
                                const studentRef = doc(db, `artifacts/${appId}/public/data/students`, userId);
                                
                                await updateDoc(studentRef, {
                                    [`quests.${questId}`]: {
                                        completed_at: serverTimestamp(),
                                        description: qd.description || '',
                                        rewards: { exp: expReward, dia: diaReward, growth: growthReward }
                                    },
                                    exp: increment(expReward),
                                    diamonds: increment(diaReward),
                                    growth_points: increment(growthReward)
                                });
                                
                                showMessageModal('완료', `${qd.name || '퀘스트'}를 완료했습니다!`);
                                // ✅ 화면 갱신은 학생 onSnapshot에서 자동 반영됨
                                btnEl.disabled = false; btnEl.textContent = '퀘스트 완료';
                            });
                        }
                    });
                }
            } catch (err) {
                console.error('부여된 퀘스트 불러오기 실패:', err);
                const errorMsg = document.createElement('p');
                errorMsg.className = 'text-red-400';
                errorMsg.textContent = '부여된 퀘스트를 불러오는 중 오류가 발생했습니다.';
                dailyQuestContainer.appendChild(errorMsg);
            }
            
            // 2) 완료한 퀘스트 (최근 3개, 아코디언, 더보기)
            const questsObj = studentData.quests || {};
            let completedQuests = Object.entries(questsObj).filter(([_, v]) => v?.completed_at);
            if (completedQuests.length === 0) {
                completedQuestsContainer.innerHTML = '<p class="text-gray-400">아직 완료한 퀘스트가 없습니다.</p>';
                return;
            }
            
            completedQuests.sort((a, b) => b[1].completed_at.toDate() - a[1].completed_at.toDate());
            
            let visibleCount = 3;
            async function renderCompleted(list, count) {
                completedQuestsContainer.innerHTML = '';
                // ✅ 더 새로운 렌더가 시작되었으면 이 렌더 중단
                const localSeq = mySeq;
                const stillMine = () => localSeq === window.__questRenderSeq;
                
                // 화면에 보여줄 범위의 완료 퀘스트만 선택
                const slice = list.slice(0, count);
                
                for (const [qid, value] of slice) {
                    // 퀘스트 제목 조회 (name 필드). 실패 시 fallback으로 qid 표시
                    let questName = qid;
                    try {
                        const questRef = doc(db, `artifacts/${appId}/public/data/quests`, qid);
                        const questSnap = await getDoc(questRef);
                        if (!stillMine()) return;
                        if (questSnap.exists()) {
                            const qd = questSnap.data();
                            questName = qd?.name || qid;
                        }
                    } catch (e) {
                        console.error('퀘스트 제목 불러오기 실패:', e);
                    }
                    
                    const rewards = value.rewards || {};
                    const date = value.completed_at.toDate().toLocaleString();
                    
                    const wrapper = document.createElement('div');
                    wrapper.className = 'bg-gray-700 rounded mb-2';
                    
                    const header = document.createElement('div');
                    header.className = 'flex justify-between items-center p-2';
                    header.innerHTML = `
                    <span class="text-gray-300 font-semibold">${questName}</span>
                    <button class="toggle-detail px-2 py-1 bg-blue-500 text-white rounded text-sm">보기</button>
                    `;
                    
                    const detail = document.createElement('div');
                    detail.className = 'hidden px-3 pb-3 text-sm text-gray-300';
                    detail.innerHTML = `
                    <p class="mb-1">설명: ${value.description || ''}</p>
                    <p class="mb-1">보상: 경험치 ${rewards.exp || 0}, 다이아 ${rewards.dia || 0}, 성장포인트 ${rewards.growth || 0}</p>
                    <p class="text-xs text-gray-400">완료일: ${date}</p>
                    `;
                    if (!stillMine()) return;
                    
                    header.querySelector('.toggle-detail').addEventListener('click', () => {
                        detail.classList.toggle('hidden');
                    });
                    
                    wrapper.appendChild(header);
                    wrapper.appendChild(detail);
                    completedQuestsContainer.appendChild(wrapper);
                }
                
                if (list.length > count) {
                    const moreBtn = document.createElement('button');
                    moreBtn.className = 'w-full mt-2 px-3 py-1 bg-gray-600 text-white rounded';
                    moreBtn.textContent = '더보기';
                    moreBtn.addEventListener('click', () => {
                        visibleCount += 3;
                        renderCompleted(list, visibleCount);
                    });
                    completedQuestsContainer.appendChild(moreBtn);
                }
            }
            
            // 최초 렌더 호출
            renderCompleted(completedQuests, visibleCount);
        }
        
        /**
        * Renders the student's growth log history.
        */
        function renderGrowthLog() {
            const logContainer = document.getElementById('growth-log-container');
            const logCollectionRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);

            // NOTE: Firestore requires a composite index for this query.
            // If you get a "The query requires an index" error, follow the link in the console
            // to create the index. It is a one-time setup for your database.
            const q = query(logCollectionRef,
                where("student_id", "==", userId),
                orderBy('timestamp', 'desc'), limit(50));

            onSnapshot(q, (snapshot) => {
                logContainer.innerHTML = '';
                if (snapshot.empty) {
                    logContainer.innerHTML = '<p class="text-gray-400">성장 기록이 없습니다. 모험을 시작해 보세요!</p>';
                } else {
                    snapshot.forEach(doc => {
                        const logData = doc.data();
                        const logEntry = document.createElement('div');
                        logEntry.className = 'bg-gray-700 rounded-lg p-3 shadow-sm';

                        const timestamp = logData.timestamp?.toMillis ? logData.timestamp.toMillis() : logData.timestamp;
                        if (!timestamp) return;

                        const date = new Date(timestamp);
                        const formattedTime = date.toLocaleTimeString('ko-KR', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const formattedDate = date.toLocaleDateString('ko-KR');

                        let statusBadge = '';
                        let contentColorClass = 'text-gray-300';

                        if (logData.status === 'approved') {
                            statusBadge = `<span class="bg-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-full">최고</span>`;
                        } else if (logData.status === 'rejected') {
                            statusBadge = `<span class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">확인</span>`;
                        } else {
                            statusBadge = `<span class="bg-yellow-500 text-white text-xs font-bold px-2 py-1 rounded-full">대기 중</span>`;
                        }

                        logEntry.innerHTML = `
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm text-gray-400">${formattedDate}</p>
                                ${statusBadge}
                            </div>
                            <p class="${contentColorClass}">${logData.content}</p>
                        `;
                        logContainer.appendChild(logEntry);
                    });
                }
            }, (error) => {
                console.error("Failed to fetch growth log:", error);
                logContainer.innerHTML = '<p class="text-red-400">성장 기록을 불러오는 중 오류가 발생했습니다.</p>';
            });
        }
        
        /**
         * Logs an event to the student's growth log.
         * @param {string} studentId - The ID of the student.
         * @param {string} eventType - The type of event.
         * @param {object} details - Details of the event.
         */
        async function logEvent(studentId, eventType, details) {
            if (!studentId) return;
            try {
                const logCollectionRef = collection(db, `artifacts/${appId}/public/data/students/${studentId}/log`);
                await addDoc(logCollectionRef, {
                    event_type: eventType,
                    details: details || {},   // ✅ undefined면 빈 객체로 저장
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Failed to log event:", error);
            }
        }

        /**
         * Handles quest completion and awards the user.
         */
        async function handleQuestCompletion(e) {
            if (!userId) {
                showMessageModal('오류', '로그인 정보가 유효하지 않습니다.');
                return;
            }
            const questId = e.target.dataset.questId;

            const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);
            const questDocRef = doc(db, `artifacts/${appId}/public/data/quests`, questId);
            
            const [studentDocSnap, questDocSnap] = await Promise.all([
                getDoc(studentDocRef),
                getDoc(questDocRef)
            ]);

            if (!studentDocSnap.exists() || !questDocSnap.exists()) {
                showMessageModal('오류', '사용자 또는 퀘스트 데이터를 찾을 수 없습니다.');
                return;
            }

            const studentData = studentDocSnap.data();
            const questData = questDocSnap.data();
            
            const questCompletedAt = studentData.quests?.[questId]?.completed_at;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            if (questCompletedAt && questCompletedAt.toDate() >= today) {
                showMessageModal('퀘스트 완료', '오늘의 퀘스트는 이미 완료했습니다.');
                return;
            }

            const expGain = questData.exp_reward;
            const growthPointGain = questData.gp_reward;
            const newExp = (studentData.exp || 0) + expGain;
            const newGrowthPoints = (studentData.growth_points || 0) + growthPointGain;

            try {
                await updateDoc(studentDocRef, {
                    exp: newExp,
                    growth_points: newGrowthPoints,
                    [`quests.${questId}.completed_at`]: serverTimestamp()
                });
                showMessageModal('퀘스트 성공', '오늘의 퀘스트를 완료하고 보상을 받았습니다!');
                logEvent(userId, 'quest_complete', {
                    quest_name: questData.title,
                    exp_gain: expGain,
                    growth_point_gain: growthPointGain
                });
            } catch (error) {
                console.error("Quest completion failed:", error);
                showMessageModal('오류', '퀘스트 완료 중 오류가 발생했습니다.');
            }
        }
        
        // 함수 상단(또는 파일 상단)에 보조 함수 2개 추가
        function makeSafeName(name){
            // 슬래시 등 금지문자 제거 & 한글/영문/숫자/밑줄/대시는 허용
            return (name || '').trim()
                .replace(/[\/]+/g, '-')               // 슬래시는 대시로
                .replace(/[^\p{L}\p{N}_-]+/gu, '_')   // 나머지는 언더스코어
            || 'unknown';
        }
        function formatDateId(d){
            const p = n => String(n).padStart(2,'0');
            return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`;
        }
        
        /**
         * Handles the growth log submission button click.
         */
        async function handleGrowthLogSubmission(e) {
            e.preventDefault();
            const logText = document.getElementById('growth-log-text').value.trim();
            const submitButton = e.target.querySelector('button[type="submit"]');

            if (!logText) {
                showMessageModal('오류', '내용을 입력해 주세요.');
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> 전송 중...`;

            try {
                if (!userId) {
                    showMessageModal('오류', '로그인 정보가 유효하지 않습니다.');
                    return;
                }

                const logsCollectionRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);
                const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);
                const studentDoc = await getDoc(studentDocRef);

                if (!studentDoc.exists()) {
                    showMessageModal('오류', '사용자 정보를 찾을 수 없습니다.');
                    return;
                }
                const studentData = studentDoc.data();

                // Check if a log has already been submitted today
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                const q = query(logsCollectionRef,
                    where("student_id", "==", userId),
                    where("timestamp", ">=", todayStart)
                );
                const existingLogs = await getDocs(q);

                if (!existingLogs.empty) {
                    showMessageModal('제출 실패', '오늘은 이미 성장일지를 제출했습니다.');
                    return;
                }
                
                // 문서 ID: "이름_YYYYMMDD_HHmmss"
                const docId = `${makeSafeName(studentData.name)}_${formatDateId(new Date())}`;
                const logRef = doc(logsCollectionRef, docId);
                
                await setDoc(logRef, {
                    student_id: userId,
                    student_name: studentData.name,
                    content: logText,
                    status: 'pending',
                    rewarded: false, // 보상 여부 플래그
                    timestamp: serverTimestamp()
                });

                document.getElementById('growth-log-text').value = '';
                showMessageModal('전송 완료', '성장일지가 교사에게 전송되었습니다. 승인을 기다려 주세요!');
            } catch (error) {
                console.error("Growth log submission failed:", error);
                showMessageModal('오류', `성장일지 전송 중 오류가 발생했습니다: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = `기록 전송`;
            }
        }

        /**
        * Handles teacher approval of a growth log.
        * @param {Event} e - Click event.
        */
        async function handleGrowthLogApproval(e) {
            // 버튼에서 id를 안전하게 가져오기 (data-id 또는 data-log-id 지원)
            const logId = e.target?.dataset?.id || e.target?.getAttribute('data-log-id');
            if (!logId) {
                console.warn('handleGrowthLogApproval: missing logId on clicked element');
                showMessageModal('오류', '성장일지 ID를 찾을 수 없습니다.');
                return;
            }
            
            try {
                const logDocRef = doc(db, `artifacts/${appId}/public/data/growth_logs`, logId);
                const logDocSnap = await getDoc(logDocRef);
                if (!logDocSnap.exists()) {
                    showMessageModal('오류', '성장일지 정보를 찾을 수 없습니다.');
                    return;
                }
                
                // 평가 결과 저장 (status + evaluation)
                await updateDoc(logDocRef, { status: 'best', evaluation: '최고' });
                showMessageModal('평가 완료', "성장일지를 '최고'로 평가했습니다.");
                
                // 필요 시 목록 새로고침이 있다면 여기서 호출
                // renderUnverifiedLogs?.();
            } catch (error) {
                console.error("Growth log approval failed:", error);
                showMessageModal('오류', '승인 처리 중 오류가 발생했습니다.');
            }
        }
        
        /**
        * Handles teacher rejection/confirmation of a growth log.
        * @param {Event} e - Click event.
        */
        async function handleGrowthLogRejection(e) {
            // 버튼에서 id를 안전하게 가져오기 (data-id 또는 data-log-id 지원)
            const logId = e.target?.dataset?.id || e.target?.getAttribute('data-log-id');
            if (!logId) {
                console.warn('handleGrowthLogRejection: missing logId on clicked element');
                showMessageModal('오류', '성장일지 ID를 찾을 수 없습니다.');
                return;
            }
            
            try {
                const logDocRef = doc(db, `artifacts/${appId}/public/data/growth_logs`, logId);
                const logDocSnap = await getDoc(logDocRef);
                if (!logDocSnap.exists()) {
                    showMessageModal('오류', '성장일지 정보를 찾을 수 없습니다.');
                    return;
                }
                
                // 평가 결과 저장 (status + evaluation)
                await updateDoc(logDocRef, { status: 'confirmed', evaluation: '확인' });
                showMessageModal('평가 완료', "성장일지를 '확인'으로 평가했습니다.");
                
                // 필요 시 목록 새로고침이 있다면 여기서 호출
                // renderUnverifiedLogs?.();
            } catch (error) {
                console.error("Growth log rejection failed:", error);
                showMessageModal('오류', '확인 처리 중 오류가 발생했습니다.');
            }
        }

        /**
         * Handles the stat increase button click.
         * @param {Event} event - The click event object.
         */
        async function handleStatIncrease(event) {
            const stat = event.target.dataset.stat;
            const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);
            const docSnap = await getDoc(studentDocRef);

            if (docSnap.exists()) {
                const studentData = docSnap.data();
                if (studentData.growth_points > 0) {
                    const newValue = (studentData[stat] || 0) + 1;
                    const newGrowthPoints = studentData.growth_points - 1;

                    await updateDoc(studentDocRef, {
                        [stat]: newValue,
                        growth_points: newGrowthPoints
                    });

                    showMessageModal('능력치 상승', `${stat} 능력치가 ${newValue} (으)로 상승했습니다.`);
                    logEvent(userId, 'stat_increase', {
                        stat_name: stat,
                        new_value: newValue
                    });
                } else {
                    showMessageModal('포인트 부족', '성장 포인트가 부족합니다.');
                }
            }
        }

        /**
         * Approves or rejects a registration request.
         * @param {Event} event - The click event object.
         */
        async function handleApproveRequest(event) {
            const docId = event.target.dataset.id;
            const action = event.target.dataset.action;
            try {
                const registerDocRef = doc(db, `artifacts/${appId}/public/data/register`, docId);
                const registerDocSnap = await getDoc(registerDocRef);
                
                if (!registerDocSnap.exists()) {
                    showMessageModal('오류', '신청 정보를 찾을 수 없습니다.');
                    return;
                }
                const studentData = registerDocSnap.data();
                
                if (action === 'approve') {
                    // register 문서에 저장된 학생 입력 아이디를 문서 ID로 사용
                    const studentIdFromForm = studentData.id; // 예: "s2025_01_01"

                    // students/{학생아이디} 형태로 문서 생성
                    const studentsDocRef = doc(db, `artifacts/${appId}/public/data/students`, studentIdFromForm);

                    await setDoc(studentsDocRef, {
                        ...studentData,
                        ...initialStats,
                        approvedBy: userId,
                        createdAt: serverTimestamp()
                    });
                    
                    // ✅ register 문서 삭제 (status 업데이트 대신)
                    await deleteDoc(registerDocRef);
                    
                    showMessageModal('승인 완료', `${studentData.name} 학생이 성공적으로 승인되었습니다!`);
                } else if (action === 'reject') {
                    await deleteDoc(registerDocRef);
                    showMessageModal('거절 완료', `${studentData.name} 학생의 가입이 거절되었습니다.`);
                }
            } catch (error) {
                console.error("Approval/Rejection failed:", error);
                showMessageModal('오류', '학생 승인/거절 중 오류가 발생했습니다.');
            }
        }

        /**
         * Saves the updated stats to Firestore.
         */
        async function saveStats() {
            if (!userId) {
                showMessageModal('오류', '로그인 정보가 유효하지 않습니다.');
                return;
            }
            try {
                const statElements = document.getElementById('stats-container').querySelectorAll('span');
                const updatedStats = {};
                statElements.forEach(el => {
                    const id = el.id;
                    if (id.includes('-display')) {
                        const statName = id.replace('-display', '');
                        updatedStats[statName] = parseInt(el.textContent, 10);
                    }
                });

                const growthPoints = parseInt(document.getElementById('growth-point-display').textContent, 10);
                const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);
                await updateDoc(studentDocRef, {
                    ...updatedStats,
                    growth_points: growthPoints
                });
                showMessageModal('저장 완료', '능력치가 성공적으로 저장되었습니다.');
                logEvent(userId, 'stat_save', {
                    message: '능력치 변경사항을 저장했습니다.'
                });
            } catch (error) {
                console.error("Failed to save stats:", error);
                showMessageModal('저장 오류', '능력치 저장에 실패했습니다. 다시 시도해주세요.');
            }
        }

        /**
         * Handles teacher code change.
         */
        async function handleTeacherCodeChange(e) {
            e.preventDefault();
            const newCode = newTeacherCodeInput.value.trim();

            if (!newCode || newCode.length < 4) {
                showMessageModal('오류', '새로운 교사 코드는 4자 이상이어야 합니다.');
                return;
            }

            try {
                const teacherDocRef = doc(db, `artifacts/${appId}/public/data/teachers`, 'teacher_password');
                await updateDoc(teacherDocRef, {
                    password: newCode
                });
                teacherCodeModalOverlay.classList.add('hidden');
                showMessageModal('변경 완료', '교사 로그인 코드가 성공적으로 변경되었습니다!');
            } catch (error) {
                console.error("Teacher code change failed:", error);
                showMessageModal('오류', '교사 코드 변경 중 오류가 발생했습니다.');
            }
        }

        // --- Event Listeners ---

        window.addEventListener('load', initFirebase);
        modalCloseBtn.addEventListener('click', () => {
            messageModalOverlay.classList.add('hidden');
        });

        // Landing view buttons
        showStudentLoginBtn.addEventListener('click', () => showView('studentLogin'));
        showRegisterBtn.addEventListener('click', () => showView('register'));
        showTeacherLoginBtn.addEventListener('click', () => showView('teacherLogin'));

        // Navigation buttons
        backToLandingFromLoginBtn.addEventListener('click', () => showView('landing'));
        backToLandingFromRegisterBtn.addEventListener('click', () => showView('landing'));
        backToLandingFromTeacherBtn.addEventListener('click', () => showView('landing'));

        // Student Tab buttons
        tabInfoBtn.addEventListener('click', () => {
            document.querySelectorAll('#dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            userInfoSection.classList.remove('hidden');
            document.querySelectorAll('#student-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            tabInfoBtn.classList.remove('border-transparent', 'text-gray-400');
            tabInfoBtn.classList.add('border-emerald-400', 'text-emerald-400');
        });
        tabQuestBtn.addEventListener('click', () => {
            document.querySelectorAll('#dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            questSection.classList.remove('hidden');
            document.querySelectorAll('#student-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            tabQuestBtn.classList.remove('border-transparent', 'text-gray-400');
            tabQuestBtn.classList.add('border-emerald-400', 'text-emerald-400');
            renderQuest(studentDataCache);
        });
        tabLogBtn.addEventListener('click', () => {
            document.querySelectorAll('#dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            logSection.classList.remove('hidden');
            document.querySelectorAll('#student-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            tabLogBtn.classList.remove('border-transparent', 'text-gray-400');
            tabLogBtn.classList.add('border-emerald-400', 'text-emerald-400');
            renderGrowthLog();
            renderMyGrowthLogs();
        });
        tabShopBtn.addEventListener('click', () => {
            document.querySelectorAll('#dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            shopSection.classList.remove('hidden');
            document.querySelectorAll('#student-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            tabShopBtn.classList.remove('border-transparent', 'text-gray-400');
            tabShopBtn.classList.add('border-emerald-400', 'text-emerald-400');
        });

        // Teacher Tab buttons
        teacherTabPendingStudentsBtn.addEventListener('click', () => {
            document.querySelectorAll('#teacher-dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            teacherPendingStudentsSection.classList.remove('hidden');
            document.querySelectorAll('#teacher-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            teacherTabPendingStudentsBtn.classList.remove('border-transparent', 'text-gray-400');
            teacherTabPendingStudentsBtn.classList.add('border-emerald-400', 'text-emerald-400');
        });
        
        // '성장일지 관리' 탭 전환 로직
        const teacherTabGrowthLogBtn = document.getElementById('teacherTabGrowthLogBtn');
        const growthLogManagementTab = document.getElementById('growth-log-management-tab');
        
        teacherTabGrowthLogBtn.addEventListener('click', () => {
            // 모든 탭 숨기기
            document.querySelectorAll('#teacher-dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            
            // 성장일지 탭 보이기
            growthLogManagementTab.classList.remove('hidden');
            
            // 모든 탭 버튼 비활성화
            document.querySelectorAll('#teacher-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            
            // 현재 탭 버튼 활성화
            teacherTabGrowthLogBtn.classList.remove('border-transparent', 'text-gray-400');
            teacherTabGrowthLogBtn.classList.add('border-emerald-400', 'text-emerald-400');

            // 학생 목록 불러오기 함수 호출
            renderStudentList();
        });

        // Forms
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentIdInput = document.getElementById('student-id-input').value;
            const studentPasswordInput = document.getElementById('student-password-input').value;
            showView('loading');

            try {
                const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, studentIdInput);
                const docSnap = await getDoc(studentDocRef);

                // 입력된 비밀번호를 해시하여 Firestore에 저장된 해시값과 비교
                const hashedPassword = sha256(studentPasswordInput);

                if (docSnap.exists() && docSnap.data().password === hashedPassword) {
                    const userCredential = await signInAnonymously(auth);
                    const user = userCredential.user;

                    await setDoc(doc(db, `artifacts/${appId}/public/data/users`, user.uid), {
                        studentId: studentIdInput,
                        role: 'student'
                    });

                    userId = studentIdInput;
                    renderStudentDashboard();
                    logEvent(userId, 'student_login');
                } else {
                    showMessageModal('로그인 실패', '아이디 또는 비밀번호가 올바르지 않습니다.');
                    showView('studentLogin');
                }
            } catch (error) {
                console.error("Student login failed:", error);
                showMessageModal('로그인 실패', '오류가 발생했습니다. 다시 시도해주세요.');
                showView('studentLogin');
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('register-id').value;
            const password = document.getElementById('register-password').value;
            const name = document.getElementById('register-name').value;
            const grade = parseInt(document.getElementById('register-grade').value);
            const studentClass = parseInt(document.getElementById('register-class').value);
            const number = parseInt(document.getElementById('register-number').value);
            const charName = document.getElementById('register-char-name').value;

            if (password.length < 4) {
                showMessageModal('회원가입 오류', '비밀번호는 4자 이상이어야 합니다.');
                return;
            }

            try {
                showView('loading');
                const registerRef = collection(db, `artifacts/${appId}/public/data/register`);
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                const qRegister = query(registerRef, where("id", "==", id));
                const qStudents = query(studentsRef, where("id", "==", id));

                const registerSnapshot = await getDocs(qRegister);
                const studentsSnapshot = await getDocs(qStudents);

                if (!registerSnapshot.empty || !studentsSnapshot.empty) {
                    showMessageModal('회원가입 오류', '이미 존재하는 아이디입니다. 다른 아이디를 사용해주세요.');
                    showView('register');
                    return;
                }

                // 비밀번호를 SHA-256으로 해시하여 보안 강화
                const hashedPassword = sha256(password);
                
                await setDoc(doc(db, `artifacts/${appId}/public/data/register`, id), {
                    id: id,
                    password: hashedPassword,
                    name: name,
                    grade: grade,
                    class: studentClass,
                    number: number,
                    character_name: charName,
                    status: '대기중',
                    quests: {},
                    createdAt: serverTimestamp()
                });

                showMessageModal('가입 신청 완료', '가입 신청이 완료되었습니다. 교사의 승인을 기다려 주세요!');
                showView('landing');
            } catch (error) {
                console.error("Registration failed:", error);
                showMessageModal('회원가입 오류', '회원가입 중 오류가 발생했습니다. 다시 시도해주세요.');
                showView('register');
            }
        });

        teacherLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const teacherCode = document.getElementById('teacher-code-input').value;
            const teacherDocRef = doc(db, `artifacts/${appId}/public/data/teachers`, 'teacher_password');
            const docSnap = await getDoc(teacherDocRef);

            if (docSnap.exists() && docSnap.data().password === teacherCode) {
                renderTeacherDashboard();
            } else {
                showMessageModal('로그인 실패', '교사 코드가 올바르지 않습니다.');
                showView('teacherLogin');
            }
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut();
            showView('landing');
            userId = null;
            studentDataCache = null;
        });

        teacherLogoutBtn.addEventListener('click', () => {
            auth.signOut();
            showView('landing');
        });
        
        // Teacher code change modal buttons
        changeTeacherCodeBtn.addEventListener('click', () => {
            teacherCodeModalOverlay.classList.remove('hidden');
        });
        cancelTeacherCodeChangeBtn.addEventListener('click', () => {
            teacherCodeModalOverlay.classList.add('hidden');
        });
        teacherCodeChangeForm.addEventListener('submit', handleTeacherCodeChange);

        // Student Dashboard Actions
        saveStatsBtn.addEventListener('click', saveStats);
        document.getElementById('growth-log-form').addEventListener('submit', handleGrowthLogSubmission);

        // 탭 요소 선택
        const unverifiedLogsTabBtn = document.getElementById('unverified-logs-tab-btn');
        const allLogsTabBtn = document.getElementById('all-logs-tab-btn');
        const unverifiedLogsSection = document.getElementById('unverified-logs-section');
        const allLogsSection = document.getElementById('all-logs-section');
        const unverifiedLogList = document.getElementById('unverified-log-list');
        
        // 기존 성장일지 관리 변수 재정의
        const studentListContainer = document.getElementById('student-list');
        const growthLogContainer = document.getElementById('teacher-growth-log-container');
        const selectedStudentName = document.getElementById('selected-student-name');
        const growthLogList = document.getElementById('growth-log-list');

        // ----- 미확인 성장일지 실시간 구독 -----
        let unsubscribePending = null;
        
        // 미확인 성장일지 불러오기 및 렌더링
        async function renderUnverifiedLogs() {
            try {
                if (!unverifiedLogList) return;
                unverifiedLogList.innerHTML = '<p class="text-gray-400">불러오는 중...</p>';
                
                const logsRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);
                const q = query(
                    logsRef,
                    where("status", "==", "pending"),
                    orderBy("timestamp", "desc") // 인덱스 에러 나면 이 줄만 잠시 제거
                    );
                
                // 이전 구독이 있으면 해제(중복 방지)
                if (typeof unsubscribePending === 'function') {
                    unsubscribePending();
                    unsubscribePending = null;
                }
                
                // 실시간 구독으로 즉시/자동 반영
                unsubscribePending = onSnapshot(q, (querySnapshot) => {
                    unverifiedLogList.innerHTML = '';
                    if (querySnapshot.empty) {
                        unverifiedLogList.innerHTML = '<p class="text-gray-400">미확인된 성장일지가 없습니다.</p>';
                        return;
                    }
                    
                    querySnapshot.forEach((docSnap) => {
                        const logData = docSnap.data();
                        const logDate = logData.timestamp?.toDate
                            ? logData.timestamp.toDate().toLocaleDateString('ko-KR')
                            : '날짜 없음';
                        
                        const el = document.createElement('div');
                        el.classList.add('bg-gray-900','p-4','rounded-lg','shadow-inner','mb-2','relative');
                        el.innerHTML = `
                        <p class="text-sm text-gray-400 mb-1">날짜: ${logDate}</p>
                        <p class="text-white mb-2">${(logData.content || '').replace(/\n/g,'<br>')}</p>
                        <div class="mt-4 flex gap-2">
                        <button class="btn-primary text-sm px-3 py-1 rounded-full approve-btn" data-log-id="${docSnap.id}">최고</button>
                        <button class="btn-secondary text-sm px-3 py-1 rounded-full check-btn" data-log-id="${docSnap.id}">확인</button>
                        </div>
                        `;
                        unverifiedLogList.appendChild(el);
                    });
                }, (error) => {
                    console.error("미확인 성장일지 구독 실패:", error);
                    unverifiedLogList.innerHTML = '<p class="text-red-400">목록을 불러오지 못했습니다.</p>';
                });
                
            } catch (error) {
                console.error("미확인 성장일지 불러오기 실패:", error);
                showMessageModal('오류', '미확인 성장일지를 불러오는 데 실패했습니다.');
            }
        }
        
        
        // 전체 성장일지 (학생 목록) 불러오기
        async function renderStudentList() {
            try {
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                const q = query(studentsRef, orderBy("number", "asc"));
                const querySnapshot = await getDocs(q);
        
                studentListContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    studentListContainer.innerHTML = '<p class="text-gray-400">등록된 학생이 없습니다.</p>';
                } else {
                    querySnapshot.forEach(doc => {
                        const studentData = doc.data();
                        const studentButton = document.createElement('button');
                        studentButton.textContent = `${studentData.name} (${studentData.id})`;
                        studentButton.classList.add('bg-gray-600', 'hover:bg-gray-500', 'text-white', 'py-2', 'px-4', 'rounded-full', 'transition-colors');
                        studentButton.setAttribute('data-student-id', studentData.id);
                        studentListContainer.appendChild(studentButton);
                    });
                }
            } catch (error) {
                console.error("학생 목록 불러오기 실패:", error);
                showMessageModal('오류', '학생 목록을 불러오는 데 실패했습니다.');
            }
        }
        
        function handleStudentListClick(e) {
            const studentBtn = e.target.closest('button.student-item');
            if (studentBtn) {
                const studentId = studentBtn.getAttribute('data-student-id');
                const studentName = studentBtn.getAttribute('data-student-name');
                renderGrowthLogsWithEvaluation(studentId, studentName);
            }
        }
        
        // 특정 학생의 성장일지 목록 불러오기 (평가 버튼 조건부 표시)
        async function renderGrowthLogsWithEvaluation(studentId, studentName) {
            try {
                const growthLogsRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);
                const q = query(growthLogsRef, where("student_id", "==", studentId), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
        
                selectedStudentName.textContent = `${studentName} 학생의 성장일지`;
                growthLogList.innerHTML = '';
                growthLogContainer.classList.remove('hidden');
        
                if (querySnapshot.empty) {
                    growthLogList.innerHTML = '<p class="text-gray-400">제출된 성장일지가 없습니다.</p>';
                } else {
                    querySnapshot.forEach(doc => {
                        const logData = doc.data();
                        const logDate = logData.timestamp?.toDate().toLocaleString("ko-KR") || "날짜 없음";
                        const logElement = document.createElement('div');
                        logElement.classList.add('bg-gray-900', 'p-4', 'rounded-lg', 'shadow-inner', 'mb-2', 'relative');
                        
                        let evaluationButtonsHTML = '';
                        if (!logData.evaluation) { // 미평가 상태일 때만 버튼 추가
                            evaluationButtonsHTML = `
                                <div class="mt-4 flex gap-2">
                                    <button class="btn-primary text-sm px-3 py-1 rounded-full approve-btn" data-log-id="${doc.id}">최고</button>
                                    <button class="btn-secondary text-sm px-3 py-1 rounded-full check-btn" data-log-id="${doc.id}">확인</button>
                                </div>
                            `;
                        }
        
                        logElement.innerHTML = `
                            <p class="text-sm text-gray-400 mb-1">날짜: ${logDate}</p>
                            <p class="text-white mb-2">${logData.content}</p>
                            <div class="mt-2">
                                <span class="text-sm text-gray-500 mr-2">평가 상태: </span>
                                <span class="text-sm font-bold">${logData.evaluation ? logData.evaluation : '미평가'}</span>
                            </div>
                            ${evaluationButtonsHTML}
                        `;
                        growthLogList.appendChild(logElement);
                    });
                }
            } catch (error) {
                console.error("성장일지 불러오기 실패:", error);
                showMessageModal('오류', '성장일지를 불러오는 데 실패했습니다.');
            }
        }
        
        // 탭 버튼 클릭 이벤트 리스너
        unverifiedLogsTabBtn.addEventListener('click', () => {
            unverifiedLogsSection.classList.remove('hidden');
            allLogsSection.classList.add('hidden');
            unverifiedLogsTabBtn.classList.add('border-green-400', 'text-green-400');
            allLogsTabBtn.classList.remove('border-green-400', 'text-green-400');
            renderUnverifiedLogs();
        });
        
        allLogsTabBtn.addEventListener('click', () => {
            allLogsSection.classList.remove('hidden');
            unverifiedLogsSection.classList.add('hidden');
            allLogsTabBtn.classList.add('border-green-400', 'text-green-400');
            unverifiedLogsTabBtn.classList.remove('border-green-400', 'text-green-400');
            renderStudentList();
        });
        
        // 학생 목록 버튼 클릭 이벤트 리스너
        studentListContainer.addEventListener('click', async (e) => {
            const studentButton = e.target.closest('button');
            if (studentButton) {
                const studentId = studentButton.getAttribute('data-student-id');
                const studentName = studentButton.textContent.split('(')[0].trim();
                await renderGrowthLogsWithEvaluation(studentId, studentName);
            }
        });
        
        // 평가 버튼 클릭 이벤트 리스너 (미확인 탭과 전체 탭에서 모두 사용)
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('.approve-btn, .check-btn');
            if (!btn) return;
            
            const logId = btn.getAttribute('data-log-id');
            if (!logId) return;
            
                const isBest = btn.classList.contains('approve-btn'); // '최고' 버튼인지 확인
                const newStatus = isBest ? 'best' : 'confirmed';
                const evaluationText = isBest ? '최고' : '확인';
            
            try {
                const logRef = doc(db, `artifacts/${appId}/public/data/growth_logs`, logId);
                    // 교사 평가는 상태만 기록하고 보상은 리스너에서 트랜잭션으로 처리
                    await updateDoc(logRef, {
                        status: newStatus,
                        evaluation: evaluationText,
                        rewarded: false
                    });
                
                showMessageModal('평가 완료', `성장일지가 '${evaluationText}'(으)로 평가되었습니다.`);
                
                // 목록 새로고침
                renderUnverifiedLogs();
                if (!allLogsSection.classList.contains('hidden')) {
                    const holder = e.target.closest('[data-student-id]');
                    const studentId = holder?.getAttribute('data-student-id');
                    const studentName = holder?.textContent.split('(')[0].trim();
                    if (studentId && studentName) await renderGrowthLogsWithEvaluation(studentId, studentName);
                }
            } catch (error) {
                console.error("평가 업데이트 실패:", error);
                showMessageModal('오류', '성장일지 평가 중 오류가 발생했습니다.');
            }
        });

        
        // 초기 로딩 시 미확인 성장일지 탭 활성화
        unverifiedLogsTabBtn.click();
        
        // 성장일지 관리 탭 진입 시 학생 목록 렌더링
        // (탭 전환 로직에 이 함수를 호출하는 코드를 추가해야 함)
        // 예: showView('teacherDashboard', 'growth-log-management-tab');
        document.addEventListener('DOMContentLoaded', renderStudentList);
        
        const studentList = document.getElementById('student-list');
        if (studentList) {
            studentList.addEventListener('click', handleStudentListClick);
        }
        
        // 새 탭 요소
        const teacherTabStudentsBtn = document.getElementById('teacher-tab-students');
        const teacherStudentsSection = document.getElementById('teacher-students-section');
        const studentsOverviewList = document.getElementById('students-overview-list');
        
        // 학생 정보 확인 탭 클릭 시
        teacherTabStudentsBtn.addEventListener('click', async () => {
            // 모든 섹션 숨기기
            document.querySelectorAll('#teacher-dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            // 현재 섹션만 표시
            teacherStudentsSection.classList.remove('hidden');
            
            // 탭 버튼 스타일 초기화
            document.querySelectorAll('#teacher-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            // 현재 탭 활성화
            teacherTabStudentsBtn.classList.remove('border-transparent', 'text-gray-400');
            teacherTabStudentsBtn.classList.add('border-emerald-400', 'text-emerald-400');
            
            // 목록 렌더링
            await renderStudentsOverview();
        });
        
        // 학생 목록 렌더링 (학생 정보 확인 탭 전용)
        async function renderStudentsOverview() {
            try {
                studentsOverviewList.innerHTML = '<p class="text-gray-400">불러오는 중...</p>';
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                const q = query(studentsRef, orderBy("number", "asc"));
                const snapshot = await getDocs(q);
                
                studentsOverviewList.innerHTML = '';
                if (snapshot.empty) {
                    studentsOverviewList.innerHTML = '<p class="text-gray-400">등록된 학생이 없습니다.</p>';
                    return;
                }
                
                snapshot.forEach(docSnap => {
                    const s = docSnap.data();
                    const row = document.createElement('div');
                    row.className = 'bg-gray-800 p-3 rounded flex items-center justify-between';
                    row.innerHTML = `
                    <div>
                    <p class="text-white font-semibold">${s.name} <span class="text-gray-400 text-sm">(${s.id || docSnap.id})</span></p>
                    <p class="text-gray-400 text-sm">학년 ${s.grade ?? '-'} · 반 ${s.class ?? '-'} · 번호 ${s.number ?? '-'}</p>
                    </div>
                    <button class="px-3 py-1 rounded bg-emerald-500 text-white text-sm hover:bg-emerald-600"
                    data-student-id="${docSnap.id}">상세 보기</button>
                    `;
                    studentsOverviewList.appendChild(row);
                });
            } catch (err) {
                console.error('학생 목록 불러오기 실패:', err);
                showMessageModal('오류', '학생 목록을 불러오는 데 실패했습니다.');
            }
        }
        
        // 상세 보기 모달 로직
        const studentDetailModal = document.getElementById('student-detail-modal');
        const closeStudentDetailBtn = document.getElementById('close-student-detail');
        
        studentsOverviewList.addEventListener('click', async (e) => {
            const btn = e.target.closest('button[data-student-id]');
            if (!btn) return;
            const sid = btn.getAttribute('data-student-id');
            await openStudentDetail(sid);
        });
        
        closeStudentDetailBtn.addEventListener('click', () => {
            studentDetailModal.classList.add('hidden');
        });
        
        // 현재 선택된 학생 ID 저장용
        let currentStudentId = null;
        
        // 상세 보기 모달 열기
        async function openStudentDetail(studentId) {
            try {
                const studentRef = doc(db, `artifacts/${appId}/public/data/students`, studentId);
                const snap = await getDoc(studentRef);
                if (!snap.exists()) {
                    showMessageModal('오류', '학생 정보를 찾을 수 없습니다.');
                    return;
                }
                const d = snap.data();
                
                // 현재 학생 ID 저장
                currentStudentId = studentId;
                
                // 상단 기본 정보
                document.getElementById('student-detail-name').textContent = `${d.name} (${d.id || studentId})`;
                document.getElementById('detail-level').textContent = d.level ?? 0;
                document.getElementById('detail-exp').textContent = d.exp ?? 0;
                document.getElementById('detail-diamonds').textContent = d.diamonds ?? 0;
                
                // 능력치
                const statsWrap = document.getElementById('student-detail-stats');
                statsWrap.innerHTML = '';
                ['stamina','attack','defense','luck'].forEach(k => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between text-gray-200';
                    div.innerHTML = `<span>${statLabels[k]}</span><span>${d[k] ?? 0}</span>`;
                    statsWrap.appendChild(div);
                });
                
                studentDetailModal.classList.remove('hidden');
            } catch (err) {
                console.error('학생 상세 보기 실패:', err);
                showMessageModal('오류', '학생 상세 정보를 불러오는 중 오류가 발생했습니다.');
            }
        }
        
        // 공통 지급 로직 세팅 함수
        function setupIncrement(section, field, firestoreKey) {
            const minusBtn = document.getElementById(`${section}-minus`);
            const plusBtn = document.getElementById(`${section}-plus`);
            const input = document.getElementById(`${section}-amount`);
            const confirmBtn = document.getElementById(`${section}-confirm`);
            const cancelBtn = document.getElementById(`${section}-cancel`);
            const sectionDiv = document.getElementById(`${section}-give-section`);
            const openBtn = document.getElementById(`give-${section}-btn`);
            
            // 열기
            openBtn.addEventListener("click", () => {
                sectionDiv.classList.remove("hidden");
            });
            
            // 증감
            minusBtn.addEventListener("click", () => {
                input.value = Math.max(1, parseInt(input.value) - 1);
            });
            plusBtn.addEventListener("click", () => {
                input.value = parseInt(input.value) + 1;
            });
            
            // 지급
            confirmBtn.addEventListener("click", async () => {
                const amount = parseInt(input.value);
                if (!currentStudentId || isNaN(amount)) return;
                const studentRef = doc(db, `artifacts/${appId}/public/data/students`, currentStudentId);
                await updateDoc(studentRef, { [firestoreKey]: increment(amount) });
                showMessageModal("완료", `${field} ${amount} 지급 완료!`);
                
                // 지급 후 화면 값도 즉시 갱신
                if (firestoreKey === "exp") {
                    document.getElementById("detail-exp").textContent =
                        parseInt(document.getElementById("detail-exp").textContent) + amount;
                } else if (firestoreKey === "diamonds") {
                    document.getElementById("detail-diamonds").textContent =
                        parseInt(document.getElementById("detail-diamonds").textContent) + amount;
                } else if (firestoreKey === "growth_points") {
                    // 성장 포인트는 모달에 직접 표시하는 span이 없으면 생략 가능
                }
                
                sectionDiv.classList.add("hidden");
            });
            
            // 취소
            cancelBtn.addEventListener("click", () => {
                sectionDiv.classList.add("hidden");
            });
        }
        
        // 세트 초기화 (모달 로딩 후 실행)
        setupIncrement("exp", "경험치", "exp");
        setupIncrement("dia", "다이아", "diamonds");
        setupIncrement("growth", "성장 포인트", "growth_points");

        // 상위 탭 버튼
        const teacherTabQuestBtn = document.getElementById("teacher-tab-quest");
        const teacherQuestSection = document.getElementById("teacher-quest-section");
        
        // 서브탭 버튼
        const questTabListBtn = document.getElementById("quest-tab-list");
        const questTabManageBtn = document.getElementById("quest-tab-manage");
        const questTabHistoryBtn = document.getElementById("quest-tab-history");

        // 서브탭 콘텐츠
        const questListSection = document.getElementById("quest-list-section");
        const questManageSection = document.getElementById("quest-manage-section");
        const questHistorySection = document.getElementById("quest-history-section");
        
        // 교사 대시보드 탭 전환
        teacherTabQuestBtn.addEventListener("click", () => {
            document.querySelectorAll('#teacher-dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            teacherQuestSection.classList.remove('hidden');
            document.querySelectorAll('#teacher-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-yellow-400', 'text-yellow-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            teacherTabQuestBtn.classList.remove('border-transparent', 'text-gray-400');
            teacherTabQuestBtn.classList.add('border-yellow-400', 'text-yellow-400');
        });
        
        // 퀘스트 서브탭 전환
        function switchQuestSubTab(activeBtn, activeSection) {
            [questTabListBtn, questTabManageBtn, questTabHistoryBtn].forEach(btn => {
                btn.classList.remove('border-yellow-400', 'text-yellow-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            activeBtn.classList.remove('border-transparent', 'text-gray-400');
            activeBtn.classList.add('border-yellow-400', 'text-yellow-400');
            
            [questListSection, questManageSection, questHistorySection].forEach(sec => sec.classList.add('hidden'));
            activeSection.classList.remove('hidden');
        }
        
        questTabListBtn.addEventListener("click", () => switchQuestSubTab(questTabListBtn, questListSection));
        questTabManageBtn.addEventListener("click", () => switchQuestSubTab(questTabManageBtn, questManageSection));
        questTabHistoryBtn.addEventListener("click", () => switchQuestSubTab(questTabHistoryBtn, questHistorySection));

        // 퀘스트 관리 탭 클릭 시 학생 목록 불러오기
        questTabManageBtn.addEventListener("click", () => {
            switchQuestSubTab(questTabManageBtn, questManageSection);
            renderQuestStudentList(); // ✅ 학생 목록 불러오기 실행
        });
        
        // 학생 목록 불러오기 함수
        async function renderQuestStudentList() {
            const container = document.getElementById("quest-student-list");
            container.innerHTML = "<p class='text-gray-400'>불러오는 중...</p>";
            
            try {
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                const snapshot = await getDocs(studentsRef);
                
                container.innerHTML = "";
                if (snapshot.empty) {
                    container.innerHTML = "<p class='text-gray-400'>등록된 학생이 없습니다.</p>";
                    return;
                }
                
                snapshot.forEach(docSnap => {
                    const s = docSnap.data();
                    const div = document.createElement("div");
                    div.innerHTML = `
                    <label class="flex items-center space-x-2 text-gray-200">
                    <input type="checkbox" value="${docSnap.id}" class="quest-student-checkbox">
                    <span>${s.name} (${s.id || docSnap.id})</span>
                    </label>
                    `;
                    container.appendChild(div);
                });
            } catch (err) {
                console.error("학생 목록 불러오기 실패:", err);
                container.innerHTML = "<p class='text-red-400'>학생 목록을 불러오는 중 오류가 발생했습니다.</p>";
            }
        }
        
        // 전체 선택 버튼
        document.getElementById("select-all-students").addEventListener("click", () => {
            document.querySelectorAll(".quest-student-checkbox").forEach(cb => cb.checked = true);
        });
        
        // 기간 체크박스
        document.getElementById("enable-period").addEventListener("change", (e) => {
            document.getElementById("quest-period-inputs").classList.toggle("hidden", !e.target.checked);
        });
        
        // 퀘스트 등록
        document.getElementById("quest-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const name = document.getElementById("quest-name").value.trim();
            const desc = document.getElementById("quest-desc").value.trim();
            const exp = parseInt(document.getElementById("reward-exp").value) || 0;
            const dia = parseInt(document.getElementById("reward-dia").value) || 0;
            const growth = parseInt(document.getElementById("reward-growth").value) || 0;
            
            const assigned = Array.from(document.querySelectorAll(".quest-student-checkbox:checked"))
                .map(cb => cb.value);
            
            let startDate = null, endDate = null;
            if (document.getElementById("enable-period").checked) {
                startDate = document.getElementById("quest-start").value || null;
                endDate = document.getElementById("quest-end").value || null;
            }
            
            const repeat = document.getElementById("quest-repeat").value;
            
            if (!name || !desc) {
                showMessageModal("오류", "퀘스트 이름과 설명을 입력하세요.");
                return;
            }
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/quests`), {
                    name,
                    description: desc,
                    rewards: { exp, dia, growth },
                    assigned_students: assigned,
                    start_date: startDate,
                    end_date: endDate,
                    repeat,
                    created_at: new Date()
                });
                showMessageModal("완료", "퀘스트가 등록되었습니다.");
                e.target.reset();
                renderQuestStudentList(); // 체크박스 초기화
            } catch (err) {
                console.error("퀘스트 등록 실패:", err);
                showMessageModal("오류", "퀘스트 등록 중 문제가 발생했습니다.");
            }
        });
    </script>
</body>

</html>
