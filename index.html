<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°°ì›€ ì›ì •ëŒ€</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    <!-- Font -->
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom styles for an adventure-game feel */
        .card-container {
            background-image: linear-gradient(135deg, #2b3956 0%, #1a233b 100%);
        }

        .btn-primary {
            background-image: linear-gradient(to right, #4ade80, #16a34a);
        }

        .btn-secondary {
            background-color: #3b82f6;
        }

        /* Progress Bar */
        .progress-container {
            height: 1.5rem;
            background-color: #4a5568;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            transition: width 0.5s ease-in-out;
            background-image: linear-gradient(to right, #6ee7b7, #34d399);
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container -->
    <div id="app-container" class="card-container rounded-3xl shadow-2xl p-8 max-w-lg w-full">

        <!-- Logo/Title -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold tracking-tight text-white mb-2">ë°°ì›€ ì›ì •ëŒ€</h1>
            <p class="text-lg text-gray-400">ë°°ì›€ì˜ ëª¨í—˜ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</p>
        </div>

        <!-- Dynamic Content Views -->
        <div id="views-container">

            <!-- 1. Landing View (Initial screen with 3 buttons) -->
            <div id="landing-view" class="view hidden">
                <div class="space-y-4">
                    <button id="show-student-login-btn"
                        class="w-full p-4 rounded-lg text-white font-semibold shadow-md btn-primary text-lg">í•™ìƒ ë¡œê·¸ì¸</button>
                    <button id="show-register-btn"
                        class="w-full p-4 rounded-lg text-white font-semibold shadow-md btn-secondary text-lg">í•™ìƒ íšŒì›ê°€ì…</button>
                    <button id="show-teacher-login-btn"
                        class="w-full p-4 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors text-lg">êµì‚¬ ë¡œê·¸ì¸</button>
                </div>
            </div>

            <!-- 2. Student Login View -->
            <div id="student-login-view" class="view hidden">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-semibold mb-4">í•™ìƒ ë¡œê·¸ì¸</h2>
                </div>
                <form id="login-form" class="space-y-4">
                    <div>
                        <input type="text" id="student-id-input" placeholder="ì•„ì´ë””"
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="password" id="student-password-input" placeholder="ë¹„ë°€ë²ˆí˜¸"
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <button type="submit"
                        class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">ë¡œê·¸ì¸</button>
                    <button type="button" id="back-to-landing-from-login"
                        class="w-full mt-4 p-3 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors">ë’¤ë¡œê°€ê¸°</button>
                </form>
            </div>

            <!-- 3. Registration View -->
            <div id="register-view" class="view hidden">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-semibold mb-4">íšŒì›ê°€ì…</h2>
                </div>
                <form id="register-form" class="space-y-4">
                    <div>
                        <input type="number" id="register-grade" placeholder="í•™ë…„" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="number" id="register-class" placeholder="ë°˜" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="number" id="register-number" placeholder="ë²ˆí˜¸" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="text" id="register-name" placeholder="ì´ë¦„" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="text" id="register-id" placeholder="ì•„ì´ë”” (ì¤‘ë³µ ë¶ˆê°€)" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="password" id="register-password" placeholder="ë¹„ë°€ë²ˆí˜¸ (4ì ì´ìƒ)" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <div>
                        <input type="text" id="register-char-name" placeholder="ìºë¦­í„° ì´ë¦„" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <button type="submit"
                        class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">ê°€ì… ì‹ ì²­</button>
                    <button type="button" id="back-to-landing-from-register"
                        class="w-full mt-4 p-3 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors">ë’¤ë¡œê°€ê¸°</button>
                </form>
            </div>

            <!-- 4. Teacher Login View -->
            <div id="teacher-login-view" class="view hidden">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-semibold mb-4">êµì‚¬ ë¡œê·¸ì¸</h2>
                </div>
                <form id="teacher-login-form" class="space-y-4">
                    <div>
                        <input type="password" id="teacher-code-input" placeholder="êµì‚¬ ì½”ë“œ" required
                            class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                    </div>
                    <button type="submit"
                        class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">ë¡œê·¸ì¸</button>
                    <button type="button" id="back-to-landing-from-teacher"
                        class="w-full mt-4 p-3 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors">ë’¤ë¡œê°€ê¸°</button>
                </form>
            </div>

            <!-- 5. Student Dashboard View -->
            <div id="student-dashboard-view" class="view hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">í•™ìƒ ëŒ€ì‹œë³´ë“œ</h2>
                    <button id="logout-btn"
                        class="px-4 py-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-red-500 hover:text-white transition-colors">ë¡œê·¸ì•„ì›ƒ</button>
                </div>

                <!-- Tabs -->
                <div class="flex justify-around mb-6 text-sm md:text-base">
                    <button id="tab-info"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 font-semibold border-emerald-400 text-emerald-400">ì •ë³´</button>
                    <button id="tab-quest"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 border-transparent text-gray-400 hover:text-white">í€˜ìŠ¤íŠ¸</button>
                    <button id="tab-log"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 border-transparent text-gray-400 hover:text-white">ì„±ì¥ì¼ì§€</button>
                    <button id="tab-shop"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 border-transparent text-gray-400 hover:text-white">ìƒì </button>
                </div>

                <!-- Tab Sections -->
                <div id="dashboard-sections">
                    <!-- 5.1. User Info Section -->
                    <div id="user-info-section" class="space-y-6">
                        <!-- User Info Card -->
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <div class="flex items-center space-x-4 mb-4">
                                <i class="fa-solid fa-user-circle text-4xl text-emerald-400"></i>
                                <div class="flex-1">
                                    <h3 id="char-name-display" class="text-2xl font-bold"></h3>
                                    <p class="text-gray-400 text-sm">ìœ ì € ID: <span id="user-id-display"
                                            class="text-xs break-words"></span></p>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <!-- Level & EXP -->
                                <div class="space-y-1">
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="font-semibold">ë ˆë²¨: <span id="level-display"></span></span>
                                        <span id="exp-text-display" class="text-sm text-gray-400"></span>
                                    </div>
                                    <div class="progress-container">
                                        <div id="exp-bar" class="progress-bar"></div>
                                    </div>
                                </div>
                                <!-- Diamonds -->
                                <div class="flex items-center space-x-2">
                                    <i class="fa-solid fa-gem text-blue-400 text-xl"></i>
                                    <span class="font-semibold">ë‹¤ì´ì•„: <span id="diamond-display"></span></span>
                                </div>
                                <!-- Growth Points -->
                                <div class="flex items-center space-x-2">
                                    <i class="fa-solid fa-star text-yellow-400 text-xl"></i>
                                    <span class="font-semibold">ì„±ì¥ í¬ì¸íŠ¸: <span id="growth-point-display"></span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Card -->
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4">ëŠ¥ë ¥ì¹˜</h3>
                            <div id="stats-container" class="space-y-3">
                                <!-- Stats will be rendered here dynamically -->
                            </div>
                            <button id="save-stats-btn"
                                class="w-full p-3 mt-6 rounded-lg text-white font-semibold shadow-md bg-green-500 hover:bg-green-600 transition-colors">ë³€ê²½ì‚¬í•­
                                ì €ì¥</button>
                        </div>
                    </div>

                    <!-- 5.2. Quest Section -->
                    <div id="quest-section" class="space-y-6 hidden">
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-scroll text-yellow-400"></i>
                                <span>ì˜¤ëŠ˜ì˜ í€˜ìŠ¤íŠ¸</span>
                            </h3>
                            <div id="daily-quest-container">
                                <p class="text-gray-400 mb-4">ìƒˆë¡œìš´ í€˜ìŠ¤íŠ¸ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
                            </div>
                        </div>
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-clipboard-check text-emerald-400"></i>
                                <span>ì™„ë£Œí•œ í€˜ìŠ¤íŠ¸ ëª©ë¡</span>
                            </h3>
                            <div id="completed-quests-container">
                                <p class="text-gray-400">ì•„ì§ ì™„ë£Œí•œ í€˜ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>

                    <!-- 5.3. Growth Log Section -->
                    <div id="log-section" class="space-y-6 hidden">
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-clipboard-list text-purple-400"></i>
                                <span>ì„±ì¥ì¼ì§€ ê¸°ë¡</span>
                            </h3>
                            <form id="growth-log-form" class="space-y-4">
                                <textarea id="growth-log-text" rows="5"
                                    class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-400 text-white"
                                    placeholder="ì˜¤ëŠ˜ ë°°ìš´ ì ì´ë‚˜ ëŠë‚€ ì ì„ ê¸°ë¡í•´ ë³´ì„¸ìš”."></textarea>
                                <button type="submit"
                                    class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">ê¸°ë¡ ì „ì†¡</button>
                            </form>
                            <div id="growth-log-status" class="mt-4 p-4 rounded-lg text-center font-semibold hidden"></div>
                        </div>

                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-history text-gray-400"></i>
                                <span>ë‚˜ì˜ ì„±ì¥ ê¸°ë¡</span>
                            </h3>
                            <div id="growth-log-container" class="space-y-4">
                                <!-- Growth log entries will be rendered here dynamically -->
                                <p class="text-gray-400">ì„±ì¥ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ëª¨í—˜ì„ ì‹œì‘í•´ ë³´ì„¸ìš”!</p>
                            </div>
                        </div>
                    </div>

                    <!-- 5.4. Shop Section -->
                    <div id="shop-section" class="space-y-6 hidden">
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-md">
                            <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                                <i class="fa-solid fa-shop text-red-400"></i>
                                <span>ìƒì </span>
                            </h3>
                            <p class="text-gray-400">ì´ê³³ì— ìƒì  ì•„ì´í…œ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                </div>
            </div>

            <!-- 6. Teacher Dashboard View -->
            <div id="teacher-dashboard-view" class="view hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">êµì‚¬ ëŒ€ì‹œë³´ë“œ</h2>
                    <div class="flex space-x-2">
                        <button id="change-teacher-code-btn"
                            class="px-4 py-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-yellow-500 hover:text-white transition-colors text-sm">ë¡œê·¸ì¸ ì½”ë“œ ë³€ê²½</button>
                        <button id="teacher-logout-btn"
                            class="px-4 py-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-red-500 hover:text-white transition-colors text-sm">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
                <!-- Tabs -->
                <div class="flex justify-around mb-6 text-sm md:text-base">
                    <button id="teacher-tab-pending-students"
                        class="flex-1 px-2 md:px-4 py-2 text-center border-b-2 font-semibold border-emerald-400 text-emerald-400">íšŒì›ê°€ì… ê´€ë¦¬</button>
                    <button id="teacherTabGrowthLogBtn" 
                        class="px-4 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-white hover:border-white transition-colors">ì„±ì¥ì¼ì§€ ê´€ë¦¬</button>
                </div>

                <!-- Teacher Tab Sections -->
                <div id="teacher-dashboard-sections">
                    <div id="teacher-pending-students-section">
                        <h3 class="text-xl font-semibold mb-4">ë¯¸ìŠ¹ì¸ í•™ìƒ ëª©ë¡</h3>
                        <div id="pending-students-list" class="space-y-4">
                            <!-- Pending student list will be rendered here dynamically -->
                            <p class="text-gray-400 text-center" id="no-pending-students">ë¯¸ìŠ¹ì¸ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                    <div id="growth-log-management-tab" class="hidden p-4">
                        <h3 class="text-xl font-bold mb-4 text-green-300">ì„±ì¥ì¼ì§€ ê´€ë¦¬</h3>
                        
                        <div class="flex mb-4 border-b border-gray-700">
                            <button id="unverified-logs-tab-btn" class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white transition-colors">
                                ë¯¸í™•ì¸ ì„±ì¥ì¼ì§€
                            </button>
                            <button id="all-logs-tab-btn" class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white transition-colors">
                                ì „ì²´ ì„±ì¥ì¼ì§€
                            </button>
                        </div>                        
                        <div id="unverified-logs-section" class="p-4 bg-gray-800 rounded-lg shadow-inner">
                            <div id="unverified-log-list">
                            </div>
                        </div>                        
                        <div id="all-logs-section" class="hidden">
                            <div id="student-list-container" class="mb-6">
                                <h4 class="text-lg font-semibold mb-2">í•™ìƒ ëª©ë¡</h4>
                                <div id="student-list" class="flex flex-wrap gap-2">
                                </div>
                            </div>
                            <div id="growth-log-container" class="bg-gray-800 p-4 rounded-lg shadow-inner hidden">
                            <h4 class="text-lg font-semibold mb-2" id="selected-student-name"></h4>
                                <div id="growth-log-list">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loading-spinner" class="hidden flex flex-col items-center justify-center p-8">
                <i class="fas fa-spinner fa-spin text-5xl text-emerald-400 mb-4"></i>
                <p class="text-xl text-gray-400 font-semibold">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="message-modal-overlay"
        class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay transition-opacity duration-300">
        <div
            class="bg-gray-800 p-8 rounded-3xl shadow-2xl max-w-sm w-full transform scale-95 transition-transform duration-300">
            <h3 id="modal-title" class="text-xl font-semibold mb-4 text-white"></h3>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <button id="modal-close-btn"
                class="w-full p-3 rounded-lg text-white font-semibold shadow-md btn-primary">í™•ì¸</button>
        </div>
    </div>

    <!-- Custom Modal for changing teacher code -->
    <div id="teacher-code-modal-overlay"
        class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay transition-opacity duration-300">
        <div
            class="bg-gray-800 p-8 rounded-3xl shadow-2xl max-w-sm w-full transform scale-95 transition-transform duration-300">
            <h3 class="text-xl font-semibold mb-4 text-white">ë¡œê·¸ì¸ ì½”ë“œ ë³€ê²½</h3>
            <form id="teacher-code-change-form" class="space-y-4">
                <div>
                    <input type="password" id="new-teacher-code-input" placeholder="ìƒˆë¡œìš´ êµì‚¬ ì½”ë“œ" required
                        class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-white">
                </div>
                <div class="flex space-x-2">
                    <button type="submit"
                        class="flex-1 p-3 rounded-lg text-white font-semibold shadow-md btn-primary">ë³€ê²½</button>
                    <button type="button" id="cancel-teacher-code-change-btn"
                        class="flex-1 p-3 rounded-lg text-white font-semibold border-2 border-gray-600 hover:bg-gray-700 transition-colors">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, getDoc, addDoc, doc, setDoc, updateDoc, deleteDoc, orderBy, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-functions.js";
        
        // Constants from the execution environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'Learning_Explorer';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBx1gV8tiS2e83pWkDx0Y8p3Uou5z2ZwgU",
            authDomain: "learning-explorers.firebaseapp.com",
            projectId: "learning-explorers",
            storageBucket: "learning-explorers.firebasestorage.app",
            messagingSenderId: "836826026401",
            appId: "1:836826026401:web:9d4e237cb888e478227be0",
            measurementId: "G-BNMVYB2XNJ"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // ì´ ë³€ìˆ˜ë“¤ì€ ë‹¨ í•œ ë²ˆë§Œ ì„ ì–¸ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
        let app = initializeApp(firebaseConfig);
        let db = getFirestore(app);
        let auth = getAuth(app);
        let functions = getFunctions(app);
        let isAuthReady = false;
        
        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        let userId = null;
        let studentDataCache = null;

        // UI element references
        const views = {
            landing: document.getElementById('landing-view'),
            studentLogin: document.getElementById('student-login-view'),
            register: document.getElementById('register-view'),
            teacherLogin: document.getElementById('teacher-login-view'),
            dashboard: document.getElementById('student-dashboard-view'),
            teacherDashboard: document.getElementById('teacher-dashboard-view'),
        };
        const showStudentLoginBtn = document.getElementById('show-student-login-btn');
        const showRegisterBtn = document.getElementById('show-register-btn');
        const showTeacherLoginBtn = document.getElementById('show-teacher-login-btn');
        const backToLandingFromLoginBtn = document.getElementById('back-to-landing-from-login');
        const backToLandingFromRegisterBtn = document.getElementById('back-to-landing-from-register');
        const backToLandingFromTeacherBtn = document.getElementById('back-to-landing-from-teacher');

        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const teacherLoginForm = document.getElementById('teacher-login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const teacherLogoutBtn = document.getElementById('teacher-logout-btn');
        const saveStatsBtn = document.getElementById('save-stats-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const messageModalOverlay = document.getElementById('message-modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        const teacherCodeModalOverlay = document.getElementById('teacher-code-modal-overlay');
        const teacherCodeChangeForm = document.getElementById('teacher-code-change-form');
        const newTeacherCodeInput = document.getElementById('new-teacher-code-input');
        const changeTeacherCodeBtn = document.getElementById('change-teacher-code-btn');
        const cancelTeacherCodeChangeBtn = document.getElementById('cancel-teacher-code-change-btn');

        // Tab buttons (Student)
        const tabInfoBtn = document.getElementById('tab-info');
        const tabQuestBtn = document.getElementById('tab-quest');
        const tabLogBtn = document.getElementById('tab-log');
        const tabShopBtn = document.getElementById('tab-shop');

        // Tab buttons (Teacher)
        const teacherTabPendingStudentsBtn = document.getElementById('teacher-tab-pending-students');
        const teacherTabPendingLogsBtn = document.getElementById('teacher-tab-pending-logs');

        // Sections
        const userInfoSection = document.getElementById('user-info-section');
        const questSection = document.getElementById('quest-section');
        const logSection = document.getElementById('log-section');
        const shopSection = document.getElementById('shop-section');
        const teacherPendingStudentsSection = document.getElementById('teacher-pending-students-section');
        const teacherPendingLogsSection = document.getElementById('teacher-pending-logs-section');

        // Initial stat values for new students
        const initialStats = {
            level: 1,
            exp: 0,
            diamonds: 0,
            growth_points: 0,
            stamina: 5,
            attack: 5,
            defense: 5,
            luck: 5,
            equipped: {
                title: "ì—†ìŒ",
                weapon: "ì—†ìŒ",
                armor: "ì—†ìŒ",
                hat: "ì—†ìŒ",
                accessory: "ì—†ìŒ",
                relic: "ì—†ìŒ",
                skill: "ì—†ìŒ"
            }
        };

        // --- Core Functions ---

        /**
         * Renders a specific view and hides all others.
         * @param {string} viewName - The name of the view to show.
         */
        function showView(viewName) {
            loadingSpinner.classList.add('hidden');
            for (const key in views) {
                if (key === viewName) {
                    views[key].classList.remove('hidden');
                } else {
                    views[key].classList.add('hidden');
                }
            }
        }

        /**
         * Shows a custom modal message.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message to display.
         */
        function showMessageModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModalOverlay.classList.remove('hidden');
        }

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initFirebase() {
            try {
                setLogLevel('debug');
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                await signInAnonymously(auth);

                userId = auth.currentUser.uid;
                isAuthReady = true;

                console.log('Firebase initialized. User ID:', userId);

                // Initialize teacher password if it doesn't exist
                const teacherDocRef = doc(db, `artifacts/${appId}/public/data/teachers`, 'teacher_password');
                const teacherDocSnap = await getDoc(teacherDocRef);
                if (!teacherDocSnap.exists()) {
                    await setDoc(teacherDocRef, {
                        password: 'superteacher'
                    });
                }
                
                // Initialize a base quest in the database if it doesn't exist
                const questDocRef = doc(db, `artifacts/${appId}/public/data/quests`, 'daily_diary_quest');
                const questDocSnap = await getDoc(questDocRef);
                if (!questDocSnap.exists()) {
                    await setDoc(questDocRef, {
                        title: "ì˜¤ëŠ˜ì˜ ì„±ì¥ì¼ì§€ ì“°ê¸°",
                        description: "ì˜¤ëŠ˜ ìˆì—ˆë˜ ë‚˜ì˜ ì„±ì¥ì„ ê°„ë‹¨íˆ ê¸°ë¡í•´ ë³´ì„¸ìš”.",
                        exp_reward: 20,
                        gp_reward: 0,
                        type: "daily"
                    });
                }

                showView('landing');
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessageModal('ì˜¤ë¥˜', 'ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // --- Data Handling ---

        /**
         * Renders the student dashboard with real-time data from Firestore.
         */
        function renderStudentDashboard() {
            if (!userId) {
                showMessageModal('ì˜¤ë¥˜', 'ë¡œê·¸ì¸ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                showView('landing');
                return;
            }

            showView('loading');
            const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);

            onSnapshot(studentDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    showView('dashboard');
                    studentDataCache = docSnap.data();

                    document.getElementById('user-id-display').textContent = userId;

                    document.getElementById('char-name-display').textContent = studentDataCache.character_name;
                    document.getElementById('level-display').textContent = studentDataCache.level;
                    document.getElementById('diamond-display').textContent = studentDataCache.diamonds;
                    document.getElementById('growth-point-display').textContent = studentDataCache.growth_points;

                    const expToNextLevel = 200;
                    const expPercentage = (studentDataCache.exp / expToNextLevel) * 100;
                    document.getElementById('exp-bar').style.width = `${Math.min(expPercentage, 100)}%`;
                    document.getElementById('exp-text-display').textContent = `${studentDataCache.exp}/${expToNextLevel}`;

                    if (studentDataCache.exp >= expToNextLevel) {
                        const newLevel = studentDataCache.level + 1;
                        const newExp = studentDataCache.exp - expToNextLevel;
                        const newGrowthPoints = studentDataCache.growth_points + 5;

                        updateDoc(studentDocRef, {
                            level: newLevel,
                            exp: newExp,
                            growth_points: newGrowthPoints
                        }).then(() => {
                            showMessageModal('ë ˆë²¨ì—…!', `ì¶•í•˜í•©ë‹ˆë‹¤! ë ˆë²¨ ${newLevel}ì´ ë˜ì—ˆìŠµë‹ˆë‹¤! ì„±ì¥ í¬ì¸íŠ¸ 5ì ì„ ì–»ì—ˆìŠµë‹ˆë‹¤.`);
                            logEvent(userId, 'level_up', {
                                newLevel: newLevel
                            });
                        }).catch(error => {
                            console.error("Level up failed:", error);
                        });
                    }

                    const statsContainer = document.getElementById('stats-container');
                    statsContainer.innerHTML = '';
                    const stats = ['stamina', 'attack', 'defense', 'luck'];
                    stats.forEach(stat => {
                        const statElement = document.createElement('div');
                        statElement.className = 'flex items-center justify-between';
                        statElement.innerHTML = `
                            <span class="text-gray-300 font-semibold capitalize">${stat}</span>
                            <div class="flex items-center space-x-2">
                                <span id="${stat}-display" class="text-emerald-400 font-bold text-lg">${studentDataCache[stat]}</span>
                                <button data-stat="${stat}" class="stat-plus-btn bg-gray-600 w-8 h-8 rounded-full text-white font-bold text-sm hover:bg-emerald-400 transition-colors">+</button>
                            </div>
                        `;
                        statsContainer.appendChild(statElement);
                    });

                    document.querySelectorAll('.stat-plus-btn').forEach(button => {
                        button.addEventListener('click', handleStatIncrease);
                    });

                    renderQuest(studentDataCache);
                    setupGrowthLogUIListener();
                    renderGrowthLog();
                    listenForRewards();

                } else {
                    console.error("Student data not found for user ID:", userId);
                    showMessageModal('ì˜¤ë¥˜', 'í•™ìƒ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    auth.signOut();
                    showView('landing');
                }
            }, (error) => {
                console.error("Failed to fetch student data:", error);
                showMessageModal('ì˜¤ë¥˜', 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                auth.signOut();
                showView('landing');
            });
        }
        
        /**
         * Listens for growth log approvals and applies rewards.
         */
        function listenForRewards() {
            if (!userId) return;

            const logsCollectionRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);
            const q = query(logsCollectionRef,
                where("student_id", "==", userId),
                where("status", "in", ['approved', 'rejected']),
                where("rewarded", "==", false)
            );

            onSnapshot(q, async (querySnapshot) => {
                if (!isAuthReady) return;

                if (!querySnapshot.empty) {
                    for (const docSnap of querySnapshot.docs) {
                        const logData = docSnap.data();
                        const logDocRef = docSnap.ref;
                        const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);

                        try {
                            const studentDocSnap = await getDoc(studentDocRef);
                            const studentData = studentDocSnap.data();

                            let expGain = 0;
                            let growthPointGain = 0;

                            if (logData.status === 'approved') {
                                expGain = 50;
                                growthPointGain = 1;
                                showMessageModal('ì¶•í•˜í•©ë‹ˆë‹¤!', `êµì‚¬ì—ê²Œ ì„±ì¥ì¼ì§€ 'ìµœê³ ' ì ìˆ˜ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤! ê²½í—˜ì¹˜ ${expGain}ì„ ì–»ì—ˆìŠµë‹ˆë‹¤.`);
                            } else if (logData.status === 'rejected') {
                                expGain = 20;
                                showMessageModal('í™•ì¸ë¨', `êµì‚¬ê°€ ì„±ì¥ì¼ì§€ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤. ê²½í—˜ì¹˜ ${expGain}ì„ ì–»ì—ˆìŠµë‹ˆë‹¤.`);
                            }

                            const newExp = (studentData.exp || 0) + expGain;
                            const newGrowthPoints = (studentData.growth_points || 0) + growthPointGain;
                            
                            await updateDoc(studentDocRef, {
                                exp: newExp,
                                growth_points: newGrowthPoints
                            });

                            await updateDoc(logDocRef, { rewarded: true });

                            logEvent(userId, `growth_log_reward_${logData.status}`, {
                                logId: docSnap.id,
                                exp_gain: expGain,
                                growth_point_gain: growthPointGain
                            });

                        } catch (error) {
                            console.error("Failed to apply reward:", error);
                        }
                    }
                }
            });
        }


        /**
         * Renders the teacher dashboard with real-time data from Firestore.
         */
        async function renderTeacherDashboard() {
            showView('loading');

            const pendingListContainer = document.getElementById('pending-students-list');
            const registerRef = collection(db, `artifacts/${appId}/public/data/register`);
            const qStudents = query(registerRef, where("status", "==", "ëŒ€ê¸°ì¤‘"));
            onSnapshot(qStudents, (snapshot) => {
                pendingListContainer.innerHTML = '';
                if (snapshot.empty) {
                    pendingListContainer.innerHTML = '<p class="text-gray-400 text-center">ë¯¸ìŠ¹ì¸ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const docId = doc.id;
                        const card = document.createElement('div');
                        card.className = 'bg-gray-800 rounded-2xl p-4 shadow-md flex items-center justify-between';
                        card.innerHTML = `
                            <div>
                                <h4 class="text-lg font-semibold">${data.name} (${data.id})</h4>
                                <p class="text-gray-400 text-sm">í•™ë…„: ${data.grade}ë°˜: ${data.class} ë²ˆí˜¸: ${data.number}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button data-action="approve" data-id="${docId}" class="approve-btn px-4 py-2 rounded-lg text-white font-semibold bg-green-500 hover:bg-green-600 transition-colors">ìŠ¹ì¸</button>
                                <button data-action="reject" data-id="${docId}" class="reject-btn px-4 py-2 rounded-lg text-white font-semibold bg-red-500 hover:bg-red-600 transition-colors">ê±°ì ˆ</button>
                            </div>
                        `;
                        pendingListContainer.appendChild(card);
                    });
                    document.querySelectorAll('.approve-btn').forEach(btn => {
                        btn.addEventListener('click', handleApproveRequest);
                    });
                    document.querySelectorAll('.reject-btn').forEach(btn => {
                        btn.addEventListener('click', handleApproveRequest);
                    });
                }
            });

            const pendingLogsContainer = document.getElementById('pending-growth-logs-list');
            const logsRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);
            const qLogs = query(logsRef, where("status", "==", "pending"));
            
            showView('teacherDashboard');
            
            // ğŸ‘‡ ì´ ë¶€ë¶„ì— ì•„ë˜ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”.
            // ì„±ì¥ì¼ì§€ ê´€ë¦¬ íƒ­ í™œì„±í™” ì‹œ ì´ˆê¸° ë Œë”ë§
            renderUnverifiedLogs();
        }

        /**
         * Renders the student's daily quest status and completed quests.
         * @param {Object} studentData - The student's data from Firestore.
         */
        async function renderQuest(studentData) {
            const dailyQuestContainer = document.getElementById('daily-quest-container');
            const completedQuestsContainer = document.getElementById('completed-quests-container');
            
            dailyQuestContainer.innerHTML = '';
            completedQuestsContainer.innerHTML = '';

            // Get a single daily quest from Firestore
            const questsRef = collection(db, `artifacts/${appId}/public/data/quests`);
            const q = query(questsRef, where("type", "==", "daily"), limit(1));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                dailyQuestContainer.innerHTML = '<p class="text-gray-400">ì˜¤ëŠ˜ì˜ í€˜ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                const questDoc = querySnapshot.docs[0];
                const questData = questDoc.data();
                const questId = questDoc.id;

                const questCompletedAt = studentData.quests?.[questId]?.completed_at;
                const today = new Date().toISOString().split('T')[0];

                const isCompletedToday = questCompletedAt && questCompletedAt.toDate().toISOString().split('T')[0] === today;
                
                if (isCompletedToday) {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-700 rounded-lg p-4 flex items-center justify-between';
                    card.innerHTML = `
                        <div>
                            <h4 class="text-lg font-semibold text-gray-300">${questData.title}</h4>
                            <p class="text-sm text-emerald-400">í€˜ìŠ¤íŠ¸ ì™„ë£Œ!</p>
                        </div>
                        <i class="fa-solid fa-check-circle text-2xl text-emerald-400"></i>
                    `;
                    dailyQuestContainer.appendChild(card);
                } else {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-700 rounded-lg p-4 space-y-4';
                    card.innerHTML = `
                        <h4 class="text-lg font-semibold text-white">${questData.title}</h4>
                        <p class="text-gray-300">${questData.description} (ê²½í—˜ì¹˜ +${questData.exp_reward}, ì„±ì¥ í¬ì¸íŠ¸ +${questData.gp_reward})</p>
                        <button id="complete-quest-btn" data-quest-id="${questId}" class="w-full p-2 rounded-lg text-white font-semibold btn-primary">í€˜ìŠ¤íŠ¸ ì™„ë£Œ</button>
                    `;
                    dailyQuestContainer.appendChild(card);
                    document.getElementById('complete-quest-btn').addEventListener('click', handleQuestCompletion);
                }
            }
            
            // Render Completed Quests
            if (studentData.quests) {
                const completedQuests = Object.entries(studentData.quests).filter(([key, value]) => value.completed_at);
                if (completedQuests.length > 0) {
                    completedQuests.sort((a, b) => b[1].completed_at.toDate() - a[1].completed_at.toDate());
                    completedQuests.forEach(([key, value]) => {
                        const questCard = document.createElement('div');
                        questCard.className = 'bg-gray-700 rounded-lg p-3 shadow-sm';
                        const questName = key === "daily_diary_quest" ? "ì˜¤ëŠ˜ì˜ ì¼ê¸° ì“°ê¸°" : key;
                        const date = value.completed_at.toDate().toLocaleDateString();
                        questCard.innerHTML = `
                            <div class="flex items-center justify-between">
                                <p class="text-gray-300 font-semibold">${questName}</p>
                                <p class="text-sm text-emerald-400">ì™„ë£Œ</p>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">${date}ì— ì™„ë£Œë¨</p>
                        `;
                        completedQuestsContainer.appendChild(questCard);
                    });
                } else {
                    completedQuestsContainer.innerHTML = '<p class="text-gray-400">ì•„ì§ ì™„ë£Œí•œ í€˜ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            } else {
                completedQuestsContainer.innerHTML = '<p class="text-gray-400">ì•„ì§ ì™„ë£Œí•œ í€˜ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }

        /**
         * Sets up a real-time listener for the growth log UI state.
         */
        function setupGrowthLogUIListener() {
            if (!userId) return;

            const submissionForm = document.getElementById('growth-log-form');
            const statusContainer = document.getElementById('growth-log-status');
            const logTextarea = document.getElementById('growth-log-text');

            const logsCollectionRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);
            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);

            // NOTE: Firestore requires a composite index for this query.
            // If you get a "The query requires an index" error, follow the link in the console
            // to create the index. It is a one-time setup for your database.
            const q = query(logsCollectionRef,
                where("student_id", "==", userId),
                where("timestamp", ">=", todayStart)
            );

            onSnapshot(q, (querySnapshot) => {
                if (!querySnapshot.empty) {
                    submissionForm.classList.add('hidden');
                    statusContainer.classList.remove('hidden');
                    const logData = querySnapshot.docs[0].data();
                    let statusText = '';
                    let statusColor = '';
                    
                    switch (logData.status) {
                        case 'pending':
                            statusText = `<i class="fa-solid fa-hourglass-half text-yellow-400 mr-2"></i>ìŠ¹ì¸ ëŒ€ê¸° ì¤‘...`;
                            statusColor = 'bg-yellow-900 text-yellow-300';
                            break;
                        case 'approved':
                            statusText = `<i class="fa-solid fa-check-circle text-emerald-400 mr-2"></i>ì˜¤ëŠ˜ì˜ ì„±ì¥ì¼ì§€ ìµœê³ !`;
                            statusColor = 'bg-emerald-900 text-emerald-300';
                            break;
                        case 'rejected':
                            statusText = `<i class="fa-solid fa-times-circle text-red-400 mr-2"></i>ì˜¤ëŠ˜ì˜ ì„±ì¥ì¼ì§€ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‘ì„±í•´ ë³´ì„¸ìš”.`;
                            statusColor = 'bg-red-900 text-red-300';
                            break;
                    }
                    statusContainer.innerHTML = statusText;
                    statusContainer.className = `mt-4 p-4 rounded-lg text-center font-semibold ${statusColor}`;
                } else {
                    submissionForm.classList.remove('hidden');
                    statusContainer.classList.add('hidden');
                    logTextarea.value = '';
                }
            });
        }
        
        /**
         * Renders the student's growth log history.
         */
        function renderGrowthLog() {
            const logContainer = document.getElementById('growth-log-container');
            const logCollectionRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);

            // NOTE: Firestore requires a composite index for this query.
            // If you get a "The query requires an index" error, follow the link in the console
            // to create the index. It is a one-time setup for your database.
            const q = query(logCollectionRef,
                where("student_id", "==", userId),
                orderBy('timestamp', 'desc'), limit(50));

            onSnapshot(q, (snapshot) => {
                logContainer.innerHTML = '';
                if (snapshot.empty) {
                    logContainer.innerHTML = '<p class="text-gray-400">ì„±ì¥ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ëª¨í—˜ì„ ì‹œì‘í•´ ë³´ì„¸ìš”!</p>';
                } else {
                    snapshot.forEach(doc => {
                        const logData = doc.data();
                        const logEntry = document.createElement('div');
                        logEntry.className = 'bg-gray-700 rounded-lg p-3 shadow-sm';

                        const timestamp = logData.timestamp?.toMillis ? logData.timestamp.toMillis() : logData.timestamp;
                        if (!timestamp) return;

                        const date = new Date(timestamp);
                        const formattedTime = date.toLocaleTimeString('ko-KR', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const formattedDate = date.toLocaleDateString('ko-KR');

                        let statusBadge = '';
                        let contentColorClass = 'text-gray-300';

                        if (logData.status === 'approved') {
                            statusBadge = `<span class="bg-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-full">ìµœê³ </span>`;
                        } else if (logData.status === 'rejected') {
                            statusBadge = `<span class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">í™•ì¸</span>`;
                        } else {
                            statusBadge = `<span class="bg-yellow-500 text-white text-xs font-bold px-2 py-1 rounded-full">ëŒ€ê¸° ì¤‘</span>`;
                        }

                        logEntry.innerHTML = `
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm text-gray-400">${formattedDate}</p>
                                ${statusBadge}
                            </div>
                            <p class="${contentColorClass}">${logData.content}</p>
                        `;
                        logContainer.appendChild(logEntry);
                    });
                }
            }, (error) => {
                console.error("Failed to fetch growth log:", error);
                logContainer.innerHTML = '<p class="text-red-400">ì„±ì¥ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            });
        }
        
        /**
         * Logs an event to the student's growth log.
         * @param {string} studentId - The ID of the student.
         * @param {string} eventType - The type of event.
         * @param {object} details - Details of the event.
         */
        async function logEvent(studentId, eventType, details) {
            if (!studentId) return;
            try {
                const logCollectionRef = collection(db, `artifacts/${appId}/public/data/students/${studentId}/log`);
                await addDoc(logCollectionRef, {
                    event_type: eventType,
                    details: details,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Failed to log event:", error);
            }
        }

        /**
         * Handles quest completion and awards the user.
         */
        async function handleQuestCompletion(e) {
            if (!userId) {
                showMessageModal('ì˜¤ë¥˜', 'ë¡œê·¸ì¸ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            const questId = e.target.dataset.questId;

            const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);
            const questDocRef = doc(db, `artifacts/${appId}/public/data/quests`, questId);
            
            const [studentDocSnap, questDocSnap] = await Promise.all([
                getDoc(studentDocRef),
                getDoc(questDocRef)
            ]);

            if (!studentDocSnap.exists() || !questDocSnap.exists()) {
                showMessageModal('ì˜¤ë¥˜', 'ì‚¬ìš©ì ë˜ëŠ” í€˜ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const studentData = studentDocSnap.data();
            const questData = questDocSnap.data();
            
            const questCompletedAt = studentData.quests?.[questId]?.completed_at;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            if (questCompletedAt && questCompletedAt.toDate() >= today) {
                showMessageModal('í€˜ìŠ¤íŠ¸ ì™„ë£Œ', 'ì˜¤ëŠ˜ì˜ í€˜ìŠ¤íŠ¸ëŠ” ì´ë¯¸ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.');
                return;
            }

            const expGain = questData.exp_reward;
            const growthPointGain = questData.gp_reward;
            const newExp = (studentData.exp || 0) + expGain;
            const newGrowthPoints = (studentData.growth_points || 0) + growthPointGain;

            try {
                await updateDoc(studentDocRef, {
                    exp: newExp,
                    growth_points: newGrowthPoints,
                    [`quests.${questId}.completed_at`]: serverTimestamp()
                });
                showMessageModal('í€˜ìŠ¤íŠ¸ ì„±ê³µ', 'ì˜¤ëŠ˜ì˜ í€˜ìŠ¤íŠ¸ë¥¼ ì™„ë£Œí•˜ê³  ë³´ìƒì„ ë°›ì•˜ìŠµë‹ˆë‹¤!');
                logEvent(userId, 'quest_complete', {
                    quest_name: questData.title,
                    exp_gain: expGain,
                    growth_point_gain: growthPointGain
                });
            } catch (error) {
                console.error("Quest completion failed:", error);
                showMessageModal('ì˜¤ë¥˜', 'í€˜ìŠ¤íŠ¸ ì™„ë£Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        /**
         * Handles the growth log submission button click.
         */
        async function handleGrowthLogSubmission(e) {
            e.preventDefault();
            const logText = document.getElementById('growth-log-text').value.trim();
            const submitButton = e.target.querySelector('button[type="submit"]');

            if (!logText) {
                showMessageModal('ì˜¤ë¥˜', 'ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> ì „ì†¡ ì¤‘...`;

            try {
                if (!userId) {
                    showMessageModal('ì˜¤ë¥˜', 'ë¡œê·¸ì¸ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }

                const logsCollectionRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);
                const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);
                const studentDoc = await getDoc(studentDocRef);

                if (!studentDoc.exists()) {
                    showMessageModal('ì˜¤ë¥˜', 'ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                const studentData = studentDoc.data();

                // Check if a log has already been submitted today
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                const q = query(logsCollectionRef,
                    where("student_id", "==", userId),
                    where("timestamp", ">=", todayStart)
                );
                const existingLogs = await getDocs(q);

                if (!existingLogs.empty) {
                    showMessageModal('ì œì¶œ ì‹¤íŒ¨', 'ì˜¤ëŠ˜ì€ ì´ë¯¸ ì„±ì¥ì¼ì§€ë¥¼ ì œì¶œí–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                await addDoc(logsCollectionRef, {
                    student_id: userId,
                    student_name: studentData.name,
                    content: logText,
                    status: 'pending',
                    rewarded: false, // Add a flag to track if the reward has been given
                    timestamp: serverTimestamp()
                });

                document.getElementById('growth-log-text').value = '';
                showMessageModal('ì „ì†¡ ì™„ë£Œ', 'ì„±ì¥ì¼ì§€ê°€ êµì‚¬ì—ê²Œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”!');
            } catch (error) {
                console.error("Growth log submission failed:", error);
                showMessageModal('ì˜¤ë¥˜', `ì„±ì¥ì¼ì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = `ê¸°ë¡ ì „ì†¡`;
            }
        }

        /**
         * Handles teacher approval of a growth log.
         * @param {Event} e - Click event.
         */
        async function handleGrowthLogApproval(e) {
            const logId = e.target.dataset.id;
            try {
                const logDocRef = doc(db, `artifacts/${appId}/public/data/growth_logs`, logId);
                const logDocSnap = await getDoc(logDocRef);

                if (!logDocSnap.exists()) {
                    showMessageModal('ì˜¤ë¥˜', 'ì„±ì¥ì¼ì§€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                await updateDoc(logDocRef, { status: 'approved' });
                showMessageModal('ìŠ¹ì¸ ì™„ë£Œ', 'ì„±ì¥ì¼ì§€ê°€ ìµœê³  ì ìˆ˜ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤. í•™ìƒì—ê²Œ ë³´ìƒì´ ì§€ê¸‰ë  ì˜ˆì •ì…ë‹ˆë‹¤!');
            } catch (error) {
                console.error("Growth log approval failed:", error);
                showMessageModal('ì˜¤ë¥˜', 'ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        /**
         * Handles teacher rejection of a growth log.
         * @param {Event} e - Click event.
         */
        async function handleGrowthLogRejection(e) {
            const logId = e.target.dataset.id;
            try {
                const logDocRef = doc(db, `artifacts/${appId}/public/data/growth_logs`, logId);
                const logDocSnap = await getDoc(logDocRef);

                if (!logDocSnap.exists()) {
                    showMessageModal('ì˜¤ë¥˜', 'ì„±ì¥ì¼ì§€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                await updateDoc(logDocRef, { status: 'rejected' });
                showMessageModal('í™•ì¸ ì™„ë£Œ', 'ì„±ì¥ì¼ì§€ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. í•™ìƒì—ê²Œ ë³´ìƒì´ ì§€ê¸‰ë  ì˜ˆì •ì…ë‹ˆë‹¤!');
            } catch (error) {
                console.error("Growth log rejection failed:", error);
                showMessageModal('ì˜¤ë¥˜', 'í™•ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        /**
         * Handles the stat increase button click.
         * @param {Event} event - The click event object.
         */
        async function handleStatIncrease(event) {
            const stat = event.target.dataset.stat;
            const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);
            const docSnap = await getDoc(studentDocRef);

            if (docSnap.exists()) {
                const studentData = docSnap.data();
                if (studentData.growth_points > 0) {
                    const newValue = (studentData[stat] || 0) + 1;
                    const newGrowthPoints = studentData.growth_points - 1;

                    await updateDoc(studentDocRef, {
                        [stat]: newValue,
                        growth_points: newGrowthPoints
                    });

                    showMessageModal('ëŠ¥ë ¥ì¹˜ ìƒìŠ¹', `${stat} ëŠ¥ë ¥ì¹˜ê°€ ${newValue} (ìœ¼)ë¡œ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤.`);
                    logEvent(userId, 'stat_increase', {
                        stat_name: stat,
                        new_value: newValue
                    });
                } else {
                    showMessageModal('í¬ì¸íŠ¸ ë¶€ì¡±', 'ì„±ì¥ í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                }
            }
        }

        /**
         * Approves or rejects a registration request.
         * @param {Event} event - The click event object.
         */
        async function handleApproveRequest(event) {
            const docId = event.target.dataset.id;
            const action = event.target.dataset.action;
            try {
                const registerDocRef = doc(db, `artifacts/${appId}/public/data/register`, docId);
                const registerDocSnap = await getDoc(registerDocRef);

                if (!registerDocSnap.exists()) {
                    showMessageModal('ì˜¤ë¥˜', 'ì‹ ì²­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                const studentData = registerDocSnap.data();

                if (action === 'approve') {
                    const studentsDocRef = doc(db, `artifacts/${appId}/public/data/students`, docId);
                    await setDoc(studentsDocRef, {
                        ...studentData,
                        ...initialStats,
                        approvedBy: userId,
                        createdAt: serverTimestamp()
                    });

                    await updateDoc(registerDocRef, {
                        status: 'ìŠ¹ì¸ë¨'
                    });

                    showMessageModal('ìŠ¹ì¸ ì™„ë£Œ', `${studentData.name} í•™ìƒì´ ì„±ê³µì ìœ¼ë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                } else if (action === 'reject') {
                    await deleteDoc(registerDocRef);
                    showMessageModal('ê±°ì ˆ ì™„ë£Œ', `${studentData.name} í•™ìƒì˜ ê°€ì…ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
            } catch (error) {
                console.error("Approval/Rejection failed:", error);
                showMessageModal('ì˜¤ë¥˜', 'í•™ìƒ ìŠ¹ì¸/ê±°ì ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        /**
         * Saves the updated stats to Firestore.
         */
        async function saveStats() {
            if (!userId) {
                showMessageModal('ì˜¤ë¥˜', 'ë¡œê·¸ì¸ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            try {
                const statElements = document.getElementById('stats-container').querySelectorAll('span');
                const updatedStats = {};
                statElements.forEach(el => {
                    const id = el.id;
                    if (id.includes('-display')) {
                        const statName = id.replace('-display', '');
                        updatedStats[statName] = parseInt(el.textContent, 10);
                    }
                });

                const growthPoints = parseInt(document.getElementById('growth-point-display').textContent, 10);
                const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);
                await updateDoc(studentDocRef, {
                    ...updatedStats,
                    growth_points: growthPoints
                });
                showMessageModal('ì €ì¥ ì™„ë£Œ', 'ëŠ¥ë ¥ì¹˜ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                logEvent(userId, 'stat_save', {
                    message: 'ëŠ¥ë ¥ì¹˜ ë³€ê²½ì‚¬í•­ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.'
                });
            } catch (error) {
                console.error("Failed to save stats:", error);
                showMessageModal('ì €ì¥ ì˜¤ë¥˜', 'ëŠ¥ë ¥ì¹˜ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        /**
         * Handles teacher code change.
         */
        async function handleTeacherCodeChange(e) {
            e.preventDefault();
            const newCode = newTeacherCodeInput.value.trim();

            if (!newCode || newCode.length < 4) {
                showMessageModal('ì˜¤ë¥˜', 'ìƒˆë¡œìš´ êµì‚¬ ì½”ë“œëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            try {
                const teacherDocRef = doc(db, `artifacts/${appId}/public/data/teachers`, 'teacher_password');
                await updateDoc(teacherDocRef, {
                    password: newCode
                });
                teacherCodeModalOverlay.classList.add('hidden');
                showMessageModal('ë³€ê²½ ì™„ë£Œ', 'êµì‚¬ ë¡œê·¸ì¸ ì½”ë“œê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error("Teacher code change failed:", error);
                showMessageModal('ì˜¤ë¥˜', 'êµì‚¬ ì½”ë“œ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // --- Event Listeners ---

        window.addEventListener('load', initFirebase);
        modalCloseBtn.addEventListener('click', () => {
            messageModalOverlay.classList.add('hidden');
        });

        // Landing view buttons
        showStudentLoginBtn.addEventListener('click', () => showView('studentLogin'));
        showRegisterBtn.addEventListener('click', () => showView('register'));
        showTeacherLoginBtn.addEventListener('click', () => showView('teacherLogin'));

        // Navigation buttons
        backToLandingFromLoginBtn.addEventListener('click', () => showView('landing'));
        backToLandingFromRegisterBtn.addEventListener('click', () => showView('landing'));
        backToLandingFromTeacherBtn.addEventListener('click', () => showView('landing'));

        // Student Tab buttons
        tabInfoBtn.addEventListener('click', () => {
            document.querySelectorAll('#dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            userInfoSection.classList.remove('hidden');
            document.querySelectorAll('#student-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            tabInfoBtn.classList.remove('border-transparent', 'text-gray-400');
            tabInfoBtn.classList.add('border-emerald-400', 'text-emerald-400');
        });
        tabQuestBtn.addEventListener('click', () => {
            document.querySelectorAll('#dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            questSection.classList.remove('hidden');
            document.querySelectorAll('#student-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            tabQuestBtn.classList.remove('border-transparent', 'text-gray-400');
            tabQuestBtn.classList.add('border-emerald-400', 'text-emerald-400');
            renderQuest(studentDataCache);
        });
        tabLogBtn.addEventListener('click', () => {
            document.querySelectorAll('#dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            logSection.classList.remove('hidden');
            document.querySelectorAll('#student-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            tabLogBtn.classList.remove('border-transparent', 'text-gray-400');
            tabLogBtn.classList.add('border-emerald-400', 'text-emerald-400');
            setupGrowthLogUIListener();
            renderGrowthLog();
        });
        tabShopBtn.addEventListener('click', () => {
            document.querySelectorAll('#dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            shopSection.classList.remove('hidden');
            document.querySelectorAll('#student-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            tabShopBtn.classList.remove('border-transparent', 'text-gray-400');
            tabShopBtn.classList.add('border-emerald-400', 'text-emerald-400');
        });

        // Teacher Tab buttons
        teacherTabPendingStudentsBtn.addEventListener('click', () => {
            document.querySelectorAll('#teacher-dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            teacherPendingStudentsSection.classList.remove('hidden');
            document.querySelectorAll('#teacher-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            teacherTabPendingStudentsBtn.classList.remove('border-transparent', 'text-gray-400');
            teacherTabPendingStudentsBtn.classList.add('border-emerald-400', 'text-emerald-400');
        });
        
        // 'ì„±ì¥ì¼ì§€ ê´€ë¦¬' íƒ­ ì „í™˜ ë¡œì§
        const teacherTabGrowthLogBtn = document.getElementById('teacherTabGrowthLogBtn');
        const growthLogManagementTab = document.getElementById('growth-log-management-tab');
        
        teacherTabGrowthLogBtn.addEventListener('click', () => {
            // ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('#teacher-dashboard-sections > div').forEach(div => div.classList.add('hidden'));
            
            // ì„±ì¥ì¼ì§€ íƒ­ ë³´ì´ê¸°
            growthLogManagementTab.classList.remove('hidden');
            
            // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelectorAll('#teacher-dashboard-view .border-b-2').forEach(btn => {
                btn.classList.remove('border-emerald-400', 'text-emerald-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            
            // í˜„ì¬ íƒ­ ë²„íŠ¼ í™œì„±í™”
            teacherTabGrowthLogBtn.classList.remove('border-transparent', 'text-gray-400');
            teacherTabGrowthLogBtn.classList.add('border-emerald-400', 'text-emerald-400');

            // í•™ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ í˜¸ì¶œ
            renderStudentList();
        });

        // Forms
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentIdInput = document.getElementById('student-id-input').value;
            const studentPasswordInput = document.getElementById('student-password-input').value;
            showView('loading');

            try {
                const studentDocRef = doc(db, `artifacts/${appId}/public/data/students`, studentIdInput);
                const docSnap = await getDoc(studentDocRef);

                // ì…ë ¥ëœ ë¹„ë°€ë²ˆí˜¸ë¥¼ í•´ì‹œí•˜ì—¬ Firestoreì— ì €ì¥ëœ í•´ì‹œê°’ê³¼ ë¹„êµ
                const hashedPassword = sha256(studentPasswordInput);

                if (docSnap.exists() && docSnap.data().password === hashedPassword) {
                    const userCredential = await signInAnonymously(auth);
                    const user = userCredential.user;

                    await setDoc(doc(db, `artifacts/${appId}/public/data/users`, user.uid), {
                        studentId: studentIdInput,
                        role: 'student'
                    });

                    userId = studentIdInput;
                    renderStudentDashboard();
                    logEvent(userId, 'student_login');
                } else {
                    showMessageModal('ë¡œê·¸ì¸ ì‹¤íŒ¨', 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    showView('studentLogin');
                }
            } catch (error) {
                console.error("Student login failed:", error);
                showMessageModal('ë¡œê·¸ì¸ ì‹¤íŒ¨', 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                showView('studentLogin');
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('register-id').value;
            const password = document.getElementById('register-password').value;
            const name = document.getElementById('register-name').value;
            const grade = parseInt(document.getElementById('register-grade').value);
            const studentClass = parseInt(document.getElementById('register-class').value);
            const number = parseInt(document.getElementById('register-number').value);
            const charName = document.getElementById('register-char-name').value;

            if (password.length < 4) {
                showMessageModal('íšŒì›ê°€ì… ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            try {
                showView('loading');
                const registerRef = collection(db, `artifacts/${appId}/public/data/register`);
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                const qRegister = query(registerRef, where("id", "==", id));
                const qStudents = query(studentsRef, where("id", "==", id));

                const registerSnapshot = await getDocs(qRegister);
                const studentsSnapshot = await getDocs(qStudents);

                if (!registerSnapshot.empty || !studentsSnapshot.empty) {
                    showMessageModal('íšŒì›ê°€ì… ì˜¤ë¥˜', 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì•„ì´ë””ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                    showView('register');
                    return;
                }

                // ë¹„ë°€ë²ˆí˜¸ë¥¼ SHA-256ìœ¼ë¡œ í•´ì‹œí•˜ì—¬ ë³´ì•ˆ ê°•í™”
                const hashedPassword = sha256(password);
                
                await setDoc(doc(db, `artifacts/${appId}/public/data/register`, id), {
                    id: id,
                    password: hashedPassword,
                    name: name,
                    grade: grade,
                    class: studentClass,
                    number: number,
                    character_name: charName,
                    status: 'ëŒ€ê¸°ì¤‘',
                    quests: {},
                    createdAt: serverTimestamp()
                });

                showMessageModal('ê°€ì… ì‹ ì²­ ì™„ë£Œ', 'ê°€ì… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. êµì‚¬ì˜ ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”!');
                showView('landing');
            } catch (error) {
                console.error("Registration failed:", error);
                showMessageModal('íšŒì›ê°€ì… ì˜¤ë¥˜', 'íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                showView('register');
            }
        });

        teacherLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const teacherCode = document.getElementById('teacher-code-input').value;
            const teacherDocRef = doc(db, `artifacts/${appId}/public/data/teachers`, 'teacher_password');
            const docSnap = await getDoc(teacherDocRef);

            if (docSnap.exists() && docSnap.data().password === teacherCode) {
                renderTeacherDashboard();
            } else {
                showMessageModal('ë¡œê·¸ì¸ ì‹¤íŒ¨', 'êµì‚¬ ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                showView('teacherLogin');
            }
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut();
            showView('landing');
            userId = null;
            studentDataCache = null;
        });

        teacherLogoutBtn.addEventListener('click', () => {
            auth.signOut();
            showView('landing');
        });
        
        // Teacher code change modal buttons
        changeTeacherCodeBtn.addEventListener('click', () => {
            teacherCodeModalOverlay.classList.remove('hidden');
        });
        cancelTeacherCodeChangeBtn.addEventListener('click', () => {
            teacherCodeModalOverlay.classList.add('hidden');
        });
        teacherCodeChangeForm.addEventListener('submit', handleTeacherCodeChange);

        // Student Dashboard Actions
        saveStatsBtn.addEventListener('click', saveStats);
        document.getElementById('growth-log-form').addEventListener('submit', handleGrowthLogSubmission);

// íƒ­ ìš”ì†Œ ì„ íƒ
        const unverifiedLogsTabBtn = document.getElementById('unverified-logs-tab-btn');
        const allLogsTabBtn = document.getElementById('all-logs-tab-btn');
        const unverifiedLogsSection = document.getElementById('unverified-logs-section');
        const allLogsSection = document.getElementById('all-logs-section');
        const unverifiedLogList = document.getElementById('unverified-log-list');
        
        // ê¸°ì¡´ ì„±ì¥ì¼ì§€ ê´€ë¦¬ ë³€ìˆ˜ ì¬ì •ì˜
        const studentListContainer = document.getElementById('student-list');
        const growthLogContainer = document.getElementById('growth-log-container');
        const selectedStudentName = document.getElementById('selected-student-name');
        const growthLogList = document.getElementById('growth-log-list');
        
        // ë¯¸í™•ì¸ ì„±ì¥ì¼ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ë° ë Œë”ë§
async function renderUnverifiedLogs() {
            try {
                unverifiedLogList.innerHTML = '<p class="text-gray-400">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
                const logsRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);
                
                // ì¿¼ë¦¬ ìˆ˜ì •: rewarded ëŒ€ì‹  status í•„ë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                const q = query(logsRef, where("status", "==", "pending"), orderBy("createdAt", "desc"));
                
                const querySnapshot = await getDocs(q);
        
                unverifiedLogList.innerHTML = '';
                if (querySnapshot.empty) {
                    unverifiedLogList.innerHTML = '<p class="text-gray-400">ë¯¸í™•ì¸ëœ ì„±ì¥ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    querySnapshot.forEach(doc => {
                        const logData = doc.data();
                        const logDate = logData.createdAt ? logData.createdAt.toDate().toLocaleDateString('ko-KR') : 'ë‚ ì§œ ì—†ìŒ';
                        const logElement = document.createElement('div');
                        logElement.classList.add('bg-gray-900', 'p-4', 'rounded-lg', 'shadow-inner', 'mb-2', 'relative');
                        logElement.innerHTML = `
                            <p class="text-sm text-gray-400 mb-1">ë‚ ì§œ: ${logDate}</p>
                            <p class="text-white mb-2">${logData.content}</p>
                            <div class="mt-4 flex gap-2">
                                <button class="btn-primary text-sm px-3 py-1 rounded-full approve-btn" data-log-id="${doc.id}">ìµœê³ </button>
                                <button class="btn-secondary text-sm px-3 py-1 rounded-full check-btn" data-log-id="${doc.id}">í™•ì¸</button>
                            </div>
                        `;
                        unverifiedLogList.appendChild(logElement);
                    });
                }
            } catch (error) {
                console.error("ë¯¸í™•ì¸ ì„±ì¥ì¼ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
                showMessageModal('ì˜¤ë¥˜', 'ë¯¸í™•ì¸ ì„±ì¥ì¼ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì „ì²´ ì„±ì¥ì¼ì§€ (í•™ìƒ ëª©ë¡) ë¶ˆëŸ¬ì˜¤ê¸°
        async function renderStudentList() {
            try {
                const studentsRef = collection(db, `artifacts/${appId}/public/data/students`);
                const q = query(studentsRef, orderBy("number", "asc"));
                const querySnapshot = await getDocs(q);
        
                studentListContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    studentListContainer.innerHTML = '<p class="text-gray-400">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    querySnapshot.forEach(doc => {
                        const studentData = doc.data();
                        const studentButton = document.createElement('button');
                        studentButton.textContent = `${studentData.name} (${studentData.id})`;
                        studentButton.classList.add('bg-gray-600', 'hover:bg-gray-500', 'text-white', 'py-2', 'px-4', 'rounded-full', 'transition-colors');
                        studentButton.setAttribute('data-student-id', studentData.id);
                        studentListContainer.appendChild(studentButton);
                    });
                }
            } catch (error) {
                console.error("í•™ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
                showMessageModal('ì˜¤ë¥˜', 'í•™ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // íŠ¹ì • í•™ìƒì˜ ì„±ì¥ì¼ì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (í‰ê°€ ë²„íŠ¼ ì¡°ê±´ë¶€ í‘œì‹œ)
        async function renderGrowthLogsWithEvaluation(studentId, studentName) {
            try {
                const growthLogsRef = collection(db, `artifacts/${appId}/public/data/growth_logs`);
                const q = query(growthLogsRef, where("studentId", "==", studentId), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
        
                selectedStudentName.textContent = `${studentName} í•™ìƒì˜ ì„±ì¥ì¼ì§€`;
                growthLogList.innerHTML = '';
                growthLogContainer.classList.remove('hidden');
        
                if (querySnapshot.empty) {
                    growthLogList.innerHTML = '<p class="text-gray-400">ì œì¶œëœ ì„±ì¥ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    querySnapshot.forEach(doc => {
                        const logData = doc.data();
                        const logDate = logData.createdAt ? logData.createdAt.toDate().toLocaleDateString('ko-KR') : 'ë‚ ì§œ ì—†ìŒ';
                        const logElement = document.createElement('div');
                        logElement.classList.add('bg-gray-900', 'p-4', 'rounded-lg', 'shadow-inner', 'mb-2', 'relative');
                        
                        let evaluationButtonsHTML = '';
                        if (!logData.evaluation) { // ë¯¸í‰ê°€ ìƒíƒœì¼ ë•Œë§Œ ë²„íŠ¼ ì¶”ê°€
                            evaluationButtonsHTML = `
                                <div class="mt-4 flex gap-2">
                                    <button class="btn-primary text-sm px-3 py-1 rounded-full approve-btn" data-log-id="${doc.id}">ìµœê³ </button>
                                    <button class="btn-secondary text-sm px-3 py-1 rounded-full check-btn" data-log-id="${doc.id}">í™•ì¸</button>
                                </div>
                            `;
                        }
        
                        logElement.innerHTML = `
                            <p class="text-sm text-gray-400 mb-1">ë‚ ì§œ: ${logDate}</p>
                            <p class="text-white mb-2">${logData.content}</p>
                            <div class="mt-2">
                                <span class="text-sm text-gray-500 mr-2">í‰ê°€ ìƒíƒœ: </span>
                                <span class="text-sm font-bold">${logData.evaluation ? logData.evaluation : 'ë¯¸í‰ê°€'}</span>
                            </div>
                            ${evaluationButtonsHTML}
                        `;
                        growthLogList.appendChild(logElement);
                    });
                }
            } catch (error) {
                console.error("ì„±ì¥ì¼ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
                showMessageModal('ì˜¤ë¥˜', 'ì„±ì¥ì¼ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // íƒ­ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        unverifiedLogsTabBtn.addEventListener('click', () => {
            unverifiedLogsSection.classList.remove('hidden');
            allLogsSection.classList.add('hidden');
            unverifiedLogsTabBtn.classList.add('border-green-400', 'text-green-400');
            allLogsTabBtn.classList.remove('border-green-400', 'text-green-400');
            renderUnverifiedLogs();
        });
        
        allLogsTabBtn.addEventListener('click', () => {
            allLogsSection.classList.remove('hidden');
            unverifiedLogsSection.classList.add('hidden');
            allLogsTabBtn.classList.add('border-green-400', 'text-green-400');
            unverifiedLogsTabBtn.classList.remove('border-green-400', 'text-green-400');
            renderStudentList();
        });
        
        // í•™ìƒ ëª©ë¡ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        studentListContainer.addEventListener('click', async (e) => {
            const studentButton = e.target.closest('button');
            if (studentButton) {
                const studentId = studentButton.getAttribute('data-student-id');
                const studentName = studentButton.textContent.split('(')[0].trim();
                await renderGrowthLogsWithEvaluation(studentId, studentName);
            }
        });
        
        // í‰ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ë¯¸í™•ì¸ íƒ­ê³¼ ì „ì²´ íƒ­ì—ì„œ ëª¨ë‘ ì‚¬ìš© ê°€ëŠ¥)
        document.addEventListener('click', async (e) => {
            const approveBtn = e.target.closest('.approve-btn');
            const checkBtn = e.target.closest('.check-btn');
            
            if (approveBtn || checkBtn) {
                const logId = (approveBtn || checkBtn).getAttribute('data-log-id');
                const evaluation = approveBtn ? 'ìµœê³ ' : 'í™•ì¸';
                
                try {
                    const logRef = doc(db, `artifacts/${appId}/public/data/growth_logs`, logId);
                    await updateDoc(logRef, {
                        evaluation: evaluation
                    });
                    showMessageModal('í‰ê°€ ì™„ë£Œ', `ì„±ì¥ì¼ì§€ê°€ '${evaluation}'ìœ¼ë¡œ í‰ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    // í‰ê°€ í›„ ë¯¸í™•ì¸ íƒ­ê³¼ ì „ì²´ íƒ­ì„ ë‹¤ì‹œ ë Œë”ë§
                    renderUnverifiedLogs();
                    if (!allLogsSection.classList.contains('hidden')) {
                        const studentId = e.target.closest('[data-student-id]')?.getAttribute('data-student-id');
                        const studentName = e.target.closest('[data-student-id]')?.textContent.split('(')[0].trim();
                        if(studentId && studentName) {
                            renderGrowthLogsWithEvaluation(studentId, studentName);
                        }
                    }
                } catch (error) {
                    console.error("í‰ê°€ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
                    showMessageModal('ì˜¤ë¥˜', 'ì„±ì¥ì¼ì§€ í‰ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        });
        
        // ì´ˆê¸° ë¡œë”© ì‹œ ë¯¸í™•ì¸ ì„±ì¥ì¼ì§€ íƒ­ í™œì„±í™”
        unverifiedLogsTabBtn.click();

        // ì„±ì¥ì¼ì§€ ê´€ë¦¬ íƒ­ ì§„ì… ì‹œ í•™ìƒ ëª©ë¡ ë Œë”ë§
        // (íƒ­ ì „í™˜ ë¡œì§ì— ì´ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ì½”ë“œë¥¼ ì¶”ê°€í•´ì•¼ í•¨)
        // ì˜ˆ: showView('teacherDashboard', 'growth-log-management-tab');
        document.addEventListener('DOMContentLoaded', renderStudentList);
    </script>
</body>

</html>
